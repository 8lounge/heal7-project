# ğŸ—ï¸ HEAL7 ë°ì´í„°ë² ì´ìŠ¤ ì¬êµ¬ì„± í›„ ë°±ì—”ë“œ ì—°ë™ ì¬ì„¤ì • ë§ˆìŠ¤í„° í”Œëœ

> **ì‘ì„±ì¼**: 2025-08-29  
> **ìƒíƒœ**: ê¸°íš ì™„ë£Œ, ì‹¤í–‰ ëŒ€ê¸°  
> **ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 3-4ì‹œê°„  
> **ìœ„í—˜ë„**: ì¤‘ê°„ (ë°±ì—… ì™„ë£Œ)

---

## ğŸ“‹ **í˜„ì¬ ìƒí™© ë¶„ì„**

### ğŸ”´ **ì£¼ìš” ë³€ê²½ì‚¬í•­**
1. **heal7_saju** â†’ **heal7.saju_service** ì´ê´€ ì™„ë£Œ
2. **public ìŠ¤í‚¤ë§ˆ í˜¼ì¬** â†’ **7ê°œ ì„œë¹„ìŠ¤ë³„ ìŠ¤í‚¤ë§ˆ** ë¶„ë¦¬
3. **ìƒˆë¡œìš´ ê³ ê¸‰ ìŠ¤í‚¤ë§ˆ** ì ìš© (240ì¤„ ì‚¬ì£¼ + 450ì¤„ ê¿ˆí’€ì´)
4. **Redis ë„¤ì„ìŠ¤í˜ì´ìŠ¤** ì¬êµ¬ì„± (DB 0-6)

### ğŸ” **ì˜í–¥ë„ ë¶„ì„ ê²°ê³¼**

#### **High Impact (ê¸´ê¸‰ ìˆ˜ì • í•„ìš”)**
- **ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •**: `psycopg2`, `asyncpg` ì‚¬ìš© ëª¨ë“ˆ (10ê°œ íŒŒì¼)
- **SQL ì¿¼ë¦¬ ê²½ë¡œ**: `public.` â†’ `ìŠ¤í‚¤ë§ˆëª….` ë³€ê²½ í•„ìš”
- **ORM/ì¿¼ë¦¬ ë¹Œë”**: ìŠ¤í‚¤ë§ˆ ì ‘ë‘ì‚¬ ì¶”ê°€ í•„ìš”

#### **Medium Impact (ì ì§„ì  ìˆ˜ì •)**
- **ìºì‹œ í‚¤ êµ¬ì¡°**: Redis ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë³€ê²½
- **ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸**: ê¸°ì¡´ ìŠ¤í‚¤ë§ˆ ì°¸ì¡° ìˆ˜ì •
- **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: Mock ë°ì´í„° ê²½ë¡œ ì—…ë°ì´íŠ¸

#### **Low Impact (ì¶”í›„ ìµœì í™”)**
- **ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§**: ìŠ¤í‚¤ë§ˆ ì •ë³´ í¬í•¨
- **ë¬¸ì„œí™”**: API ìŠ¤í‚¤ë§ˆ ì°¸ì¡° ì—…ë°ì´íŠ¸

---

## ğŸ¯ **ë°±ì—”ë“œ ì—°ë™ ì¬ì„¤ì • ê¸°íš**

### **Phase 1: ì¦‰ì‹œ ìˆ˜ì • (ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ìœ„í—˜ ë°©ì§€)**

#### **1.1 ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì • ìˆ˜ì •**
```python
# ê¸°ì¡´ (ë¬¸ì œ)
DATABASE_URL = "postgresql://user:pass@localhost/heal7_saju"

# ì‹ ê·œ (í•´ê²°)
DATABASE_URL = "postgresql://user:pass@localhost/heal7"
DEFAULT_SCHEMA = "saju_service"  # ì„œë¹„ìŠ¤ë³„ ì„¤ì •
```

#### **1.2 í…Œì´ë¸” ì°¸ì¡° ê²½ë¡œ ìˆ˜ì •**
```sql
-- ê¸°ì¡´ (ë¬¸ì œ)
SELECT * FROM users;
SELECT * FROM kasi_cache;

-- ì‹ ê·œ (í•´ê²°) 
SELECT * FROM shared_common.users;
SELECT * FROM saju_service.kasi_cache;
```

### **Phase 2: ì ì§„ì  ê°œì„  (ê¸°ëŠ¥ í–¥ìƒ)**

#### **2.1 ìŠ¤í‚¤ë§ˆë³„ ì—°ê²° ê´€ë¦¬ì êµ¬í˜„**
```python
class SchemaAwareDBManager:
    def __init__(self):
        self.schema_mapping = {
            'users': 'shared_common',
            'saju_charts': 'saju_service', 
            'dream_interpretations': 'dream_service',
            # ... ì „ì²´ ë§¤í•‘
        }
    
    def get_table_with_schema(self, table_name: str) -> str:
        schema = self.schema_mapping.get(table_name, 'public')
        return f"{schema}.{table_name}"
```

#### **2.2 Redis ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¬ì„¤ì •**
```python
# ê¸°ì¡´
redis.set("saju:cache:key", data)

# ì‹ ê·œ
redis.set("saju_service:cache:key", data)  # DB 1
redis.set("shared_common:session:key", data)  # DB 0
```

### **Phase 3: ìµœì í™” ë° í™•ì¥**

#### **3.1 ë™ì  ìŠ¤í‚¤ë§ˆ ë¼ìš°íŒ…**
- ì„œë¹„ìŠ¤ë³„ ìë™ ìŠ¤í‚¤ë§ˆ ì„ íƒ
- ì¿¼ë¦¬ ì„±ëŠ¥ ìµœì í™” ì ìš©
- ì¥ì•  ë³µêµ¬ ë§¤ì»¤ë‹ˆì¦˜ êµ¬í˜„

#### **3.2 íë¸Œë³„ ë…ë¦½ ì—°ê²° í’€**
- ì„œë¹„ìŠ¤ë³„ ë…ë¦½ì ì¸ DB ì—°ê²°
- ë¶€í•˜ ë¶„ì‚° ë° ê²©ë¦¬
- ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì²´ê³„

---

## ğŸ› ï¸ **êµ¬ì²´ì  ì‹¤í–‰ ê³„íš**

### **Step 1: ì¤‘ìš” ì„œë¹„ìŠ¤ ë¨¼ì € ìˆ˜ì • (30ë¶„)**
1. **ì‚¬ì£¼ ì„œë¹„ìŠ¤** (í¬íŠ¸ 8003)
   - `/app/core/engines/saju_system/saju_data_manager.py`
   - í…Œì´ë¸” ê²½ë¡œ: `saju_service.*`
   
2. **ê´€ë¦¬ì ì„œë¹„ìŠ¤** (í¬íŠ¸ 8006)  
   - `/services/dashboard-service/api-gateway-cube/modules/user_management.py`
   - í…Œì´ë¸” ê²½ë¡œ: `shared_common.users`

### **Step 2: ì„¤ì • íŒŒì¼ í†µí•© ì—…ë°ì´íŠ¸ (20ë¶„)**
```yaml
# config/database.yaml
databases:
  heal7:
    host: localhost
    port: 5432
    database: heal7
    schemas:
      shared_common: {tables: [users, attachments]}
      saju_service: {tables: [saju_charts, kasi_cache]}
      dream_service: {tables: [dream_categories]}
      # ... ì „ì²´ ë§¤í•‘
```

### **Step 3: ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ (30ë¶„)**
```python
# í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
async def test_all_schema_connections():
    for schema in ['shared_common', 'saju_service', 'dream_service']:
        try:
            result = await db.fetch(f"SELECT 1 FROM {schema}.* LIMIT 1")
            print(f"âœ… {schema}: OK")
        except Exception as e:
            print(f"âŒ {schema}: {e}")
```

### **Step 4: ë‹¨ê³„ì  ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (60ë¶„)**
1. **ì‚¬ì£¼ ì„œë¹„ìŠ¤ ì¬ì‹œì‘** â†’ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
2. **ê´€ë¦¬ì ì„œë¹„ìŠ¤ ì¬ì‹œì‘** â†’ ì‚¬ìš©ì ê´€ë¦¬ í…ŒìŠ¤íŠ¸  
3. **í¬ë¡¤ë§ ì„œë¹„ìŠ¤ ì¬ì‹œì‘** â†’ ë°ì´í„° ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸
4. **ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸**

---

## ğŸš¨ **ë¦¬ìŠ¤í¬ ê´€ë¦¬**

### **ë¡¤ë°± ê³„íš**
```bash
# ê¸´ê¸‰ ë¡¤ë°± ì‹œ 
sudo -u postgres psql heal7 < /home/ubuntu/heal7-project/backend/database-migration/backups/heal7_backup_20250829_140418.sql
```

### **ë¶€ë¶„ ì¥ì•  ëŒ€ì‘**
- **ì„œë¹„ìŠ¤ë³„ ë…ë¦½ ì‹¤í–‰**: í•œ ìŠ¤í‚¤ë§ˆ ë¬¸ì œê°€ ì „ì²´ì— ì˜í–¥ ì•ˆ ì¤Œ
- **Graceful Degradation**: Mock ë°ì´í„°ë¡œ ì¼ì‹œ ëŒ€ì²´
- **ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§**: ê° ìŠ¤í‚¤ë§ˆë³„ ìƒíƒœ ì²´í¬

### **ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥**
- **Foreign Key ì œì•½**: ìŠ¤í‚¤ë§ˆ ê°„ ì°¸ì¡° ê´€ê³„ ìœ ì§€
- **íŠ¸ëœì­ì…˜ ê²½ê³„**: ë‹¤ì¤‘ ìŠ¤í‚¤ë§ˆ ì‘ì—… ì‹œ ì›ìì„± ë³´ì¥
- **ë°±ì—… ìë™í™”**: ë§¤ì¼ ìŠ¤í‚¤ë§ˆë³„ ë°±ì—…

---

## ğŸ“Š **ì„±ê³µ ì§€í‘œ**

### **ê¸°ìˆ ì  ì§€í‘œ**
- âœ… **ëª¨ë“  ì„œë¹„ìŠ¤ ì •ìƒ ê¸°ë™** (8003, 8006 í¬íŠ¸)
- âœ… **API ì‘ë‹µ ì‹œê°„** < 2ì´ˆ ìœ ì§€
- âœ… **ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜** 0ê±´
- âœ… **ìŠ¤í‚¤ë§ˆë³„ ì¿¼ë¦¬ ì„±ê³µë¥ ** 99% ì´ìƒ

### **ë¹„ì¦ˆë‹ˆìŠ¤ ì§€í‘œ**
- âœ… **ì‚¬ì£¼ ê³„ì‚° ê¸°ëŠ¥** ì •ìƒ ì‘ë™
- âœ… **ì‚¬ìš©ì ë¡œê·¸ì¸/ê´€ë¦¬** ì •ìƒ ì‘ë™  
- âœ… **ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ** ì ‘ê·¼ ê°€ëŠ¥
- âœ… **ë°ì´í„° ìˆ˜ì§‘/í¬ë¡¤ë§** ì§€ì† ì‹¤í–‰

---

## ğŸ‰ **ê¸°ëŒ€ íš¨ê³¼**

### **ì¦‰ì‹œ íš¨ê³¼**
- **ì²´ê³„ì ì¸ ë°ì´í„° ê´€ë¦¬**: ì„œë¹„ìŠ¤ë³„ ëª…í™•í•œ ë¶„ë¦¬
- **í™•ì¥ì„± í–¥ìƒ**: ìƒˆ ì„œë¹„ìŠ¤ ì¶”ê°€ ìš©ì´
- **ìœ ì§€ë³´ìˆ˜ íš¨ìœ¨ì„±**: ìŠ¤í‚¤ë§ˆë³„ ë…ë¦½ì  ê´€ë¦¬

### **ì¥ê¸° íš¨ê³¼**  
- **ì„±ëŠ¥ ìµœì í™”**: ìŠ¤í‚¤ë§ˆë³„ ì¸ë±ìŠ¤ ì „ëµ
- **ë³´ì•ˆ ê°•í™”**: ìŠ¤í‚¤ë§ˆë³„ ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬
- **ëª¨ë‹ˆí„°ë§ ê³ ë„í™”**: ì„œë¹„ìŠ¤ë³„ ìƒì„¸ ì¶”ì 

---

**ğŸš€ ì¤€ë¹„ ì™„ë£Œ! ì‹¤í–‰ ëª…ë ¹ ëŒ€ê¸° ì¤‘**