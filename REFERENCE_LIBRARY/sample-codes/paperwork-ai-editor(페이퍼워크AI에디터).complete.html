<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë¬¸ì„œ í¸ì§‘ê¸° | Paperwork Editor</title>
    <link rel="stylesheet" href="./css/output.css">
    
    <!-- ğŸ¨ Enhanced UI/UX Design System -->
    <style>
        /* Modern Glassmorphism & Design System */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glassmorphism-strong {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        /* Unified Card System */
        .card-primary {
            @apply glassmorphism rounded-2xl p-6 transition-all duration-300 hover:shadow-2xl hover:scale-[1.01];
            background: rgba(255, 255, 255, 0.1);
        }
        
        .card-secondary {
            @apply bg-white/5 rounded-xl p-4 border border-white/10 transition-all duration-200 hover:bg-white/10;
        }
        
        /* Enhanced Step Sections */
        .step-section {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .step-section:hover {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
        }
        
        .step-section.minimized {
            max-height: 64px;
            overflow: hidden;
            position: sticky;
            top: 0;
            z-index: 40;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Modern Button System */
        .btn-primary {
            @apply bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl;
        }
        
        .btn-secondary {
            @apply bg-white/10 hover:bg-white/20 text-white py-3 px-6 rounded-xl font-medium transition-all duration-300 border border-white/20 hover:border-white/40;
        }
        
        .btn-outline {
            @apply border-2 border-white/30 hover:border-white/60 text-white hover:bg-white/10 py-2.5 px-5 rounded-lg font-medium transition-all duration-300;
        }
        
        /* Enhanced Typography */
        .text-heading {
            @apply text-white font-bold tracking-tight;
        }
        
        .text-subheading {
            @apply text-white/90 font-semibold;
        }
        
        .text-body {
            @apply text-white/80 font-medium;
        }
        
        .text-caption {
            @apply text-white/60 text-sm;
        }
        
        /* Unified Spacing System */
        .section-spacing {
            @apply space-y-6;
        }
        
        .content-spacing {
            @apply space-y-4;
        }
        
        .item-spacing {
            @apply space-y-3;
        }
        
        /* Enhanced Input System */
        .input-field {
            @apply bg-white/10 border border-white/20 rounded-lg px-4 py-2.5 text-white placeholder-white/50 focus:border-blue-400 focus:ring-2 focus:ring-blue-400/30 transition-all duration-300;
        }
        
        /* Progress & Status Indicators */
        .status-indicator {
            @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium;
        }
        
        .status-success {
            @apply bg-green-500/20 text-green-300 border border-green-500/30;
        }
        
        .status-warning {
            @apply bg-yellow-500/20 text-yellow-300 border border-yellow-500/30;
        }
        
        .status-error {
            @apply bg-red-500/20 text-red-300 border border-red-500/30;
        }
        
        .status-info {
            @apply bg-blue-500/20 text-blue-300 border border-blue-500/30;
        }
        
        /* Enhanced Animations */
        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeInScale {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .animate-slide-in-up {
            animation: slideInUp 0.4s ease-out forwards;
        }
        
        .animate-fade-in-scale {
            animation: fadeInScale 0.3s ease-out forwards;
        }
        
        /* Enhanced Grid & Layout */
        .layout-grid {
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr;
        }
        
        @media (min-width: 1024px) {
            .layout-grid {
                grid-template-columns: 320px 1fr;
                gap: 3rem;
            }
        }
        
        /* Quill Editor Enhancements */
        .ql-toolbar {
            border: none !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #f8fafc !important;
            border-radius: 0.75rem 0.75rem 0 0 !important;
            padding: 1rem !important;
        }
        
        .ql-container {
            border: none !important;
            font-family: 'Inter', 'Noto Sans KR', system-ui, sans-serif !important;
            font-size: 16px !important;
            line-height: 1.7 !important;
        }
        
        .ql-editor {
            padding: 1.5rem !important;
            min-height: 500px !important;
            color: #1f2937 !important;
        }
        
        /* Enhanced Icons & Visual Elements */
        .icon-container {
            @apply w-12 h-12 rounded-xl flex items-center justify-center text-2xl;
        }
        
        .icon-primary {
            @apply bg-blue-500/20 text-blue-300;
        }
        
        .icon-success {
            @apply bg-green-500/20 text-green-300;
        }
        
        .icon-warning {
            @apply bg-yellow-500/20 text-yellow-300;
        }
        
        /* Enhanced Shadows & Depth */
        .shadow-depth-1 {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .shadow-depth-2 {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }
        
        .shadow-depth-3 {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        
        .shadow-depth-4 {
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.2);
        }
    </style>
    
    <!-- ğŸ”§ Quill.js í¸ì§‘ê¸° -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <!-- ğŸ“„ PDF.js for page count validation (PDF í˜ì´ì§€ ìˆ˜ ê²€ì¦ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', system-ui, -apple-system, sans-serif; }
        
        .glassmorphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* ë°•ìŠ¤ ìµœì†Œí™” ì• ë‹ˆë©”ì´ì…˜ */
        .step-section {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top;
        }
        
        .step-section.minimized {
            max-height: 60px;
            overflow: hidden;
            position: sticky;
            top: 0;
            z-index: 40;
            backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .step-section.minimized .step-content {
            opacity: 0;
            pointer-events: none;
        }
        
        .step-section.minimized .step-header {
            padding: 0.75rem 1.5rem;
            margin: 0;
        }
        
        .step-section.minimized .step-header h3 {
            font-size: 0.875rem;
            margin-bottom: 0;
        }
        
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        /* Quill í¸ì§‘ê¸° ì»¤ìŠ¤í„°ë§ˆì´ì§• */
        .ql-editor {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #1f2937;
        }
        
        .ql-toolbar {
            border-top: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .ql-container {
            border-bottom: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            background: white;
        }
        
        .step-indicator {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300;
        }
        
        .step-indicator.active {
            @apply bg-blue-500 text-white shadow-lg;
        }
        
        .step-indicator.completed {
            @apply bg-green-500 text-white;
        }
        
        .step-indicator.pending {
            @apply bg-white/20 text-white/60;
        }
        
        .step-indicator.locked {
            @apply bg-gray-500/20 text-gray-400/60 cursor-not-allowed;
        }
        
        .ai-tool-card {
            @apply glassmorphism rounded-xl p-4 hover:bg-white/30 transition-all duration-300 cursor-pointer border-2 border-transparent hover:border-blue-300/50;
        }
        
        .ai-tool-card.active {
            @apply border-blue-500 bg-blue-50/80;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900">
    <!-- Toast Notification System -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- ì¶”ì¶œ ìŠ¹ì¸ ë ˆì´ì–´ íŒì—… (Extraction Approval Modal) -->
    <div id="extractionApprovalModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 rounded-3xl p-8 max-w-2xl mx-4 glassmorphism border border-white/20">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ğŸ“„</div>
                <h2 class="text-2xl font-bold text-white mb-2">ë¬¸ì„œ ì¶”ì¶œ ìŠ¹ì¸</h2>
                <p class="text-white/70">ë‹¤ìŒ ì„¤ì •ìœ¼ë¡œ ë¬¸ì„œë¥¼ ì¶”ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            </div>
            
            <div class="space-y-4 mb-8">
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">ë¬¸ì„œëª…:</span>
                        <span id="extractionDocName" class="text-white font-medium"></span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">AI ëª¨ë¸:</span>
                        <span id="extractionAIModel" class="text-white font-medium"></span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">ì¶”ì¶œ ë°©ì‹:</span>
                        <span id="extractionType" class="text-white font-medium"></span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„:</span>
                        <span class="text-yellow-300 font-medium">ì•½ 30-60ì´ˆ</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="cancelExtraction()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="ì¶”ì¶œ ì‘ì—… ì·¨ì†Œ">
                    ì·¨ì†Œ
                </button>
                <button onclick="confirmExtraction()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹œì‘">
                    ì¶”ì¶œ ì‹œì‘
                </button>
            </div>
        </div>
    </div>

    <!-- AI Auto-fill ìŠ¹ì¸ ëª¨ë‹¬ (AI Auto-fill Consent Modal) -->
    <div id="aiAutoFillModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 rounded-3xl p-8 max-w-2xl mx-4 glassmorphism border border-white/20">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ğŸ¤–</div>
                <h2 class="text-2xl font-bold text-white mb-2">AI ìë™ ì±„ìš°ê¸°</h2>
                <p class="text-white/70">ë¹ˆ í•­ëª©ë“¤ì„ AIê°€ ìë™ìœ¼ë¡œ ì¶”ë¡ í•´ì„œ ì±„ì›Œë“œë¦¬ê² ìŠµë‹ˆê¹Œ?</p>
            </div>
            
            <div class="space-y-4 mb-8">
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">ê°ì§€ëœ ë¹ˆ í•„ë“œ:</span>
                        <span id="blankFieldsCount" class="text-yellow-300 font-medium">0ê°œ</span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">ì°¸ê³ ìë£Œ:</span>
                        <span id="referenceStatus" class="text-white font-medium">ì—†ìŒ</span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">ì¶”ë¡  ëª¨ë“œ:</span>
                        <span id="inferenceMode" class="text-blue-300 font-medium">í‘œì¤€</span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„:</span>
                        <span class="text-yellow-300 font-medium">ì•½ 1-2ë¶„</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="cancelAutoFill()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="AI ìë™ ì±„ìš°ê¸° ì·¨ì†Œ">
                    ì·¨ì†Œ
                </button>
                <button onclick="startAutoFillStandard()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="AI ìë™ ì±„ìš°ê¸° í‘œì¤€ ëª¨ë“œ ì‹œì‘">
                    í‘œì¤€ ëª¨ë“œ
                </button>
                <button onclick="startAutoFillDeep()" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="AI ìë™ ì±„ìš°ê¸° ê³ ê¸‰ ëª¨ë“œ ì‹œì‘">
                    Think Harder ğŸ§ 
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced File Upload Loading Modal (ê°œì„ ëœ íŒŒì¼ ì—…ë¡œë“œ ë¡œë”© ëª¨ë‹¬) -->
    <div id="upload-loading" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="glassmorphism bg-white/10 rounded-2xl p-8 text-center max-w-lg">
            <!-- ë™ì  ì•„ì´ì½˜ (Dynamic Icon) -->
            <div class="relative mb-6">
                <div id="loading-icon" class="w-16 h-16 mx-auto">
                    <div class="animate-spin w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                </div>
                <!-- ë‹¨ê³„ë³„ ì•„ì´ì½˜ í‘œì‹œ -->
                <div id="step-icon" class="absolute inset-0 flex items-center justify-center text-3xl opacity-0 transition-opacity duration-500">
                    ğŸ“„
                </div>
            </div>
            
            <!-- ë©”ì¸ ìƒíƒœ ë©”ì‹œì§€ (Main Status Message) -->
            <h3 id="loading-title" class="text-2xl font-semibold text-white mb-3">ë¬¸ì„œ ì²˜ë¦¬ ì¤‘</h3>
            <p id="upload-status" class="text-white/70 mb-4">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë¶„ì„í•˜ëŠ” ì¤‘...</p>
            
            <!-- ì§„í–‰ë¥  ë°” (Progress Bar) -->
            <div class="w-full bg-white/20 rounded-full h-3 mb-4">
                <div id="upload-progress" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            
            <!-- ë‹¨ê³„ë³„ ìƒì„¸ ì •ë³´ (Detailed Step Information) -->
            <div id="processing-steps" class="space-y-2 mb-4">
                <div id="step-file-upload" class="flex items-center justify-between text-sm text-white/60">
                    <span>ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</span>
                    <span id="step1-status">ëŒ€ê¸° ì¤‘</span>
                </div>
                <div id="step-page-validation" class="flex items-center justify-between text-sm text-white/60">
                    <span>ğŸ“Š í˜ì´ì§€ ìˆ˜ ê²€ì¦</span>
                    <span id="step2-status">ëŒ€ê¸° ì¤‘</span>
                </div>
                <div id="step-image-conversion" class="flex items-center justify-between text-sm text-white/60">
                    <span>ğŸ–¼ï¸ ì´ë¯¸ì§€ ë³€í™˜</span>
                    <span id="step3-status">ëŒ€ê¸° ì¤‘</span>
                </div>
                <div id="step-ocr-processing" class="flex items-center justify-between text-sm text-white/60">
                    <span>ğŸ‘ï¸ OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ</span>
                    <span id="step4-status">ëŒ€ê¸° ì¤‘</span>
                </div>
                <div id="step-ai-processing" class="flex items-center justify-between text-sm text-white/60">
                    <span>ğŸ¤– AI í›„ì²˜ë¦¬</span>
                    <span id="step5-status">ëŒ€ê¸° ì¤‘</span>
                </div>
            </div>
            
            <!-- í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ í˜ì´ì§€ ì •ë³´ (Current Page Information) -->
            <div id="page-info" class="text-xs text-white/50 mb-2 opacity-0 transition-opacity">
                <span id="current-page">1</span>/<span id="total-pages">1</span> í˜ì´ì§€ ì²˜ë¦¬ ì¤‘
            </div>
            
            <!-- ë„ì›€ë§ ë©”ì‹œì§€ (Help Message) -->
            <div class="text-xs text-white/50">
                ğŸ’¡ ëŒ€ìš©ëŸ‰ íŒŒì¼ì´ë‚˜ ë§ì€ í˜ì´ì§€ì˜ ê²½ìš° ì²˜ë¦¬ ì‹œê°„ì´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </div>
        </div>
    </div>
    <!-- í†µí•© ë„¤ë¹„ê²Œì´ì…˜ í—¤ë” -->
    <header class="glassmorphism backdrop-blur-xl bg-white/10 border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <!-- ë¸Œëœë“œ & ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="flex items-center space-x-6">
                    <a href="index.html" class="flex items-center space-x-3 group">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-white group-hover:text-blue-300 transition-colors">
                                Paperwork AI
                            </div>
                            <div class="text-xs text-white/60">AI ë¬¸ì„œ í¸ì§‘ê¸°</div>
                        </div>
                    </a>
                    
                    <!-- ë¸Œë ˆë“œí¬ëŸ¼ ë„¤ë¹„ê²Œì´ì…˜ -->
                    <div class="hidden md:flex items-center space-x-2 text-white/60">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        <span class="text-white font-medium">í¸ì§‘ê¸°</span>
                    </div>
                </div>
                
                <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                <div class="flex items-center space-x-3">
                    <button onclick="saveDocument()" class="hidden md:flex items-center space-x-2 px-4 py-2 bg-green-500/20 text-green-300 rounded-xl border border-green-400/30 hover:bg-green-500/30 hover:text-green-200 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <span>ì €ì¥</span>
                    </button>
                    <button onclick="exportDocument()" class="flex items-center space-x-2 px-4 py-2 bg-blue-500/20 text-blue-300 rounded-xl border border-blue-400/30 hover:bg-blue-500/30 hover:text-blue-200 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span class="hidden sm:inline">ë‚´ë³´ë‚´ê¸°</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ì§„í–‰ ë‹¨ê³„ í‘œì‹œ -->
    <section class="glassmorphism bg-white/5 border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-center space-x-8">
                <div class="flex items-center space-x-2">
                    <div id="step1" class="step-indicator active">1</div>
                    <span class="text-sm font-medium text-white/80">ë¬¸ì„œ ì—…ë¡œë“œ</span>
                </div>
                <div class="h-px w-16 bg-white/20"></div>
                <div class="flex items-center space-x-2">
                    <div id="step2" class="step-indicator pending">2</div>
                    <span class="text-sm font-medium text-white/80">ì¶”ì¶œ ì˜µì…˜</span>
                </div>
                <div class="h-px w-16 bg-white/20"></div>
                <div class="flex items-center space-x-2">
                    <div id="step3" class="step-indicator pending">3</div>
                    <span class="text-sm font-medium text-white/80">ì°¸ê³ ìë£Œ</span>
                </div>
                <div class="h-px w-16 bg-white/20"></div>
                <div class="flex items-center space-x-2">
                    <div id="step4" class="step-indicator pending">4</div>
                    <span class="text-sm font-medium text-white/80">í¸ì§‘</span>
                </div>
            </div>
        </div>
    </section>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="layout-grid animate-fade-in-scale">
            
            <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” - ì—…ë¡œë“œ ë° AI ë„êµ¬ -->
            <!-- Mobile Sidebar Toggle -->
            <div class="lg:hidden mb-4">
                <button id="mobileSidebarToggle" class="w-full glassmorphism bg-white/10 text-white px-4 py-3 rounded-xl flex items-center justify-between">
                    <span class="flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                        <span>ë¬¸ì„œ ì—…ë¡œë“œ ë° AI ë„êµ¬</span>
                    </span>
                    <svg id="toggleIcon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>
            <div id="mobileSidebar" class="space-y-6 lg:block hidden animate-slide-in-up">
                
                <!-- 1ë‹¨ê³„: ë¬¸ì„œ ì—…ë¡œë“œ -->
                <div id="uploadSection" class="glassmorphism rounded-2xl p-6 shadow-depth-2">
                    <div class="step-header cursor-pointer" onclick="toggleStep1()">
                        <h3 class="text-heading text-lg mb-4 flex items-center justify-between">
                            <span class="flex items-center">
                                <div class="icon-container icon-primary mr-3">ğŸ“„</div>
                                1. ë¬¸ì„œ ì—…ë¡œë“œ
                            </span>
                            <div id="uploadStatus" class="hidden">
                                <span class="status-indicator status-success animate-pulse">âœ… ì™„ë£Œ</span>
                            </div>
                        </h3>
                    </div>
                    
                    <div class="step-content content-spacing">
                        <div class="border-2 border-dashed border-white/20 rounded-xl p-8 text-center hover:border-blue-400 hover:bg-white/5 transition-all duration-300 group" 
                         id="documentDropZone"
                         ondrop="handleDocumentDrop(event)" 
                         ondragover="handleDragOver(event)" 
                         ondragenter="handleDragEnter(event)" 
                         ondragleave="handleDragLeave(event)">
                        <div class="text-5xl mb-4 group-hover:scale-110 transition-transform duration-300">ğŸ“</div>
                        <p class="text-body mb-3">ì¶”ì¶œí•  ë¬¸ì„œë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜</p>
                        <input type="file" id="documentInput" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" 
                               style="display: none" onchange="handleDocumentSelect(event)">
                        <button onclick="document.getElementById('documentInput').click()" 
                                class="btn-primary mb-4">
                            íŒŒì¼ ì„ íƒ
                        </button>
                        <div class="item-spacing">
                            <p class="text-caption">PDF, DOC, DOCX, JPG, PNG</p>
                            <p class="text-caption text-orange-300 flex items-center justify-center">
                                <span class="mr-1">âš ï¸</span>
                                PDFëŠ” 10í˜ì´ì§€ ë¯¸ë§Œ ì—…ë¡œë“œ ê¸ˆì§€
                            </p>
                        </div>
                    </div>
                    
                    <!-- ì—…ë¡œë“œëœ ë¬¸ì„œ ì •ë³´ -->
                    <div id="documentInfo" class="hidden mt-4 card-secondary border border-blue-400/20 bg-blue-500/10">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="icon-container icon-success">
                                    <span id="documentIcon">ğŸ“„</span>
                                </div>
                                <div>
                                    <div id="documentName" class="text-body text-sm font-semibold"></div>
                                    <div id="documentSize" class="text-caption"></div>
                                </div>
                            </div>
                            <button onclick="clearDocument()" class="btn-outline p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10">
                                âŒ
                            </button>
                        </div>
                        </div>
                    </div>
                </div>
                
                <!-- 2ë‹¨ê³„: ì¶”ì¶œ ì˜µì…˜ -->
                <div id="extractionSection" class="glassmorphism rounded-2xl p-6 shadow-depth-2 opacity-50 transition-opacity duration-500">
                    <h3 class="text-heading text-lg mb-4 flex items-center">
                        <div class="icon-container icon-primary mr-3">âš™ï¸</div>
                        2. ì¶”ì¶œ ì˜µì…˜
                    </h3>
                    
                    <!-- ì¶”ì¶œ ì˜µì…˜ ì„ íƒ (Extraction Options) -->
                    <div class="content-spacing mb-6">
                        <h4 class="text-subheading text-sm mb-3 flex items-center">
                            <span class="mr-2">ğŸ“</span>
                            ì¶”ì¶œ ë°©ì‹
                        </h4>
                        <div class="item-spacing">
                            <label class="card-secondary cursor-pointer hover:scale-[1.02] transition-all duration-200 flex items-center space-x-3">
                                <input type="radio" name="extractionType" value="raw" checked class="w-4 h-4 text-blue-500">
                                <div class="flex-1">
                                    <div class="text-body font-semibold">ì›ë³¸ ê·¸ëŒ€ë¡œ</div>
                                    <div class="text-caption">OCR ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ê¸°</div>
                                </div>
                            </label>
                            <label class="card-secondary cursor-pointer hover:scale-[1.02] transition-all duration-200 flex items-center space-x-3">
                                <input type="radio" name="extractionType" value="cleaned" class="w-4 h-4 text-blue-500">
                                <div class="flex-1">
                                    <div class="text-body font-semibold">ì •ë¦¬ëœ í˜•íƒœ</div>
                                    <div class="text-caption">ë§ì¶¤ë²•, ë„ì–´ì“°ê¸° êµì •</div>
                                </div>
                            </label>
                            <label class="card-secondary cursor-pointer hover:scale-[1.02] transition-all duration-200 flex items-center space-x-3">
                                <input type="radio" name="extractionType" value="structured" class="w-4 h-4 text-blue-500">
                                <div class="flex-1">
                                    <div class="text-body font-semibold">êµ¬ì¡°í™”</div>
                                    <div class="text-caption">ì œëª©, ëª©ë¡, ë‹¨ë½ìœ¼ë¡œ êµ¬ì¡°í™”</div>
                                </div>
                            </label>
                            <label class="card-secondary cursor-pointer hover:scale-[1.02] transition-all duration-200 flex items-center space-x-3">
                                <input type="radio" name="extractionType" value="summarized" class="w-4 h-4 text-blue-500">
                                <div class="flex-1">
                                    <div class="text-body font-semibold">ìš”ì•½</div>
                                    <div class="text-caption">í•µì‹¬ ë‚´ìš©ë§Œ ê°„ì¶”ë ¤ì„œ</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- AI ëª¨ë¸ ì„ íƒ (AI Model Selection) -->
                    <div class="content-spacing">
                        <h4 class="text-subheading text-sm mb-3 flex items-center">
                            <span class="mr-2">ğŸ¤–</span>
                            AI ëª¨ë¸ ì„ íƒ
                        </h4>
                        <div class="item-spacing">
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="gemini" checked class="text-google-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-google-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">Google Gemini</div>
                                        <div class="text-xs text-white/60">ì •í™•ë„ ë†’ìŒ, ë‹¤êµ­ì–´ ì§€ì›</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="gpt-4" class="text-openai-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-openai-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">OpenAI GPT-4</div>
                                        <div class="text-xs text-white/60">ì°½ì˜ì  ì²˜ë¦¬, ë¬¸ë§¥ ì´í•´</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="claude" class="text-anthropic-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-anthropic-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">Anthropic Claude</div>
                                        <div class="text-xs text-white/60">ë¶„ì„ë ¥ ìš°ìˆ˜, ì•ˆì „í•œ ì²˜ë¦¬</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="perplexity" class="text-perplexity-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-perplexity-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">Perplexity AI</div>
                                        <div class="text-xs text-white/60">ê²€ìƒ‰ ê¸°ë°˜, ì‹¤ì‹œê°„ ì •ë³´</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="clova" class="text-clova-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-clova-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">ë„¤ì´ë²„ í´ë¡œë°”X</div>
                                        <div class="text-xs text-white/60">í•œêµ­ì–´ íŠ¹í™”, ë¡œì»¬ ì»¨í…ìŠ¤íŠ¸</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- AI ëª¨ë¸ ì„¤ëª… -->
                        <div class="mt-3 p-3 bg-white/5 rounded-lg border border-white/10">
                            <div class="text-xs text-white/70">
                                ğŸ’¡ <strong>ëª¨ë¸ ì„ íƒ ê°€ì´ë“œ:</strong><br>
                                â€¢ <strong>Gemini</strong>: ì¼ë°˜ì ì¸ ë¬¸ì„œ ì²˜ë¦¬ì— ìµœì <br>
                                â€¢ <strong>GPT-4</strong>: ì°½ì˜ì  í¸ì§‘ ë° ìŠ¤íƒ€ì¼ ë³€ê²½<br>
                                â€¢ <strong>Claude</strong>: ì •í™•í•œ ë¶„ì„ ë° ìš”ì•½<br>
                                â€¢ <strong>Perplexity</strong>: ìµœì‹  ì •ë³´ ê¸°ë°˜ ë³´ê°•<br>
                                â€¢ <strong>í´ë¡œë°”X</strong>: í•œêµ­ì–´ íŠ¹í™” ì²˜ë¦¬ ë° ë¡œì»¬ ì»¨í…ìŠ¤íŠ¸
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3ë‹¨ê³„: ì°¸ê³ ìë£Œ ì—…ë¡œë“œ -->
                <div id="referenceSection" class="glassmorphism rounded-2xl p-6 opacity-50">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ“š</span>
                        3. ì°¸ê³ ìë£Œ (ì„ íƒ)
                    </h3>
                    
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-4 text-center hover:border-green-400 transition-colors" 
                         id="referenceDropZone"
                         ondrop="handleReferenceDrop(event)" 
                         ondragover="handleDragOver(event)">
                        <div class="text-2xl mb-1">ğŸ“š</div>
                        <p class="text-white/60 text-xs mb-2">ì°¸ê³ ìë£Œ ì—…ë¡œë“œ</p>
                        <input type="file" id="referenceInput" accept=".pdf,.doc,.docx,.txt,.md" 
                               style="display: none" onchange="handleReferenceSelect(event)" multiple>
                        <button onclick="document.getElementById('referenceInput').click()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition-colors">
                            ì¶”ê°€
                        </button>
                    </div>
                    
                    <!-- ì°¸ê³ ìë£Œ ëª©ë¡ -->
                    <div id="referenceList" class="mt-3 space-y-2">
                        <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    </div>
                </div>
                
                <!-- AI ë„êµ¬ -->
                <div id="aiToolsSection" class="glassmorphism rounded-2xl p-6 opacity-50">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ¤–</span>
                        AI í¸ì§‘ ë„êµ¬
                    </h3>
                    
                    <div class="space-y-3">
                        <button onclick="aiEnhance('summarize')" class="ai-tool-card w-full text-left">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">ğŸ“‹</span>
                                <div>
                                    <div class="font-medium text-white">ìš”ì•½</div>
                                    <div class="text-xs text-white/60">í•µì‹¬ ë‚´ìš© ì •ë¦¬</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="aiEnhance('expand')" class="ai-tool-card w-full text-left">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">âœ¨</span>
                                <div>
                                    <div class="font-medium text-white">ë³´ê°•</div>
                                    <div class="text-xs text-white/60">ì°¸ê³ ìë£Œ ê¸°ë°˜ í™•ì¥</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="aiEnhance('improve')" class="ai-tool-card w-full text-left">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">ğŸ”§</span>
                                <div>
                                    <div class="font-medium text-white">ê°œì„ </div>
                                    <div class="text-xs text-white/60">ë¬¸ì²´, êµ¬ì¡° ê°œì„ </div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="aiEnhance('translate')" class="ai-tool-card w-full text-left">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">ğŸŒ</span>
                                <div>
                                    <div class="font-medium text-white">ë²ˆì—­</div>
                                    <div class="text-xs text-white/60">ë‹¤êµ­ì–´ ë²ˆì—­</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="detectAndFillBlankFields()" class="ai-tool-card w-full text-left border-l-4 border-l-yellow-400">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">ğŸ§©</span>
                                <div>
                                    <div class="font-medium text-white">ìë™ ì±„ìš°ê¸°</div>
                                    <div class="text-xs text-white/60">ë¹ˆ í•­ëª© AI ì¶”ë¡ </div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ë©”ì¸ í¸ì§‘ ì˜ì—­ -->
            <div>
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    
                    <!-- í¸ì§‘ê¸° íˆ´ë°” (Quill ìë™ ìƒì„±) -->
                    <div id="toolbar">
                        <!-- ê¸°ë³¸ í¬ë§·íŒ… -->
                        <span class="ql-formats">
                            <select class="ql-font"></select>
                            <select class="ql-size"></select>
                        </span>
                        
                        <!-- í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ -->
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                            <button class="ql-strike"></button>
                        </span>
                        
                        <!-- ìƒ‰ìƒ -->
                        <span class="ql-formats">
                            <select class="ql-color"></select>
                            <select class="ql-background"></select>
                        </span>
                        
                        <!-- ì •ë ¬ -->
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                            <select class="ql-align"></select>
                        </span>
                        
                        <!-- ì‚½ì… -->
                        <span class="ql-formats">
                            <button class="ql-link"></button>
                            <button class="ql-image"></button>
                        </span>
                        
                        <!-- ì‹¤í–‰ì·¨ì†Œ/ë‹¤ì‹œì‹¤í–‰ -->
                        <span class="ql-formats">
                            <button class="ql-undo"></button>
                            <button class="ql-redo"></button>
                        </span>
                        
                        <!-- AI ë„êµ¬ ë²„íŠ¼ -->
                        <span class="ql-formats">
                            <button onclick="showAIPanel()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">
                                ğŸ¤– AI ë„êµ¬
                            </button>
                        </span>
                    </div>
                    
                    <!-- í¸ì§‘ê¸° ì»¨í…Œì´ë„ˆ -->
                    <div id="editor" style="height: 600px;">
                        <div class="text-center text-white/40 mt-48">
                            <div class="text-4xl mb-4">ğŸ“</div>
                            <h3 class="text-xl font-semibold mb-2">AI ë¬¸ì„œ í¸ì§‘ê¸°</h3>
                            <p class="text-white/50">ì™¼ìª½ì—ì„œ ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ í¸ì§‘ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
                
                <!-- í¸ì§‘ ìƒíƒœ í‘œì‹œ -->
                <div class="mt-4 flex items-center justify-between text-sm text-white/60">
                    <div class="flex items-center space-x-4">
                        <span id="wordCount">ë‹¨ì–´: 0</span>
                        <span id="charCount">ê¸€ì: 0</span>
                        <span id="lastSaved">ì €ì¥: ì•ˆë¨</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div id="aiStatus" class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span>AI ëŒ€ê¸°</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Paperwork ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link rel="stylesheet" href="css/paperwork-common.css">
    <script src="js/paperwork-common.js"></script>

    <!-- Paperwork Editor ëª¨ë“ˆí™”ëœ ì»´í¬ë„ŒíŠ¸ -->
    <link rel="stylesheet" href="css/editor-styles.css">
    <script src="js/ui-components.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/ai-functions.js"></script>

    <script>
        const API_BASE = 'http://localhost:8002';
        
        // HEAL7 ë¡œë”© ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        let loadingManager;
        document.addEventListener('DOMContentLoaded', () => {
            loadingManager = new LoadingManager();
            window.HEAL7Loading = window.HEAL7Loading || {};
            window.HEAL7Loading.showAILoading = (message, options) => loadingManager.showAILoading(message, options);
            window.HEAL7Loading.showDataLoading = (message, options) => loadingManager.showDataLoading(message, options);
            window.HEAL7Loading.showUploadLoading = (message, options) => loadingManager.showUploadLoading(message, options);
        });
        
        // ğŸš« EditorNotifications í´ë˜ìŠ¤ ì¤‘ë³µ ì„ ì–¸ ì œê±° (ui-components.jsì—ì„œ ì´ë¯¸ ì •ì˜ë¨)
        
        // ğŸš« UploadProgress í´ë˜ìŠ¤ ì¤‘ë³µ ì„ ì–¸ ì œê±° (ui-components.jsì—ì„œ ì´ë¯¸ ì •ì˜ë¨)
        
        // Global instances (í´ë˜ìŠ¤ëŠ” ui-components.jsì—ì„œ ì •ì˜ë¨)
        const notify = new EditorNotifications();
        const uploadProgress = new UploadProgress();
        
        // ì „ì—­ ë³€ìˆ˜
        let quillEditor = null;
        let selectedDocument = null;
        let referenceDocuments = [];
        let currentStep = 1;
        
        // AI ë¬¸ì„œ í¸ì§‘ê¸° ì´ˆê¸°í™” (AI Document Editor Initialization)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ AI ë¬¸ì„œ í¸ì§‘ê¸° ì´ˆê¸°í™”');
            
            // 1. Quill í¸ì§‘ê¸° ì´ˆê¸°í™”
            initializeEditor();
            
            // 2. ë‹¨ê³„ë³„ ê°€ì´ë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            stepGuide = new StepGuideManager();
            console.log('âœ… ë‹¨ê³„ë³„ ê°€ì´ë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
            
            // 3. 2ë‹¨ê³„ ìë™ ì§„í–‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupStep2AutoProgress();
        });
        
        function initializeEditor() {
            // Quill í¸ì§‘ê¸° ì„¤ì •
            quillEditor = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: '#toolbar',
                        handlers: {
                            'undo': function() {
                                this.quill.history.undo();
                            },
                            'redo': function() {
                                this.quill.history.redo();
                            }
                        }
                    },
                    history: {
                        delay: 1000,
                        maxStack: 100,
                        userOnly: true
                    }
                },
                placeholder: 'ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì™¼ìª½ì—ì„œ ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”...'
            });
            
            // í…ìŠ¤íŠ¸ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            quillEditor.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user') {
                    updateWordCount();
                    updateAIStatus('editing');
                }
            });
            
            console.log('âœ… Quill í¸ì§‘ê¸° ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // === 2ë‹¨ê³„ ìë™ ì§„í–‰ ì‹œìŠ¤í…œ (Step 2 Auto-Progress System) ===
        
        /**
         * 2ë‹¨ê³„ì—ì„œ ëª¨ë“  ì„ íƒì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ 3ë‹¨ê³„ë¡œ ì´ë™
         */
        function setupStep2AutoProgress() {
            // AI ëª¨ë¸ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
            const aiModelInputs = document.querySelectorAll('input[name="aiModel"]');
            aiModelInputs.forEach((input, index) => {
                input.addEventListener('change', () => {
                    console.log(`ğŸ”„ AI ëª¨ë¸ ë³€ê²½ ê°ì§€: ${input.value} (${getAIModelDisplayName(input.value)})`);
                    checkStep2Completion();
                });
            });

            // ì¶”ì¶œ ë°©ì‹ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸  
            const extractionTypeInputs = document.querySelectorAll('input[name="extractionType"]');
            extractionTypeInputs.forEach((input, index) => {
                input.addEventListener('change', () => {
                    console.log(`ğŸ”„ ì¶”ì¶œ ë°©ì‹ ë³€ê²½ ê°ì§€: ${input.value} (${getExtractionTypeDisplayName(input.value)})`);
                    checkStep2Completion();
                });
            });

            console.log(`âœ… 2ë‹¨ê³„ ìë™ ì§„í–‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ - AIëª¨ë¸: ${aiModelInputs.length}ê°œ, ì¶”ì¶œë°©ì‹: ${extractionTypeInputs.length}ê°œ`);
        }

        /**
         * 2ë‹¨ê³„ ì™„ë£Œ ìƒíƒœ ì²´í¬ ë° ìë™ ì§„í–‰
         */
        function checkStep2Completion() {
            // StepGuideì˜ í˜„ì¬ ë‹¨ê³„ í™•ì¸
            const currentStepFromGuide = stepGuide ? stepGuide.currentStep : currentStep;
            
            // í˜„ì¬ ë‹¨ê³„ê°€ 2ë‹¨ê³„ì´ê³  ë¬¸ì„œê°€ ì„ íƒëœ ê²½ìš°ì—ë§Œ ì²´í¬
            if (currentStepFromGuide !== 2 || !selectedDocument) {
                console.log(`âŒ 2ë‹¨ê³„ ìë™ ì§„í–‰ ì¡°ê±´ ë¯¸ì¶©ì¡±: í˜„ì¬ë‹¨ê³„=${currentStepFromGuide}, ë¬¸ì„œì„ íƒ=${!!selectedDocument}`);
                return;
            }

            const selectedAIModel = document.querySelector('input[name="aiModel"]:checked');
            const selectedExtractionType = document.querySelector('input[name="extractionType"]:checked');

            console.log(`ğŸ” 2ë‹¨ê³„ ì™„ë£Œ ì²´í¬: AIëª¨ë¸=${!!selectedAIModel}, ì¶”ì¶œë°©ì‹=${!!selectedExtractionType}`);

            // AI ëª¨ë¸ê³¼ ì¶”ì¶œ ë°©ì‹ì´ ëª¨ë‘ ì„ íƒëœ ê²½ìš°
            if (selectedAIModel && selectedExtractionType) {
                console.log(`ğŸ¯ 2ë‹¨ê³„ ì™„ë£Œ ê°ì§€! AIëª¨ë¸: ${getAIModelDisplayName(selectedAIModel.value)}, ì¶”ì¶œë°©ì‹: ${getExtractionTypeDisplayName(selectedExtractionType.value)}`);
                
                // ì§§ì€ ì§€ì—° í›„ 3ë‹¨ê³„ë¡œ ìë™ ì´ë™ (ì‚¬ìš©ìê°€ ì„ íƒì„ í™•ì¸í•  ìˆ˜ ìˆë„ë¡)
                setTimeout(() => {
                    if (stepGuide && stepGuide.currentStep === 2) { // ì—¬ì „íˆ 2ë‹¨ê³„ì— ìˆëŠ”ì§€ í™•ì¸
                        stepGuide.completeStep(2);
                        stepGuide.moveToStep(3);
                        
                        // 3ë‹¨ê³„ í™œì„±í™” ì•Œë¦¼
                        notify.success('ğŸš€ ì„¤ì • ì™„ë£Œ! 3ë‹¨ê³„(ì°¸ê³ ìë£Œ)ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        
                        console.log('âœ… 3ë‹¨ê³„ë¡œ ìë™ ì´ë™ ì™„ë£Œ');
                    }
                }, 800); // 0.8ì´ˆ ì§€ì—°
            }
        }
        
        // === PDF í˜ì´ì§€ ìˆ˜ ê²€ì¦ í•¨ìˆ˜ (PDF Page Count Validation) ===
        
        /**
         * PDF íŒŒì¼ì˜ í˜ì´ì§€ ìˆ˜ë¥¼ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
         * @param {File} file - ê²€ì¦í•  PDF íŒŒì¼
         * @returns {Promise<number>} - í˜ì´ì§€ ìˆ˜
         */
        async function getPDFPageCount(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                
                fileReader.onload = async function(e) {
                    try {
                        // PDF.jsë¥¼ ì‚¬ìš©í•˜ì—¬ PDF íŒŒì¼ ë¡œë“œ
                        const arrayBuffer = e.target.result;
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        
                        // í˜ì´ì§€ ìˆ˜ ë°˜í™˜
                        resolve(pdf.numPages);
                    } catch (error) {
                        console.error('PDF í˜ì´ì§€ ìˆ˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                        reject(error);
                    }
                };
                
                fileReader.onerror = function() {
                    reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                };
                
                fileReader.readAsArrayBuffer(file);
            });
        }

        /**
         * íŒŒì¼ íƒ€ì…ë³„ í˜ì´ì§€ ìˆ˜ ê²€ì¦
         * @param {File} file - ê²€ì¦í•  íŒŒì¼
         * @returns {Promise<boolean>} - ê²€ì¦ í†µê³¼ ì—¬ë¶€
         */
        async function validateFilePageCount(file) {
            const MIN_PAGES = 10; // ìµœì†Œ í˜ì´ì§€ ìˆ˜ (10í˜ì´ì§€ ë¯¸ë§Œ ê¸ˆì§€)
            
            // PDF íŒŒì¼ë§Œ í˜ì´ì§€ ìˆ˜ ê²€ì¦
            if (file.type === 'application/pdf') {
                try {
                    // í˜ì´ì§€ ìˆ˜ ê²€ì¦ ë‹¨ê³„ ì‹œì‘
                    uploadProgress.startStep('validation', 'PDF í˜ì´ì§€ ìˆ˜ ë¶„ì„ ì¤‘...', 15);
                    
                    const pageCount = await getPDFPageCount(file);
                    
                    // í˜ì´ì§€ ìˆ˜ í™•ì¸ ì™„ë£Œ
                    uploadProgress.update(25, `${pageCount}í˜ì´ì§€ í™•ì¸ë¨`);
                    
                    // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
                    console.log(`ğŸ“Š PDF í˜ì´ì§€ ê²€ì¦: ${pageCount}í˜ì´ì§€, ìµœì†Œ ìš”êµ¬: ${MIN_PAGES}í˜ì´ì§€`);
                    
                    if (pageCount >= MIN_PAGES) {
                        uploadProgress.showError('validation', `${pageCount}í˜ì´ì§€ëŠ” í—ˆìš©ëœ ìµœëŒ€ ìš”êµ¬ì‚¬í•­(${MIN_PAGES}í˜ì´ì§€ ë¯¸ë§Œ)ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                        setTimeout(() => uploadProgress.hide(), 3000);
                        notify.warning(`âŒ ì´ PDFëŠ” ${pageCount}í˜ì´ì§€ì…ë‹ˆë‹¤. ${MIN_PAGES}í˜ì´ì§€ ë¯¸ë§Œì˜ ë¬¸ì„œë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                        return false;
                    }
                    
                    // ê²€ì¦ ì™„ë£Œ
                    uploadProgress.completeStep('validation', `${pageCount}í˜ì´ì§€ ê²€ì¦ ì™„ë£Œ`);
                    
                    // ë©€í‹°í˜ì´ì§€ ì •ë³´ ì„¤ì •
                    if (pageCount > 1) {
                        uploadProgress.updatePageProgress(1, pageCount, 'validation');
                    }
                    
                    return true;
                    
                } catch (error) {
                    uploadProgress.showError('validation', 'PDF íŒŒì¼ ë¶„ì„ ì‹¤íŒ¨');
                    setTimeout(() => uploadProgress.hide(), 3000);
                    notify.error('PDF íŒŒì¼ì„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ PDF íŒŒì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return false;
                }
            }
            
            // PDFê°€ ì•„ë‹Œ ê²½ìš° (ì´ë¯¸ì§€, DOC ë“±)ëŠ” ê²€ì¦ ì™„ë£Œë¡œ í‘œì‹œ
            uploadProgress.completeStep('validation', 'íŒŒì¼ í˜•ì‹ ê²€ì¦ ì™„ë£Œ');
            return true;
        }

        // === íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
        
        function handleDocumentDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleDocumentFile(files[0]);
            }
            document.getElementById('documentDropZone').classList.remove('border-blue-400');
        }
        
        // Enhanced File Upload with Progress and Error Handling (ì—…ë¡œë“œ ì²˜ë¦¬ ê°œì„  ë° ì—ëŸ¬ í•¸ë“¤ë§)
        async function handleDocumentSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // ê¸°ë³¸ íŒŒì¼ ê²€ì¦ (Basic File Validation)
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = [".pdf", ".doc", ".docx", ".jpg", ".jpeg", ".png"];
            const fileExt = "." + file.name.split(".").pop().toLowerCase();
            
            // íŒŒì¼ í¬ê¸° ê²€ì¦
            if (file.size > maxSize) {
                notify.error("íŒŒì¼ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ë” ì‘ì€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            // íŒŒì¼ íƒ€ì… ê²€ì¦  
            if (!allowedTypes.includes(fileExt)) {
                notify.error("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. PDF, DOC, DOCX, JPG, PNG íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }
            
            try {
                // íŒŒì¼ ê²€ì¦ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ (File Validation Process Start)
                uploadProgress.show("íŒŒì¼ ê²€ì¦ ì¤‘...", "ë¬¸ì„œ ì—…ë¡œë“œ");
                
                // 1ë‹¨ê³„: íŒŒì¼ ì—…ë¡œë“œ 
                uploadProgress.startStep('upload', 'íŒŒì¼ì„ ì„œë²„ì— ì—…ë¡œë“œ ì¤‘...', 30);
                await new Promise(resolve => setTimeout(resolve, 300)); // ì—…ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
                uploadProgress.completeStep('upload', 'íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ');
                
                // 2ë‹¨ê³„: PDF í˜ì´ì§€ ìˆ˜ ê²€ì¦ (PDF Page Count Validation)
                uploadProgress.startStep('validation', 'íŒŒì¼ ìœ íš¨ì„± ê²€ì¦ ì¤‘...', 70);
                const isValidPageCount = await validateFilePageCount(file);
                if (!isValidPageCount) {
                    uploadProgress.hide();
                    return;
                }
                uploadProgress.completeStep('validation', 'íŒŒì¼ ê²€ì¦ ì™„ë£Œ');
                
                // ìµœì¢… ì™„ë£Œ (Final Completion) - OCRì€ "ì¶”ì¶œí•˜ê¸°" ë²„íŠ¼ì—ì„œ ì‹¤í–‰
                uploadProgress.update(100, "íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ! ì¶”ì¶œ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.");
                
                // íŒŒì¼ ì •ë³´ ì €ì¥ (Store file info)
                selectedDocument = file;
                
                // UI ì—…ë°ì´íŠ¸ (Update UI)
                displayDocumentInfo(file);
                
                // ë‹¨ê³„ë³„ ê°€ì´ë“œ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
                if (stepGuide) {
                    stepGuide.completeStep(1); // 1ë‹¨ê³„ ì™„ë£Œ
                    stepGuide.moveToStep(2);   // 2ë‹¨ê³„ë¡œ ì´ë™
                    minimizeStep1(); // 1ë‹¨ê³„ ë°•ìŠ¤ ìµœì†Œí™”
                    
                    // 2ë‹¨ê³„ë¡œ ì´ë™ í›„ ì‚¬ìš©ìê°€ ì§ì ‘ ì„ íƒí•˜ë„ë¡ ëŒ€ê¸°
                    // ìë™ ì§„í–‰í•˜ì§€ ì•ŠìŒ - ì‚¬ìš©ìê°€ ì§ì ‘ AI ëª¨ë¸ê³¼ ì¶”ì¶œ ë°©ì‹ì„ í™•ì¸/ì„ íƒí•´ì•¼ í•¨
                    console.log('ğŸ“‹ 2ë‹¨ê³„ì—ì„œ AI ëª¨ë¸ê³¼ ì¶”ì¶œ ë°©ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    uploadProgress.hide();
                    notify.success(`ğŸ“„ "${file.name}" íŒŒì¼ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ 2ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ì„¸ìš”.`);
                }, 1000);
                
            } catch (error) {
                uploadProgress.showError('upload', 'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                setTimeout(() => uploadProgress.hide(), 3000);
                console.error("ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
                notify.error("íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        }
        
        // ë“œë˜ê·¸ì•¤ë“œë¡­ íŒŒì¼ ì²˜ë¦¬ (Drag & Drop File Handler) 
        async function handleDocumentFile(file) {
            // ê¸°ë³¸ íŒŒì¼ ê²€ì¦ (Basic File Validation)
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['application/pdf', 'application/msword', 
                                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                'image/jpeg', 'image/png'];
            
            // íŒŒì¼ í¬ê¸° ê²€ì¦
            if (file.size > maxSize) {
                notify.error('íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ íƒ€ì… ê²€ì¦
            if (!allowedTypes.includes(file.type)) {
                notify.error('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. PDF, DOC, DOCX, JPG, PNGë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
                return;
            }
            
            try {
                // PDF í˜ì´ì§€ ìˆ˜ ê²€ì¦ (PDF Page Count Validation)
                const isValidPageCount = await validateFilePageCount(file);
                if (!isValidPageCount) {
                    // validateFilePageCountì—ì„œ ì´ë¯¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•¨
                    return;
                }
                
                // íŒŒì¼ ì •ë³´ ì €ì¥ ë° UI ì—…ë°ì´íŠ¸
                selectedDocument = file;
                displayDocumentInfo(file);
                moveToStep(2);
                
                notify.success(`"${file.name}" íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
            } catch (error) {
                console.error("ë“œë˜ê·¸ì•¤ë“œë¡­ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                notify.error("íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        }
        
        function displayDocumentInfo(file) {
            const info = document.getElementById('documentInfo');
            const name = document.getElementById('documentName');
            const size = document.getElementById('documentSize');
            const icon = document.getElementById('documentIcon');
            
            name.textContent = file.name;
            size.textContent = formatFileSize(file.size);
            
            // íŒŒì¼ íƒ€ì…ë³„ ì•„ì´ì½˜
            if (file.type.includes('pdf')) icon.textContent = 'ğŸ“„';
            else if (file.type.includes('word')) icon.textContent = 'ğŸ“';
            else if (file.type.includes('image')) icon.textContent = 'ğŸ–¼ï¸';
            else icon.textContent = 'ğŸ“„';
            
            info.classList.remove('hidden');
        }
        
        // === ë°•ìŠ¤ ìµœì†Œí™” ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
        function minimizeStep1() {
            const uploadSection = document.getElementById('uploadSection');
            const uploadStatus = document.getElementById('uploadStatus');
            
            // 1ë‹¨ê³„ ë°•ìŠ¤ ìµœì†Œí™”
            uploadSection.classList.add('minimized');
            
            // ì™„ë£Œ ìƒíƒœ í‘œì‹œ
            uploadStatus.classList.remove('hidden');
            
            // ìŠ¤í¬ë¡¤ì„ í˜„ì¬ ìœ„ì¹˜ì— ìœ ì§€ (ìŠ¤í¬ë¡¤ ë°©ì§€)
            const currentScrollY = window.scrollY;
            
            setTimeout(() => {
                window.scrollTo(0, currentScrollY);
            }, 100);
        }
        
        function expandStep1() {
            const uploadSection = document.getElementById('uploadSection');
            const uploadStatus = document.getElementById('uploadStatus');
            
            // 1ë‹¨ê³„ ë°•ìŠ¤ í™•ì¥
            uploadSection.classList.remove('minimized');
            uploadStatus.classList.add('hidden');
        }
        
        function minimizeStep2() {
            const extractionSection = document.getElementById('extractionSection');
            extractionSection.classList.add('minimized');
        }
        
        function toggleStep1() {
            const uploadSection = document.getElementById('uploadSection');
            if (uploadSection.classList.contains('minimized')) {
                expandStep1();
            } else {
                minimizeStep1();
            }
        }
        
        // === ì¶”ì¶œ í”„ë¡œì„¸ìŠ¤ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
        function startExtraction() {
            // ì¶”ì¶œ ìŠ¹ì¸ ëª¨ë‹¬ í‘œì‹œ
            showExtractionApprovalModal();
        }
        
        function showExtractionApprovalModal() {
            const modal = document.getElementById('extractionApprovalModal');
            const docName = document.getElementById('extractionDocName');
            const aiModel = document.getElementById('extractionAIModel');
            const extractType = document.getElementById('extractionType');
            
            // í˜„ì¬ ì„ íƒëœ ê°’ë“¤ë¡œ ëª¨ë‹¬ ë‚´ìš© ì±„ìš°ê¸°
            if (selectedDocument) {
                docName.textContent = selectedDocument.name;
            }
            
            const selectedAIModel = getSelectedAIModel();
            aiModel.textContent = getAIModelDisplayName(selectedAIModel);
            
            const selectedExtractionType = getSelectedExtractionType();
            extractType.textContent = getExtractionTypeDisplayName(selectedExtractionType);
            
            // ëª¨ë‹¬ í‘œì‹œ
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function hideExtractionApprovalModal() {
            const modal = document.getElementById('extractionApprovalModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        function cancelExtraction() {
            hideExtractionApprovalModal();
        }
        
        function confirmExtraction() {
            hideExtractionApprovalModal();
            // ì‹¤ì œ ì¶”ì¶œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
            performExtraction();
        }
        
        async function performExtraction() {
            if (!selectedDocument) {
                notify.error("ì¶”ì¶œí•  ë¬¸ì„œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }
            
            try {
                const selectedAIModel = getSelectedAIModel();
                const extractionType = getSelectedExtractionType();
                
                console.log(`ğŸ“„ ë¬¸ì„œ ì¶”ì¶œ ì‹œì‘ - ëª¨ë¸: ${getAIModelDisplayName(selectedAIModel)}, ë°©ì‹: ${extractionType}`);
                
                // ë„¤ì´ë²„ OCR ë° AI ì²˜ë¦¬ ë‹¨ê³„ë³„ í‘œì‹œ
                uploadProgress.show("ë¬¸ì„œ ì¶”ì¶œì„ ì‹œì‘í•©ë‹ˆë‹¤...", "ë„¤ì´ë²„ OCR + AI ë¶„ì„");
                
                // 1ë‹¨ê³„: ì´ë¯¸ì§€ ë³€í™˜
                uploadProgress.startStep('conversion', 'ë¬¸ì„œë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜ ì¤‘...', 20);
                
                // 2ë‹¨ê³„: ë„¤ì´ë²„ OCR ì²˜ë¦¬  
                uploadProgress.startStep('ocr', 'ë„¤ì´ë²„ í´ë¡œë°”X OCRë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...', 60);
                
                // 3ë‹¨ê³„: AI í›„ì²˜ë¦¬
                uploadProgress.startStep('ai', `${getAIModelDisplayName(selectedAIModel)}ë¡œ í…ìŠ¤íŠ¸ ë¶„ì„ ì¤‘...`, 90);
                
                const formData = new FormData();
                formData.append('file', selectedDocument);
                formData.append('ai_model', selectedAIModel);
                formData.append('extraction_type', extractionType);
                
                const response = await fetch(`${API_BASE}/ai-edit/process-multipart`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('ğŸ“„ ì¶”ì¶œ ì„±ê³µ:', result);
                    
                    // ì¶”ì¶œ ì™„ë£Œ í›„ í¸ì§‘ì°½ì— ë‚´ìš© í‘œì‹œ
                    displayExtractedContent(result.data);
                    
                    uploadProgress.hide();
                    notify.success("ë¬¸ì„œ ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    
                    // 2ë‹¨ê³„ ë°•ìŠ¤ ìµœì†Œí™”
                    minimizeStep2();
                    
                } else {
                    throw new Error('ì¶”ì¶œ ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ì¶”ì¶œ ì˜¤ë¥˜:', error);
                uploadProgress.hide();
                notify.error("ë¬¸ì„œ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        }
        
        // ì„ íƒëœ AI ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°
        function getSelectedAIModel() {
            const selected = document.querySelector('input[name="aiModel"]:checked');
            return selected ? selected.value : 'gemini';
        }
        
        // ì„ íƒëœ ì¶”ì¶œ ë°©ì‹ ê°€ì ¸ì˜¤ê¸°
        function getSelectedExtractionType() {
            const selected = document.querySelector('input[name="extractionType"]:checked');
            return selected ? selected.value : 'raw';
        }
        
        // ì¶”ì¶œ ë°©ì‹ í‘œì‹œëª… ë³€í™˜
        function getExtractionTypeDisplayName(type) {
            const typeMap = {
                'raw': 'ì›ë³¸ ê·¸ëŒ€ë¡œ',
                'enhanced': 'ì¶”ë¡ ìœ¼ë¡œ ê°œì„ ',
                'formatted': 'êµ¬ì¡°í™”'
            };
            return typeMap[type] || type;
        }
        
        // === ì¶”ì¶œ ê²°ê³¼ í˜ì´ì§€ ë·°ì–´ ì‹œìŠ¤í…œ ===
        let extractedData = null;
        let currentViewMode = 'continuous'; // 'continuous' ë˜ëŠ” 'paged'
        let currentPage = 1;
        
        async function displayExtractedContent(data) {
            extractedData = data;
            
            if (!data || !data.pages) {
                notify.error("ì¶”ì¶œëœ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            
            const pageCount = data.pages.length;
            console.log(`ğŸ“„ ì¶”ì¶œëœ í˜ì´ì§€ ìˆ˜: ${pageCount}`);
            
            // í¸ì§‘ê¸° ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            const editorArea = document.getElementById('editorArea');
            if (editorArea) {
                editorArea.scrollIntoView({ behavior: 'smooth' });
            }
            
            // ğŸ§  AI ë¬¸ì„œ í˜•íƒœ ë¶„ì„ ì‹œì‘
            notify.info('ğŸ§  AIê°€ ë¬¸ì„œ í˜•íƒœë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...');
            
            try {
                const documentAnalysis = await analyzeDocumentType(data);
                console.log('ğŸ“‹ ë¬¸ì„œ í˜•íƒœ ë¶„ì„ ê²°ê³¼:', documentAnalysis);
                
                // ë¶„ì„ ê²°ê³¼ì— ë”°ë¼ ë‹¤ë¥¸ í‘œì‹œ ë°©ë²• ì ìš©
                displayContentByDocumentType(data, documentAnalysis);
                
            } catch (error) {
                console.error('ë¬¸ì„œ ë¶„ì„ ì˜¤ë¥˜:', error);
                notify.warning('ë¬¸ì„œ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ëª¨ë“œë¡œ í‘œì‹œí•©ë‹ˆë‹¤.');
                
                // ê¸°ë³¸ ëª¨ë“œë¡œ í´ë°±
                displayDefaultView(data);
            }
        }
        
        /**
         * AIë¥¼ í†µí•œ ë¬¸ì„œ í˜•íƒœ ë¶„ì„
         * @param {Object} data - ì¶”ì¶œëœ ë¬¸ì„œ ë°ì´í„°
         * @returns {Promise<Object>} ë¬¸ì„œ ë¶„ì„ ê²°ê³¼
         */
        async function analyzeDocumentType(data) {
            // ì²« ë²ˆì§¸ í˜ì´ì§€ ë‚´ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ ë¶„ì„
            const firstPageContent = data.pages[0]?.content || '';
            const allContent = data.pages.map(page => page.content).join('\n');
            
            const analysisData = {
                content: firstPageContent,
                full_content: allContent.substring(0, 2000), // ì²˜ìŒ 2000ìë¡œ ì œí•œ
                page_count: data.pages.length,
                ai_model: getSelectedAIModel()
            };
            
            const response = await fetch(`${API_BASE}/ai-edit/analyze-document-type`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(analysisData)
            });
            
            if (!response.ok) {
                throw new Error('ë¬¸ì„œ ë¶„ì„ API í˜¸ì¶œ ì‹¤íŒ¨');
            }
            
            return await response.json();
        }
        
        /**
         * ë¬¸ì„œ í˜•íƒœì— ë”°ë¥¸ ë‚´ìš© í‘œì‹œ
         * @param {Object} data - ì¶”ì¶œëœ ë¬¸ì„œ ë°ì´í„°  
         * @param {Object} analysis - AI ë¶„ì„ ê²°ê³¼
         */
        function displayContentByDocumentType(data, analysis) {
            const documentType = analysis.document_type;
            const confidence = analysis.confidence;
            
            // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            showDocumentAnalysisResult(analysis);
            
            switch (documentType) {
                case 'form':
                case 'application':
                    displayFormDocument(data, analysis);
                    break;
                    
                case 'contract':
                case 'legal':
                    displayStructuredDocument(data, analysis);
                    break;
                    
                case 'report':
                case 'article':
                    displayContinuousDocument(data, analysis);
                    break;
                    
                default:
                    displayDefaultView(data);
            }
        }
        
        /**
         * ì…ë ¥ì–‘ì‹ ë¬¸ì„œ í‘œì‹œ (í¼ í˜•íƒœ)
         */
        function displayFormDocument(data, analysis) {
            console.log('ğŸ“ ì…ë ¥ì–‘ì‹ ë¬¸ì„œë¡œ íŒë‹¨ë¨');
            notify.success('ğŸ“ ì…ë ¥ì–‘ì‹ ë¬¸ì„œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¹ˆ í•„ë“œë¥¼ ìë™ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.');
            
            // í˜ì´ì§€ ë·°ì–´ ëª¨ë“œ ì„ íƒ í‘œì‹œ (10í˜ì´ì§€ ì´ìƒì¼ ë•Œ)
            if (data.pages.length >= 10) {
                showViewModeSelector();
            }
            
            // í¼ ë¬¸ì„œëŠ” ì—°ì† ë³´ê¸°ë¡œ í‘œì‹œí•˜ë˜ ë¹ˆ í•„ë“œ ê°•ì¡°
            displayContinuousViewWithFormHighlights(data, analysis);
            
            // ìë™ ë¹ˆ í•„ë“œ ê°ì§€ ë° ì±„ìš°ê¸° ë²„íŠ¼ í™œì„±í™”
            setTimeout(() => {
                detectAndHighlightFormFields();
            }, 1000);
        }
        
        /**
         * êµ¬ì¡°í™”ëœ ë¬¸ì„œ í‘œì‹œ (ê³„ì•½ì„œ, ë²•ë¥  ë¬¸ì„œ ë“±)
         */
        function displayStructuredDocument(data, analysis) {
            console.log('ğŸ“‹ êµ¬ì¡°í™”ëœ ë¬¸ì„œë¡œ íŒë‹¨ë¨');
            notify.success('ğŸ“‹ êµ¬ì¡°í™”ëœ ë¬¸ì„œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            displayContinuousView();
            initializePageNavigation();
        }
        
        /**
         * ì—°ì† ë¬¸ì„œ í‘œì‹œ (ë³´ê³ ì„œ, ê¸°ì‚¬ ë“±)
         */
        function displayContinuousDocument(data, analysis) {
            console.log('ğŸ“„ ì—°ì† ë¬¸ì„œë¡œ íŒë‹¨ë¨'); 
            notify.success('ğŸ“„ ì—°ì† ë¬¸ì„œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            if (data.pages.length >= 10) {
                showViewModeSelector();
            }
            
            displayContinuousView();
            initializePageNavigation();
        }
        
        /**
         * ê¸°ë³¸ ë³´ê¸° (ë¶„ì„ ì‹¤íŒ¨ ì‹œ í´ë°±)
         */
        function displayDefaultView(data) {
            console.log('ğŸ“„ ê¸°ë³¸ ëª¨ë“œë¡œ í‘œì‹œ');
            
            // í˜ì´ì§€ ë·°ì–´ ëª¨ë“œ ì„ íƒ í‘œì‹œ (10í˜ì´ì§€ ì´ìƒì¼ ë•Œ)
            if (data.pages.length >= 10) {
                showViewModeSelector();
            }
            
            // ê¸°ë³¸ì ìœ¼ë¡œ ì—°ì† ë³´ê¸°ë¡œ ì‹œì‘
            displayContinuousView();
            
            // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            initializePageNavigation();
        }
        
        /**
         * ë¬¸ì„œ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
         */
        function showDocumentAnalysisResult(analysis) {
            const editorContainer = document.querySelector('.lg\\:col-span-3');
            if (!editorContainer) return;
            
            // ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ ì œê±°
            const existingResult = document.getElementById('documentAnalysisResult');
            if (existingResult) existingResult.remove();
            
            const resultDiv = document.createElement('div');
            resultDiv.id = 'documentAnalysisResult';
            resultDiv.className = 'mb-4 p-4 glassmorphism rounded-xl';
            
            const typeEmoji = {
                'form': 'ğŸ“',
                'application': 'ğŸ“‹',
                'contract': 'ğŸ“œ',
                'legal': 'âš–ï¸',
                'report': 'ğŸ“Š',
                'article': 'ğŸ“°'
            };
            
            const typeName = {
                'form': 'ì…ë ¥ ì–‘ì‹',
                'application': 'ì‹ ì²­ì„œ',
                'contract': 'ê³„ì•½ì„œ',
                'legal': 'ë²•ë¥  ë¬¸ì„œ',
                'report': 'ë³´ê³ ì„œ',
                'article': 'ê¸°ì‚¬/ë¬¸ì„œ'
            };
            
            const confidence = Math.round((analysis.confidence || 0.8) * 100);
            
            resultDiv.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-white flex items-center">
                        <span class="text-2xl mr-2">ğŸ§ </span>
                        AI ë¬¸ì„œ ë¶„ì„ ê²°ê³¼
                    </h4>
                    <div class="text-sm text-white/60">ì‹ ë¢°ë„: ${confidence}%</div>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-white/10 rounded-lg">
                    <span class="text-3xl">${typeEmoji[analysis.document_type] || 'ğŸ“„'}</span>
                    <div>
                        <div class="text-white font-medium">${typeName[analysis.document_type] || 'ì¼ë°˜ ë¬¸ì„œ'}</div>
                        <div class="text-white/70 text-sm">${analysis.description || 'AIê°€ ë¬¸ì„œ í˜•íƒœë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.'}</div>
                    </div>
                </div>
                ${analysis.form_fields ? `
                    <div class="mt-3 p-2 bg-yellow-500/20 rounded-lg">
                        <div class="text-yellow-300 text-sm font-medium">ê°ì§€ëœ ì…ë ¥ í•„ë“œ: ${analysis.form_fields.length}ê°œ</div>
                    </div>
                ` : ''}
            `;
            
            // í¸ì§‘ê¸° ì•ì— ì‚½ì…
            const editorTitle = editorContainer.querySelector('h3');
            if (editorTitle) {
                editorTitle.parentNode.insertBefore(resultDiv, editorTitle);
            }
        }
        
        /**
         * í¼ í•„ë“œê°€ ê°•ì¡°ëœ ì—°ì† ë³´ê¸° í‘œì‹œ
         */
        function displayContinuousViewWithFormHighlights(data, analysis) {
            if (!extractedData || !extractedData.pages) return;
            
            let combinedContent = '';
            extractedData.pages.forEach((page, index) => {
                combinedContent += `<div class="page-break" data-page="${index + 1}">`;
                combinedContent += `<div class="page-header text-xs text-gray-400 mb-2 border-b border-gray-600 pb-1">í˜ì´ì§€ ${index + 1}</div>`;
                
                // í¼ í•„ë“œ ê°•ì¡° ì²˜ë¦¬
                let pageContent = page.content || '';
                pageContent = highlightFormFields(pageContent, analysis.form_fields);
                
                combinedContent += pageContent;
                combinedContent += '</div>';
                if (index < extractedData.pages.length - 1) {
                    combinedContent += '<div class="page-divider my-4 border-t border-gray-600"></div>';
                }
            });
            
            // Quill í¸ì§‘ê¸°ì— ë‚´ìš© ì„¤ì •
            if (window.quillEditor) {
                quillEditor.root.innerHTML = combinedContent;
            }
            
            // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ í‘œì‹œ
            showPageNavigation();
        }
        
        /**
         * í…ìŠ¤íŠ¸ì—ì„œ í¼ í•„ë“œ ê°•ì¡°
         */
        function highlightFormFields(content, formFields) {
            if (!formFields || formFields.length === 0) return content;
            
            let highlightedContent = content;
            
            // ì¼ë°˜ì ì¸ í¼ íŒ¨í„´ë“¤ì„ ê°•ì¡°
            const formPatterns = [
                { pattern: /\[[\s]*\]/g, className: 'form-field-empty' },
                { pattern: /____+/g, className: 'form-field-underline' },
                { pattern: /\([\s]*\)/g, className: 'form-field-brackets' },
                { pattern: /ï¼š[\s]*$/gm, className: 'form-field-colon' },
                { pattern: /:\s*$/gm, className: 'form-field-colon' }
            ];
            
            formPatterns.forEach(({ pattern, className }) => {
                highlightedContent = highlightedContent.replace(pattern, (match) => {
                    return `<span class="${className} bg-yellow-200 border border-yellow-400 px-1 rounded">${match}</span>`;
                });
            });
            
            return highlightedContent;
        }
        
        /**
         * í¼ í•„ë“œ ê°ì§€ ë° ê°•ì¡° (í›„ì²˜ë¦¬)
         */
        function detectAndHighlightFormFields() {
            console.log('ğŸ” í¼ í•„ë“œ ê°ì§€ ë° ê°•ì¡° ì‹¤í–‰');
            
            // í¸ì§‘ê¸°ì—ì„œ ë¹ˆ í•„ë“œë“¤ ê°ì§€
            const editor = document.querySelector('#editor .ql-editor');
            if (!editor) return;
            
            // ë¹ˆ í•„ë“œ ìŠ¤íƒ€ì¼ ì¶”ê°€
            const style = document.createElement('style');
            style.innerHTML = `
                .form-field-empty { 
                    background-color: rgba(255, 235, 59, 0.3) !important; 
                    border: 1px dashed #ffeb3b !important; 
                    padding: 2px 4px !important; 
                    border-radius: 3px !important;
                    cursor: pointer !important;
                }
                .form-field-underline { 
                    background-color: rgba(255, 193, 7, 0.3) !important; 
                    border-bottom: 2px solid #ffc107 !important; 
                    cursor: pointer !important;
                }
                .form-field-brackets { 
                    background-color: rgba(76, 175, 80, 0.3) !important; 
                    border: 1px solid #4caf50 !important; 
                    border-radius: 3px !important;
                    cursor: pointer !important;
                }
                .form-field-colon { 
                    background-color: rgba(33, 150, 243, 0.3) !important; 
                    border-left: 3px solid #2196f3 !important; 
                    padding-left: 4px !important;
                    cursor: pointer !important;
                }
            `;
            document.head.appendChild(style);
            
            // í¼ í•„ë“œ í´ë¦­ ì‹œ ìë™ ì±„ìš°ê¸° ì œì•ˆ
            const formFields = editor.querySelectorAll('.form-field-empty, .form-field-underline, .form-field-brackets, .form-field-colon');
            formFields.forEach((field, index) => {
                field.addEventListener('click', () => {
                    console.log(`ğŸ“ í¼ í•„ë“œ ${index + 1} í´ë¦­ë¨`);
                    suggestAutoFill(field);
                });
            });
            
            if (formFields.length > 0) {
                notify.success(`ğŸ“ ${formFields.length}ê°œì˜ ì…ë ¥ í•„ë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ë“œë¥¼ í´ë¦­í•˜ë©´ ìë™ ì±„ìš°ê¸°ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.`);
            }
        }
        
        /**
         * íŠ¹ì • í•„ë“œì— ëŒ€í•œ ìë™ ì±„ìš°ê¸° ì œì•ˆ
         */
        function suggestAutoFill(fieldElement) {
            // ê°„ë‹¨í•œ íˆ´íŒ í‘œì‹œ
            const tooltip = document.createElement('div');
            tooltip.className = 'absolute z-50 bg-gray-800 text-white text-xs px-2 py-1 rounded shadow-lg';
            tooltip.textContent = 'ì´ í•„ë“œë¥¼ ìë™ìœ¼ë¡œ ì±„ìš°ë ¤ë©´ AI ìë™ ì±„ìš°ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”';
            
            document.body.appendChild(tooltip);
            
            const rect = fieldElement.getBoundingClientRect();
            tooltip.style.top = `${rect.bottom + 5}px`;
            tooltip.style.left = `${rect.left}px`;
            
            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                tooltip.remove();
            }, 3000);
        }
        
        function showViewModeSelector() {
            const editorContainer = document.querySelector('.lg\\:col-span-3');
            
            const viewModeSelector = document.createElement('div');
            viewModeSelector.id = 'viewModeSelector';
            viewModeSelector.className = 'mb-4 p-4 glassmorphism rounded-xl';
            viewModeSelector.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-white flex items-center">
                        <span class="text-2xl mr-2">ğŸ‘ï¸</span>
                        ë³´ê¸° ëª¨ë“œ ì„ íƒ
                    </h4>
                    <div class="text-sm text-white/60">${extractedData.pages.length}í˜ì´ì§€</div>
                </div>
                <div class="flex gap-3">
                    <button onclick="switchViewMode('continuous')" 
                            id="continuousBtn" 
                            class="flex-1 view-mode-btn active bg-blue-500/20 text-blue-300 border border-blue-400/30 py-2 px-4 rounded-lg transition-all hover:bg-blue-500/30">
                        <div class="flex items-center justify-center space-x-2">
                            <span>ğŸ“„</span>
                            <span class="font-medium">ì—°ì† ë³´ê¸°</span>
                        </div>
                        <div class="text-xs opacity-75 mt-1">Word ë¬¸ì„œì²˜ëŸ¼ ì„¸ë¡œë¡œ</div>
                    </button>
                    <button onclick="switchViewMode('paged')" 
                            id="pagedBtn" 
                            class="flex-1 view-mode-btn bg-white/10 text-white/70 border border-white/20 py-2 px-4 rounded-lg transition-all hover:bg-white/20">
                        <div class="flex items-center justify-center space-x-2">
                            <span>ğŸ“–</span>
                            <span class="font-medium">í˜ì´ì§€ ë³´ê¸°</span>
                        </div>
                        <div class="text-xs opacity-75 mt-1">í•œ í˜ì´ì§€ì”© ë³´ê¸°</div>
                    </button>
                </div>
            `;
            
            // í¸ì§‘ê¸° ì•ì— ì‚½ì…
            const editorTitle = document.querySelector('#editorArea h3');
            if (editorTitle) {
                editorTitle.parentNode.insertBefore(viewModeSelector, editorTitle);
            }
        }
        
        function switchViewMode(mode) {
            currentViewMode = mode;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-500/20', 'text-blue-300', 'border-blue-400/30');
                btn.classList.add('bg-white/10', 'text-white/70', 'border-white/20');
            });
            
            const activeBtn = mode === 'continuous' ? 
                document.getElementById('continuousBtn') : 
                document.getElementById('pagedBtn');
                
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-500/20', 'text-blue-300', 'border-blue-400/30');
                activeBtn.classList.remove('bg-white/10', 'text-white/70', 'border-white/20');
            }
            
            // ë³´ê¸° ëª¨ë“œì— ë”°ë¼ ë‚´ìš© í‘œì‹œ
            if (mode === 'continuous') {
                displayContinuousView();
            } else {
                displayPagedView();
            }
        }
        
        function displayContinuousView() {
            if (!extractedData || !extractedData.pages) return;
            
            let combinedContent = '';
            extractedData.pages.forEach((page, index) => {
                combinedContent += `<div class="page-break" data-page="${index + 1}">`;
                combinedContent += `<div class="page-header text-xs text-gray-400 mb-2 border-b border-gray-600 pb-1">í˜ì´ì§€ ${index + 1}</div>`;
                combinedContent += page.content || '';
                combinedContent += '</div>';
                if (index < extractedData.pages.length - 1) {
                    combinedContent += '<div class="page-divider my-4 border-t border-gray-600"></div>';
                }
            });
            
            // Quill í¸ì§‘ê¸°ì— ë‚´ìš© ì„¤ì •
            if (window.quill) {
                quill.root.innerHTML = combinedContent;
            }
            
            // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ í‘œì‹œ
            showPageNavigation();
        }
        
        function displayPagedView() {
            if (!extractedData || !extractedData.pages) return;
            
            const page = extractedData.pages[currentPage - 1];
            if (page) {
                // Quill í¸ì§‘ê¸°ì— í˜„ì¬ í˜ì´ì§€ ë‚´ìš© ì„¤ì •
                if (window.quill) {
                    quill.root.innerHTML = page.content || '';
                }
            }
            
            // í˜ì´ì§€ ì»¨íŠ¸ë¡¤ëŸ¬ í‘œì‹œ
            showPageController();
        }
        
        function showPageNavigation() {
            // VSCode ìŠ¤íƒ€ì¼ì˜ í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ (ìš°ì¸¡ ìƒë‹¨)
            const editorContainer = document.querySelector('#editorArea');
            if (!editorContainer || !extractedData) return;
            
            const existingNav = document.getElementById('pageNavigation');
            if (existingNav) existingNav.remove();
            
            const navigation = document.createElement('div');
            navigation.id = 'pageNavigation';
            navigation.className = 'fixed top-20 right-4 z-30 glassmorphism rounded-lg p-2 max-h-80 overflow-y-auto';
            navigation.innerHTML = `
                <div class="text-xs text-white/80 mb-2 font-semibold">í˜ì´ì§€ ì´ë™</div>
                <div class="space-y-1">
                    ${extractedData.pages.map((page, index) => `
                        <button onclick="scrollToPage(${index + 1})" 
                                class="block w-full text-left px-2 py-1 text-xs text-white/70 hover:bg-white/20 rounded transition-all">
                            ${index + 1}í˜ì´ì§€
                        </button>
                    `).join('')}
                </div>
            `;
            
            document.body.appendChild(navigation);
        }
        
        function showPageController() {
            const editorContainer = document.querySelector('#editorArea');
            if (!editorContainer || !extractedData) return;
            
            const existingController = document.getElementById('pageController');
            if (existingController) existingController.remove();
            
            const controller = document.createElement('div');
            controller.id = 'pageController';
            controller.className = 'mb-4 flex items-center justify-between p-3 glassmorphism rounded-lg';
            controller.innerHTML = `
                <button onclick="previousPage()" 
                        ${currentPage <= 1 ? 'disabled' : ''}
                        class="flex items-center space-x-2 px-3 py-2 bg-blue-500/20 text-blue-300 rounded-lg transition-all hover:bg-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>â†</span>
                    <span>ì´ì „</span>
                </button>
                
                <div class="flex items-center space-x-4">
                    <span class="text-white/80">í˜ì´ì§€</span>
                    <input type="number" 
                           id="pageInput" 
                           value="${currentPage}" 
                           min="1" 
                           max="${extractedData.pages.length}"
                           onchange="goToPage(this.value)"
                           class="w-16 px-2 py-1 bg-white/10 text-white rounded border border-white/20 text-center">
                    <span class="text-white/60">/ ${extractedData.pages.length}</span>
                </div>
                
                <button onclick="nextPage()" 
                        ${currentPage >= extractedData.pages.length ? 'disabled' : ''}
                        class="flex items-center space-x-2 px-3 py-2 bg-blue-500/20 text-blue-300 rounded-lg transition-all hover:bg-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>ë‹¤ìŒ</span>
                    <span>â†’</span>
                </button>
            `;
            
            const quillContainer = document.querySelector('#editor');
            if (quillContainer) {
                quillContainer.parentNode.insertBefore(controller, quillContainer);
            }
        }
        
        function initializePageNavigation() {
            // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            if (currentViewMode === 'continuous') {
                showPageNavigation();
            } else {
                showPageController();
            }
        }
        
        function scrollToPage(pageNumber) {
            if (currentViewMode === 'continuous') {
                const pageElement = document.querySelector(`[data-page="${pageNumber}"]`);
                if (pageElement) {
                    pageElement.scrollIntoView({ behavior: 'smooth' });
                }
            }
        }
        
        function goToPage(pageNumber) {
            const page = parseInt(pageNumber);
            if (page >= 1 && page <= extractedData.pages.length) {
                currentPage = page;
                if (currentViewMode === 'paged') {
                    displayPagedView();
                }
            }
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayPagedView();
            }
        }
        
        function nextPage() {
            if (currentPage < extractedData.pages.length) {
                currentPage++;
                displayPagedView();
            }
        }
        
        
        function clearDocument() {
            selectedDocument = null;
            document.getElementById('documentInfo').classList.add('hidden');
            document.getElementById('documentInput').value = '';
            moveToStep(1);
        }
        
        // === ì°¸ê³ ìë£Œ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
        
        function handleReferenceDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            for (let i = 0; i < files.length; i++) {
                addReferenceFile(files[i]);
            }
        }
        
        function handleReferenceSelect(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                addReferenceFile(files[i]);
            }
        }
        
        function addReferenceFile(file) {
            if (referenceDocuments.find(doc => doc.name === file.name)) {
                showNotification('ì´ë¯¸ ì¶”ê°€ëœ íŒŒì¼ì…ë‹ˆë‹¤.', 'warning');
                return;
            }
            
            referenceDocuments.push(file);
            displayReferenceList();
        }
        
        function displayReferenceList() {
            const list = document.getElementById('referenceList');
            list.innerHTML = '';
            
            referenceDocuments.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 bg-green-50 rounded border border-green-200';
                item.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-sm">ğŸ“š</span>
                        <div>
                            <div class="text-xs font-medium text-green-800">${file.name}</div>
                            <div class="text-xs text-green-600">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button onclick="removeReference(${index})" class="text-red-500 hover:text-red-700 text-xs">âŒ</button>
                `;
                list.appendChild(item);
            });
        }
        
        function removeReference(index) {
            referenceDocuments.splice(index, 1);
            displayReferenceList();
        }
        
        // === ë‹¨ê³„ë³„ ê°€ì´ë“œ ì‹œìŠ¤í…œ (Step-by-Step Guide System) ===
        
        /**
         * ë‹¨ê³„ë³„ UI ìƒíƒœ ê´€ë¦¬ í´ë˜ìŠ¤
         */
        class StepGuideManager {
            constructor() {
                this.currentStep = 1;
                this.maxUnlockedStep = 1;
                this.stepSections = {
                    1: 'uploadSection',
                    2: 'extractionSection', 
                    3: 'referenceSection',
                    4: 'aiToolsSection'
                };
                
                this.stepIndicators = {
                    1: 'step1',
                    2: 'step2',
                    3: 'step3', 
                    4: 'step4'
                };
                
                this.init();
            }
            
            /**
             * ë‹¨ê³„ë³„ ê°€ì´ë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
             */
            init() {
                this.updateAllSteps();
                this.addStepClickHandlers();
            }
            
            /**
             * íŠ¹ì • ë‹¨ê³„ë¡œ ì´ë™ (ì¡°ê±´ë¶€)
             * @param {number} targetStep - ì´ë™í•  ë‹¨ê³„
             * @param {boolean} forceUnlock - ê°•ì œ ì ê¸ˆ í•´ì œ ì—¬ë¶€
             */
            moveToStep(targetStep, forceUnlock = false) {
                if (targetStep > this.maxUnlockedStep && !forceUnlock) {
                    notify.warning(`${targetStep}ë‹¨ê³„ëŠ” ì´ì „ ë‹¨ê³„ ì™„ë£Œ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    return false;
                }
                
                this.currentStep = targetStep;
                
                // ì „ì—­ currentStepë„ ë™ê¸°í™”
                currentStep = targetStep;
                
                this.updateAllSteps();
                
                // ë‹¨ê³„ë³„ íŠ¹ë³„ ì²˜ë¦¬
                this.handleStepSpecialActions(targetStep);
                
                // ë‹¨ê³„ ì´ë™ ì‹œ ìŠ¤í¬ë¡¤
                const targetSection = document.getElementById(this.stepSections[targetStep]);
                if (targetSection) {
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return true;
            }
            
            /**
             * ë‹¨ê³„ë³„ íŠ¹ë³„ ì•¡ì…˜ ì²˜ë¦¬
             * @param {number} step - í˜„ì¬ ë‹¨ê³„
             */
            handleStepSpecialActions(step) {
                switch (step) {
                    case 2:
                        // 2ë‹¨ê³„: ì¶”ì¶œ ì‹œì‘ ë²„íŠ¼ ì¶”ê°€
                        setTimeout(() => {
                            if (selectedDocument && !document.getElementById('startExtractionBtn')) {
                                addStartExtractionButton();
                            }
                        }, 500);
                        break;
                    case 4:
                        // 4ë‹¨ê³„: AI ë„êµ¬ í™œì„±í™” ì•ˆë‚´
                        setTimeout(() => {
                            notify.info('ğŸ¤– AI í¸ì§‘ ë„êµ¬ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ê³  ì›í•˜ëŠ” í¸ì§‘ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.');
                        }, 500);
                        break;
                }
            }
            
            /**
             * ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬
             * @param {number} step - ì™„ë£Œëœ ë‹¨ê³„
             */
            completeStep(step) {
                if (step === this.maxUnlockedStep) {
                    this.maxUnlockedStep = Math.min(4, step + 1);
                }
                
                this.updateStepIndicator(step, 'completed');
                this.updateAllSteps();
                
                // ë‹¤ìŒ ë‹¨ê³„ ìë™ ì•ˆë‚´
                if (step < 4) {
                    setTimeout(() => {
                        notify.info(`${step + 1}ë‹¨ê³„ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì„¸ìš”.`);
                    }, 500);
                }
            }
            
            /**
             * ë‹¨ê³„ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
             * @param {number} step - ë‹¨ê³„ ë²ˆí˜¸
             * @param {string} status - ìƒíƒœ (active, completed, pending, locked)
             */
            updateStepIndicator(step, status) {
                const indicator = document.getElementById(this.stepIndicators[step]);
                if (!indicator) return;
                
                indicator.className = 'step-indicator';
                
                switch (status) {
                    case 'active':
                        indicator.classList.add('active');
                        break;
                    case 'completed':
                        indicator.classList.add('completed');
                        break;
                    case 'pending':
                        indicator.classList.add('pending');
                        break;
                    case 'locked':
                        indicator.classList.add('locked');
                        break;
                }
            }
            
            /**
             * ì„¹ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
             * @param {number} step - ë‹¨ê³„ ë²ˆí˜¸
             * @param {string} status - ìƒíƒœ (active, completed, locked)
             */
            updateSectionStatus(step, status) {
                const section = document.getElementById(this.stepSections[step]);
                if (!section) return;
                
                section.classList.remove('opacity-50', 'opacity-25', 'pointer-events-none');
                
                switch (status) {
                    case 'active':
                        // í™œì„± ìƒíƒœ: ì™„ì „íˆ ì‚¬ìš© ê°€ëŠ¥
                        break;
                    case 'completed':
                        // ì™„ë£Œ ìƒíƒœ: ì•½ê°„ íë¦¬ê²Œ í•˜ì§€ë§Œ ì ‘ê·¼ ê°€ëŠ¥
                        section.classList.add('opacity-75');
                        break;
                    case 'locked':
                        // ì ê¸ˆ ìƒíƒœ: íë¦¬ê²Œ í•˜ê³  í´ë¦­ ì°¨ë‹¨
                        section.classList.add('opacity-25', 'pointer-events-none');
                        break;
                }
            }
            
            /**
             * ëª¨ë“  ë‹¨ê³„ ìƒíƒœ ì—…ë°ì´íŠ¸
             */
            updateAllSteps() {
                for (let step = 1; step <= 4; step++) {
                    let status = 'locked';
                    
                    if (step < this.maxUnlockedStep) {
                        status = 'completed';
                    } else if (step === this.maxUnlockedStep) {
                        status = step === this.currentStep ? 'active' : 'pending';
                    }
                    
                    this.updateStepIndicator(step, status);
                    this.updateSectionStatus(step, step <= this.maxUnlockedStep ? 
                        (step === this.currentStep ? 'active' : 'completed') : 'locked');
                }
            }
            
            /**
             * ë‹¨ê³„ í´ë¦­ í•¸ë“¤ëŸ¬ ì¶”ê°€
             */
            addStepClickHandlers() {
                for (let step = 1; step <= 4; step++) {
                    const indicator = document.getElementById(this.stepIndicators[step]);
                    if (indicator) {
                        indicator.style.cursor = 'pointer';
                        indicator.addEventListener('click', () => {
                            this.moveToStep(step);
                        });
                    }
                }
            }
        }
        
        // ì „ì—­ ë‹¨ê³„ ê´€ë¦¬ì ì¸ìŠ¤í„´ìŠ¤
        let stepGuide = null;

        // === ë‹¨ê³„ ê´€ë¦¬ ===
        
        // ê¸°ì¡´ moveToStep í•¨ìˆ˜ë¥¼ StepGuideManagerë¡œ ë˜í•‘
        function moveToStep(step) {
            if (stepGuide) {
                return stepGuide.moveToStep(step);
            }
            
            // í´ë°±: ê¸°ì¡´ ë¡œì§ (stepGuideê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš°)
            currentStep = step;
            console.warn('StepGuideManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ê¸°ì¡´ ë¡œì§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
        }
        
        function addStartExtractionButton() {
            const referenceSection = document.getElementById('referenceSection');
            
            // ê¸°ì¡´ ë²„íŠ¼ì´ ìˆìœ¼ë©´ ì œê±°
            const existingBtn = document.getElementById('startExtractionBtn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            const button = document.createElement('button');
            button.id = 'startExtractionBtn';
            button.className = 'w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105';
            button.innerHTML = 'ğŸš€ ë¬¸ì„œ ì¶”ì¶œ ì‹œì‘';
            button.onclick = () => {
                // 3ë‹¨ê³„ í™œì„±í™”
                if (stepGuide) {
                    stepGuide.completeStep(2); // 2ë‹¨ê³„ ì™„ë£Œ
                    stepGuide.moveToStep(3);   // 3ë‹¨ê³„ë¡œ ì´ë™
                }
                
                // ì‹¤ì œ ì¶”ì¶œ ì‹œì‘
                startExtraction();
            };
            referenceSection.appendChild(button);
        }
        
        // === AI ëª¨ë¸ ê´€ë¦¬ í•¨ìˆ˜ (AI Model Management Functions) ===
        
        /**
         * í˜„ì¬ ì„ íƒëœ AI ëª¨ë¸ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
         * @returns {string} - ì„ íƒëœ AI ëª¨ë¸ëª…
         */
        function getSelectedAIModel() {
            const selectedModel = document.querySelector('input[name="aiModel"]:checked');
            return selectedModel ? selectedModel.value : 'gemini'; // ê¸°ë³¸ê°’: gemini
        }
        
        /**
         * AI ëª¨ë¸ë³„ í‘œì‹œ ì´ë¦„ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
         * @param {string} modelValue - ëª¨ë¸ ê°’
         * @returns {string} - í‘œì‹œ ì´ë¦„
         */
        function getAIModelDisplayName(modelValue) {
            const modelNames = {
                'gemini': 'Google Gemini',
                'gpt-4': 'OpenAI GPT-4', 
                'claude': 'Anthropic Claude',
                'perplexity': 'Perplexity AI',
                'clova': 'ë„¤ì´ë²„ í´ë¡œë°”X'
            };
            return modelNames[modelValue] || modelValue;
        }

        // === ë¬¸ì„œ ì¶”ì¶œ ë° AI ì²˜ë¦¬ ===
        
        async function startExtraction() {
            if (!selectedDocument) {
                showNotification('ë¬¸ì„œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const extractionType = document.querySelector('input[name="extractionType"]:checked').value;
            const button = document.getElementById('startExtractionBtn');
            const originalText = button.textContent;
            
            button.textContent = 'ğŸ”„ ì¶”ì¶œ ì¤‘...';
            button.disabled = true;
            
            updateAIStatus('processing');
            
            try {
                // FormData ìƒì„± (Form Data Creation)
                const formData = new FormData();
                const selectedAIModel = getSelectedAIModel(); // ì„ íƒëœ AI ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°
                
                formData.append('file', selectedDocument);
                formData.append('model', selectedAIModel); // ì‚¬ìš©ì ì„ íƒ ëª¨ë¸
                formData.append('tasks', JSON.stringify([extractionType]));
                formData.append('output_format', 'markdown');
                
                console.log(`ğŸ“„ ë¬¸ì„œ ì¶”ì¶œ ì‹œì‘ - ëª¨ë¸: ${getAIModelDisplayName(selectedAIModel)}, ë°©ì‹: ${extractionType}`);
                
                // ì°¸ê³ ìë£Œê°€ ìˆìœ¼ë©´ ì¶”ê°€
                if (referenceDocuments.length > 0) {
                    const referenceTexts = [];
                    for (const refFile of referenceDocuments) {
                        // ì°¸ê³ ìë£Œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜)
                        referenceTexts.push(`[ì°¸ê³ ìë£Œ: ${refFile.name}]`);
                    }
                    formData.append('reference_text', referenceTexts.join('\n\n'));
                }
                
                // API í˜¸ì¶œ
                const response = await fetch(`${API_BASE}/ai-edit/process-multipart`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // í¸ì§‘ê¸°ì— ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ì‚½ì…
                    insertExtractedText(result.data.edited_text);
                    
                    // ë‹¨ê³„ë³„ ê°€ì´ë“œ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
                    if (stepGuide) {
                        stepGuide.completeStep(3); // 3ë‹¨ê³„ ì™„ë£Œ
                        stepGuide.moveToStep(4);   // 4ë‹¨ê³„ë¡œ ì´ë™
                    }
                    
                    updateAIStatus('ready');
                    notify.success('ë¬¸ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ì¶œë˜ì–´ í¸ì§‘ê¸°ì— ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ AI í¸ì§‘ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.');
                } else {
                    throw new Error(result.error || 'ì¶”ì¶œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('âŒ ë¬¸ì„œ ì¶”ì¶œ ì˜¤ë¥˜:', error);
                showNotification(`ì¶”ì¶œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
                updateAIStatus('error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        function insertExtractedText(text) {
            // Quill í¸ì§‘ê¸°ì— í…ìŠ¤íŠ¸ ì‚½ì…
            quillEditor.root.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© í´ë¦¬ì–´
            quillEditor.clipboard.dangerouslyPasteHTML(0, text);
            updateWordCount();
        }
        
        // === AI í¸ì§‘ ë„êµ¬ ===
        
        // aiEnhance ë° getTaskName í•¨ìˆ˜ë“¤ì€ ai-functions.js ëª¨ë“ˆë¡œ ì´ë™ë¨
        
        // === ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ===
        
        function updateWordCount() {
            const text = quillEditor.getText();
            const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const chars = text.length;
            
            document.getElementById('wordCount').textContent = `ë‹¨ì–´: ${words}`;
            document.getElementById('charCount').textContent = `ê¸€ì: ${chars}`;
        }
        
        function updateAIStatus(status) {
            const statusEl = document.getElementById('aiStatus');
            const statusConfig = {
                'ready': { color: 'bg-green-400', text: 'AI ì¤€ë¹„ë¨' },
                'processing': { color: 'bg-blue-400 animate-pulse', text: 'AI ì²˜ë¦¬ ì¤‘' },
                'editing': { color: 'bg-yellow-400', text: 'í¸ì§‘ ì¤‘' },
                'error': { color: 'bg-red-400', text: 'AI ì˜¤ë¥˜' }
            };
            
            const config = statusConfig[status] || { color: 'bg-gray-400', text: 'AI ëŒ€ê¸°' };
            statusEl.innerHTML = `
                <div class="w-2 h-2 ${config.color} rounded-full"></div>
                <span>${config.text}</span>
            `;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showNotification(message, type = 'info') {
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]}/90 backdrop-blur-sm text-white p-4 rounded-2xl z-50 max-w-md animate-slide-up border`;
            notification.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="text-2xl">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}</div>
                    <div class="flex-1">
                        <div class="text-sm">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="text-white/80 hover:text-white transition-colors">âœ•</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // ë“œë˜ê·¸ ì˜¤ë²„ í•¸ë“¤ëŸ¬ë“¤
        function handleDragOver(event) {
            event.preventDefault();
        }
        
        function handleDragEnter(event) {
            event.preventDefault();
            event.currentTarget.classList.add('border-blue-400');
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            if (!event.currentTarget.contains(event.relatedTarget)) {
                event.currentTarget.classList.remove('border-blue-400');
            }
        }
        
        // === ë¬¸ì„œ ì €ì¥ ë° ë‚´ë³´ë‚´ê¸° ===
        
        function saveDocument() {
            try {
                if (!quillEditor) {
                    throw new Error('í¸ì§‘ê¸°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                const content = quillEditor.root.innerHTML;
                const timestamp = new Date().toISOString();
                
                // ì„±ëŠ¥ ìµœì í™”: êµ¬ì¡°í™”ëœ ë°ì´í„°ë¡œ ì €ì¥
                const saveData = {
                    content: content,
                    timestamp: timestamp,
                    wordCount: getWordCount(content),
                    version: '2.0',
                    metadata: {
                        lastModified: timestamp,
                        fileSize: new Blob([content]).size
                    }
                };
                
                localStorage.setItem('paperwork_document', JSON.stringify(saveData));
                
                // ìë™ ë°±ì—… (ìµœëŒ€ 3ê°œ ë³´ê´€)
                createAutoBackup(saveData);
                
                document.getElementById('lastSaved').textContent = `ì €ì¥: ${new Date().toLocaleTimeString()}`;
                showNotification('ë¬¸ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                // ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
                logPerformanceMetrics();
                
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                showNotification('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        function createAutoBackup(saveData) {
            try {
                const backups = JSON.parse(localStorage.getItem('paperwork_backups') || '[]');
                backups.unshift(saveData);
                
                // ìµœëŒ€ 3ê°œ ë°±ì—… ìœ ì§€
                if (backups.length > 3) {
                    backups.splice(3);
                }
                
                localStorage.setItem('paperwork_backups', JSON.stringify(backups));
            } catch (error) {
                console.warn('ë°±ì—… ìƒì„± ì‹¤íŒ¨:', error);
            }
        }

        function getWordCount(content) {
            const text = content.replace(/<[^>]*>/g, '').trim();
            return text ? text.split(/\s+/).length : 0;
        }

        function logPerformanceMetrics() {
            if (performance && performance.memory) {
                const memory = performance.memory;
                console.log('ğŸ” ì„±ëŠ¥ ë©”íŠ¸ë¦­:', {
                    usedJSHeapSize: Math.round(memory.usedJSHeapSize / 1024 / 1024) + 'MB',
                    totalJSHeapSize: Math.round(memory.totalJSHeapSize / 1024 / 1024) + 'MB',
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        function exportDocument() {
            const content = quillEditor.getText();
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `document_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('ë¬¸ì„œê°€ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë¬¸ì„œ ë³µì›
        document.addEventListener('DOMContentLoaded', function() {
            const savedContent = localStorage.getItem('paperwork_document');
            if (savedContent) {
                setTimeout(() => {
                    quillEditor.root.innerHTML = savedContent;
                    updateWordCount();
                }, 500);
            }
        });
        
        console.log('âœ… AI ë¬¸ì„œ í¸ì§‘ê¸° JavaScript ë¡œë“œ ì™„ë£Œ');
        
        // Mobile Sidebar Toggle
        document.getElementById("mobileSidebarToggle")?.addEventListener("click", function() {
            const sidebar = document.getElementById("mobileSidebar");
            const toggleIcon = document.getElementById("toggleIcon");
            
            if (sidebar.classList.contains("hidden")) {
                sidebar.classList.remove("hidden");
                sidebar.classList.add("block");
                toggleIcon.style.transform = "rotate(180deg)";
            } else {
                sidebar.classList.add("hidden");
                sidebar.classList.remove("block");
                toggleIcon.style.transform = "rotate(0deg)";
            }
        });

        // === AI Auto-fill ìë™ ì±„ìš°ê¸° ì‹œìŠ¤í…œ ===

        /**
         * ë¹ˆ í•„ë“œ ê°ì§€ ë° ìë™ ì±„ìš°ê¸° ì‹œì‘
         */
        function detectAndFillBlankFields() {
            const content = quillEditor.getText();
            
            if (!content.trim()) {
                notify.warning('í¸ì§‘ê¸°ì— ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¬¸ì„œë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const blankFields = analyzeBlankFields(content);
            
            if (blankFields.length === 0) {
                notify.info('ê°ì§€ëœ ë¹ˆ í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë¬¸ì„œê°€ ì´ë¯¸ ì™„ì„±ëœ ê²ƒ ê°™ìŠµë‹ˆë‹¤! âœ…');
                return;
            }

            showAutoFillModal(blankFields);
        }

        /**
         * ë¹ˆ í•„ë“œ ë¶„ì„
         * @param {string} content - ë¶„ì„í•  í…ìŠ¤íŠ¸ ë‚´ìš©
         * @returns {Array} ë¹ˆ í•„ë“œ ë°°ì—´
         */
        function analyzeBlankFields(content) {
            const blankPatterns = [
                /\[.*?\]/g,                    // [ë¹ˆì¹¸] í˜•íƒœ
                /____+/g,                      // ì—°ì†ëœ ë°‘ì¤„
                /_+_+_+/g,                     // ìµœì†Œ 3ê°œ ì´ìƒì˜ ì–¸ë”ìŠ¤ì½”ì–´
                /\.\.\./g,                     // ... (ìƒëµ í‘œì‹œ)
                /\([\s]*\)/g,                  // ë¹ˆ ê´„í˜¸ ()
                /ï¼š[\s]*$/gm,                   // ì½œë¡  ë’¤ ë¹ˆ ì¤„
                /:\s*$/gm,                     // ì˜ë¬¸ ì½œë¡  ë’¤ ë¹ˆ ì¤„
                /^\s*-\s*$/gm,                 // ë¹ˆ ë¶ˆë¦¿ í¬ì¸íŠ¸
                /TBD|TBC|TODO/gi,              // To Be Determined/Completed/TODO
                /ë¯¸ì •|ì¶”í›„|ë‚˜ì¤‘ì—|ë³´ì™„í•„ìš”/g           // í•œêµ­ì–´ ë¯¸ì™„ì„± í‘œì‹œ
            ];

            const fields = [];
            blankPatterns.forEach((pattern, index) => {
                const matches = content.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        fields.push({
                            pattern: match,
                            type: getFieldType(index),
                            position: content.indexOf(match)
                        });
                    });
                }
            });

            // ì¤‘ë³µ ì œê±° ë° ì •ë ¬
            return fields
                .filter((field, index, self) => 
                    self.findIndex(f => f.position === field.position) === index
                )
                .sort((a, b) => a.position - b.position);
        }

        /**
         * í•„ë“œ ìœ í˜• ë°˜í™˜
         */
        function getFieldType(patternIndex) {
            const types = [
                'ë¸Œë˜í‚· ë¹ˆì¹¸', 'ë°‘ì¤„ ë¹ˆì¹¸', 'ì–¸ë”ìŠ¤ì½”ì–´ ë¹ˆì¹¸', 'ìƒëµ í‘œì‹œ', 
                'ë¹ˆ ê´„í˜¸', 'ì½œë¡  ë¹ˆì¹¸', 'ì˜ë¬¸ ì½œë¡  ë¹ˆì¹¸', 'ë¹ˆ ë¶ˆë¦¿', 
                'ì˜ë¬¸ ë¯¸ì™„ì„±', 'í•œêµ­ì–´ ë¯¸ì™„ì„±'
            ];
            return types[patternIndex] || 'ê¸°íƒ€';
        }

        /**
         * AI Auto-fill ëª¨ë‹¬ í‘œì‹œ
         */
        function showAutoFillModal(blankFields) {
            const modal = document.getElementById('aiAutoFillModal');
            const blankFieldsCount = document.getElementById('blankFieldsCount');
            const referenceStatus = document.getElementById('referenceStatus');
            
            // ë¹ˆ í•„ë“œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            blankFieldsCount.textContent = `${blankFields.length}ê°œ`;
            
            // ì°¸ê³ ìë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (referenceDocuments.length > 0) {
                referenceStatus.textContent = `${referenceDocuments.length}ê°œ íŒŒì¼`;
                referenceStatus.className = 'text-green-400 font-medium';
            } else {
                referenceStatus.textContent = 'ì—†ìŒ';
                referenceStatus.className = 'text-yellow-300 font-medium';
            }
            
            // ë¹ˆ í•„ë“œ ë°ì´í„° ì €ì¥ (ì „ì—­ ë³€ìˆ˜)
            window.currentBlankFields = blankFields;
            
            // ëª¨ë‹¬ í‘œì‹œ
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        /**
         * Auto-fill ëª¨ë‹¬ ì·¨ì†Œ
         */
        function cancelAutoFill() {
            const modal = document.getElementById('aiAutoFillModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            window.currentBlankFields = null;
        }

        /**
         * í‘œì¤€ ëª¨ë“œ ìë™ ì±„ìš°ê¸° ì‹œì‘
         */
        function startAutoFillStandard() {
            cancelAutoFill();
            performAutoFill('standard');
        }

        /**
         * Think Harder ëª¨ë“œ ìë™ ì±„ìš°ê¸° ì‹œì‘  
         */
        function startAutoFillDeep() {
            cancelAutoFill();
            performAutoFill('deep');
        }

        /**
         * ì‹¤ì œ AI ìë™ ì±„ìš°ê¸° ìˆ˜í–‰
         */
        // === AI ì²¨ë¶€íŒŒì¼ ì½ê¸° í—¬í¼ í•¨ìˆ˜ë“¤ ===
        
        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                
                if (file.type.startsWith('text/')) {
                    reader.readAsText(file);
                } else if (file.type.includes('pdf')) {
                    // PDF íŒŒì¼ì€ ë°”ì´ë„ˆë¦¬ë¡œ ì½ì–´ì„œ ë³„ë„ ì²˜ë¦¬
                    reader.readAsArrayBuffer(file);
                } else if (file.type.startsWith('image/')) {
                    // ì´ë¯¸ì§€ íŒŒì¼ì€ ë°ì´í„° URLë¡œ ì½ê¸°
                    reader.readAsDataURL(file);
                } else {
                    // ê¸°íƒ€ íŒŒì¼ì€ í…ìŠ¤íŠ¸ë¡œ ì‹œë„
                    reader.readAsText(file);
                }
            });
        }
        
        async function extractTextFromFile(file, content) {
            try {
                if (file.type.startsWith('text/')) {
                    return content;
                } else if (file.type.includes('pdf')) {
                    // PDFëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ íŒŒì¼ ìì²´ë¥¼ ì „ì†¡
                    return '[PDF íŒŒì¼ - ì„œë²„ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜ˆì •]';
                } else if (file.type.startsWith('image/')) {
                    // ì´ë¯¸ì§€ëŠ” ì„œë²„ì—ì„œ OCR ì²˜ë¦¬í•˜ë„ë¡ ë°ì´í„° URL ì „ì†¡
                    return content; // ë°ì´í„° URLì„ ê·¸ëŒ€ë¡œ ì „ì†¡
                } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    return '[Word ë¬¸ì„œ - ì„œë²„ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜ˆì •]';
                } else {
                    // ê¸°íƒ€ í…ìŠ¤íŠ¸ í˜•íƒœë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•œ íŒŒì¼
                    return content;
                }
            } catch (error) {
                console.warn('íŒŒì¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨:', file.name, error);
                return '[í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨]';
            }
        }
        
        async function processReferenceFiles(files) {
            const processedFiles = [];
            
            uploadProgress.show('ì°¸ê³ ìë£Œ íŒŒì¼ ì²˜ë¦¬ ì¤‘...', `${files.length}ê°œ íŒŒì¼ ë¶„ì„`);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    uploadProgress.show(
                        'ì°¸ê³ ìë£Œ íŒŒì¼ ì²˜ë¦¬ ì¤‘...', 
                        `${i + 1}/${files.length}: ${file.name}`
                    );
                    
                    const content = await readFileContent(file);
                    const extractedText = await extractTextFromFile(file, content);
                    
                    processedFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        content: extractedText,
                        preview: extractedText.length > 500 ? 
                                extractedText.substring(0, 500) + '...' : 
                                extractedText
                    });
                    
                } catch (error) {
                    console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', file.name, error);
                    processedFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        content: '[íŒŒì¼ ì½ê¸° ì‹¤íŒ¨]',
                        preview: '[íŒŒì¼ ì½ê¸° ì‹¤íŒ¨]'
                    });
                }
            }
            
            return processedFiles;
        }

        // performAutoFill í•¨ìˆ˜ëŠ” ai-functions.js ëª¨ë“ˆë¡œ ì´ë™ë¨
        
        // === ğŸ”§ ê°œì„ ëœ ê¸°ëŠ¥ë“¤ ===
        
        // âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì‹œìŠ¤í…œ
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+S: ì €ì¥
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveDocument();
                    return;
                }
                
                // Ctrl+Shift+E: AI í¸ì§‘ ë„êµ¬ ì—´ê¸°
                if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                    e.preventDefault();
                    document.querySelector('button[onclick="aiEnhance(\'enhance\')"]')?.click();
                    return;
                }
                
                // Ctrl+Shift+H: ë„ì›€ë§
                if (e.ctrlKey && e.shiftKey && e.key === 'H') {
                    e.preventDefault();
                    showKeyboardHelp();
                    return;
                }
                
                // ESC: í¬ì»¤ìŠ¤ ê´€ë¦¬
                if (e.key === 'Escape') {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.blur) {
                        activeElement.blur();
                        if (quillEditor) {
                            quillEditor.focus();
                        }
                    }
                }
            });
        }

        function showKeyboardHelp() {
            const helpContent = `
                <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" id="keyboard-help-modal">
                    <div class="bg-white rounded-xl max-w-md p-6 m-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+S</kbd></span>
                                <span>ë¬¸ì„œ ì €ì¥</span>
                            </div>
                            <div class="flex justify-between">
                                <span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+Shift+E</kbd></span>
                                <span>AI í¸ì§‘ ë„êµ¬</span>
                            </div>
                            <div class="flex justify-between">
                                <span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+Shift+H</kbd></span>
                                <span>ë„ì›€ë§ ë³´ê¸°</span>
                            </div>
                            <div class="flex justify-between">
                                <span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">ESC</kbd></span>
                                <span>í¸ì§‘ê¸°ë¡œ í¬ì»¤ìŠ¤</span>
                            </div>
                        </div>
                        <button onclick="closeKeyboardHelp()" class="mt-4 w-full px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', helpContent);
            document.getElementById('keyboard-help-modal').querySelector('button').focus();
        }

        function closeKeyboardHelp() {
            const modal = document.getElementById('keyboard-help-modal');
            if (modal) {
                modal.remove();
            }
        }

        // ğŸ” ì ‘ê·¼ì„± ê°œì„ 
        function enhanceAccessibility() {
            // ARIA ë¼ë²¨ ì¶”ê°€
            const editorContainer = document.querySelector('.ql-editor');
            if (editorContainer) {
                editorContainer.setAttribute('role', 'textbox');
                editorContainer.setAttribute('aria-label', 'ë¬¸ì„œ í¸ì§‘ ì˜ì—­');
                editorContainer.setAttribute('aria-multiline', 'true');
            }
            
            // ì—…ë¡œë“œ ì˜ì—­ ì ‘ê·¼ì„±
            const uploadArea = document.getElementById('upload-area');
            if (uploadArea) {
                uploadArea.setAttribute('role', 'button');
                uploadArea.setAttribute('aria-label', 'íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­');
                uploadArea.setAttribute('tabindex', '0');
            }
            
            // ìƒíƒœ í‘œì‹œ ì˜ì—­
            const statusElements = ['wordCount', 'charCount', 'lastSaved', 'aiStatus'];
            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.setAttribute('role', 'status');
                    element.setAttribute('aria-live', 'polite');
                }
            });
        }

        // ğŸš€ ì´ˆê¸°í™” ë° ì •ë¦¬
        function initializeEnhancedFeatures() {
            setupKeyboardShortcuts();
            enhanceAccessibility();
            
            // ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œì‘
            console.log('ğŸ“ˆ Enhanced Paperwork Editor ì´ˆê¸°í™” ì™„ë£Œ - v2.0');
            if (window.logPerformanceMetrics) {
                logPerformanceMetrics();
            }
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            // ë©”ëª¨ë¦¬ ì •ë¦¬
            if (quillEditor) {
                // Quill ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬ëŠ” Quill ìì²´ì—ì„œ ì²˜ë¦¬
                console.log('ğŸ“‹ í¸ì§‘ê¸° ì •ë¦¬ ì™„ë£Œ');
            }
        });

        // DOMContentLoaded ì´ë²¤íŠ¸ì— ìƒˆë¡œìš´ ê¸°ëŠ¥ë“¤ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', () => {
            // ê¸°ì¡´ ì´ˆê¸°í™” ì™„ë£Œ í›„ ê°œì„ ëœ ê¸°ëŠ¥ë“¤ ì´ˆê¸°í™”
            setTimeout(initializeEnhancedFeatures, 100);
        });
        
    </script>
</body>
</html>
