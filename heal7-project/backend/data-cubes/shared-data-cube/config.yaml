# 🔗 HEAL7 공유 데이터큐브 설정
# 모든 서비스가 공유하는 핵심 데이터 및 인증 시스템

cube_info:
  name: "shared-data-cube"
  version: "2.0.0"
  description: "사용자 관리, 인증, 세션, 전역 설정 등 공통 데이터 관리"
  maintainer: "HEAL7 플랫폼팀"
  created_at: "2024-03-15"
  category: "infrastructure"
  criticality: "high"  # 모든 서비스의 핵심 의존성

# 데이터베이스 설정
database:
  postgresql:
    schema_name: "shared_common"
    description: "사용자, 세션, 전역 설정 등 공통 테이블"
    tables:
      - "users"                    # 사용자 기본 정보
      - "user_sessions"            # 사용자 세션
      - "global_settings"          # 전역 시스템 설정  
      - "user_preferences"         # 사용자 개인설정
      - "audit_logs"              # 감사 로그
    pool_size: 30  # 많은 연결 필요
    max_overflow: 50
    connection_lifetime: 3600
    
  redis:
    db_number: 0  # 기본 DB (가장 중요)
    namespace: "shared_common"
    description: "사용자 세션, JWT 토큰, 전역 캐시"
    key_patterns:
      - "shared_common:user_session:{user_id}"
      - "shared_common:jwt_token:{jti}"
      - "shared_common:global_config"
      - "shared_common:user_cache:{user_id}"
    connection_pool: 25
    default_ttl: 86400  # 1 day
    persistent_keys: true  # 일부 키는 영구 저장
    
  jsonb:
    enabled: false
    reason: "공통 데이터는 정규화된 구조 필요"

# API 인터페이스 설정
interfaces:
  rest_api:
    enabled: true
    port: 8000  # 기본 포트
    prefix: "/api/v1/shared"
    endpoints:
      - "/users"                   # 사용자 관리
      - "/auth"                   # 인증 (로그인/로그아웃)
      - "/sessions"               # 세션 관리
      - "/global-config"          # 전역 설정
      - "/health"                 # 헬스체크
    
  message_queue:
    enabled: true
    topics:
      subscribe:
        - "system.maintenance.start"  # 시스템 점검 시작
        - "system.maintenance.end"    # 시스템 점검 종료
      publish:
        - "user.created"             # 새 사용자 생성
        - "user.updated"             # 사용자 정보 업데이트
        - "user.deleted"             # 사용자 삭제
        - "session.created"          # 세션 생성
        - "session.expired"          # 세션 만료
        - "config.updated"           # 설정 변경
    
  internal_api:
    enabled: true
    description: "다른 큐브들이 직접 호출하는 내부 API"
    authentication: "service_token"

# 사용자 관리 설정
user_management:
  registration:
    enabled: true
    email_verification_required: true
    default_role: "user"
    
  authentication:
    methods: ["email_password", "oauth"]
    password_policy:
      min_length: 8
      require_special_chars: true
      require_numbers: true
      require_uppercase: true
    
    jwt_settings:
      access_token_expiry: 3600    # 1 hour
      refresh_token_expiry: 604800  # 7 days
      algorithm: "HS256"
      
  session_management:
    max_concurrent_sessions: 5
    session_timeout: 86400        # 24 hours
    remember_me_duration: 2592000  # 30 days

# 권한 및 보안 설정
security:
  encryption_enabled: true
  password_hashing: "bcrypt"
  rounds: 12
  
  access_control: "rbac"  # Role-Based Access Control
  default_roles:
    - name: "user"
      permissions: ["read_own_data", "update_own_profile"]
    - name: "premium_user"  
      permissions: ["read_own_data", "update_own_profile", "access_premium_features"]
    - name: "admin"
      permissions: ["read_all_data", "manage_users", "manage_system"]
    - name: "service"
      permissions: ["read_user_data", "create_sessions"]
  
  audit_logging:
    enabled: true
    log_all_access: true
    sensitive_operations: ["login", "password_change", "permission_grant"]
    retention_days: 365
  
  rate_limiting:
    login_attempts: "5/hour"
    password_reset: "3/hour"
    api_calls: "1000/hour"

# 외부 의존성 (최소화)
dependencies:
  cubes: []  # 다른 큐브에 의존하지 않음 (기반 큐브)
  
  external_services:
    - name: "Email Service"
      description: "회원가입 확인 이메일 발송"
      required: true
      fallback: "local_smtp"
    - name: "OAuth Providers"
      description: "소셜 로그인 (Google, Kakao 등)"
      required: false

# 모니터링 설정 (매우 중요)
monitoring:
  metrics_enabled: true
  health_check_interval: 15  # 자주 체크
  performance_logging: true
  
  critical_metrics:
    - "active_user_sessions"
    - "authentication_success_rate"
    - "database_connection_pool_usage"
    - "redis_memory_usage"
    - "api_response_time"
  
  alerts:
    authentication_failure_rate: 0.1      # 10% 실패율
    database_connection_threshold: 0.9     # 90% 사용량
    redis_memory_threshold: 0.8           # 80% 메모리 사용량
    session_creation_anomaly: "2x_normal" # 평소의 2배
    
  dashboards:
    - "사용자 활동 대시보드"
    - "인증 시스템 모니터링"
    - "세션 관리 현황"

# 백업 및 고가용성
backup:
  auto_backup: true
  backup_interval: "every_6_hours"  # 더 자주 백업
  backup_time: ["02:00", "08:00", "14:00", "20:00"]
  retention_days: 90
  
  backup_targets:
    postgresql: true
    redis: true  # 세션 데이터도 중요
    
  disaster_recovery:
    enabled: true
    replication: "master_slave"
    failover_automatic: true
    recovery_time_objective: 300  # 5분 이내 복구

# 성능 최적화 (고성능 필요)
performance:
  connection_pooling: true
  query_optimization: true
  
  caching_strategies:
    - "user_profile_cache"      # 사용자 프로필 캐시
    - "permission_cache"        # 권한 정보 캐시
    - "global_config_cache"     # 전역 설정 캐시
    - "session_cache"          # 세션 정보 캐시
  
  database_optimization:
    index_maintenance: "auto"
    query_plan_analysis: true
    slow_query_logging: true
    
  redis_optimization:
    memory_optimization: true
    persistence: "rdb_aof"  # 데이터 안정성
    maxmemory_policy: "allkeys-lru"
    
  scaling:
    horizontal_scaling: true
    load_balancing: true
    auto_scaling: true
    max_instances: 10

# 데이터 품질 및 정합성
data_quality:
  validation_enabled: true
  strict_validation: true
  
  validation_rules:
    - "email_format_validation"
    - "password_strength_validation"
    - "user_data_consistency_check"
    - "session_integrity_validation"
  
  cleanup_policies:
    - name: "expired_sessions_cleanup"
      schedule: "hourly"
      action: "delete_expired_sessions"
    - name: "inactive_users_warning"
      schedule: "monthly"
      action: "notify_inactive_users"
    - name: "audit_log_archiving"
      schedule: "monthly"
      action: "archive_old_audit_logs"

# 글로벌 설정 관리
global_configuration:
  dynamic_config: true
  config_hot_reload: true
  
  default_settings:
    system:
      maintenance_mode: false
      max_file_upload_size: "50MB"
      session_timeout: 86400
      api_rate_limit: 1000
      
    features:
      user_registration_enabled: true
      social_login_enabled: true
      email_notifications_enabled: true
      premium_features_enabled: true
      
    security:
      password_reset_enabled: true
      two_factor_auth_enabled: false
      ip_whitelist_enabled: false

# 개발 환경
development:
  debug_mode: false  # 보안상 false
  test_users_enabled: true
  mock_email_service: true
  
  test_configurations:
    load_testing: true
    security_testing: true
    integration_testing: true

# 운영 환경 (최고 수준 보안)
production:
  high_availability: true
  load_balancing: true
  ssl_required: true
  
  security_hardening:
    password_complexity_max: true
    session_security_max: true
    audit_logging_detailed: true
    
  maintenance_windows:
    - day: "Sunday"
      time: "04:00-05:00" 
      description: "공유 데이터 정기 점검 (다른 서비스 점검 후)"
      
# 규정 준수
compliance:
  gdpr: true
  ccpa: true  
  korean_privacy_law: true
  
  data_retention:
    user_data: "5_years"
    session_data: "1_year"  
    audit_logs: "7_years"
    
  data_export:
    user_data_export: true
    format: ["json", "csv"]
    encryption: true