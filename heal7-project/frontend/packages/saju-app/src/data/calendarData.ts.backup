// ìš´ì„¸ ìº˜ë¦°ë” ë°ì´í„° ì‹œìŠ¤í…œ - KASI API ì—°ë™ + Atomic ëª¨ë“ˆ í†µí•©
// ======================================================================
// ğŸ”¥ ë§Œì„¸ë ¥ í•µì‹¬ ìƒìˆ˜ ê¸°ì¤€ê°’ (CRITICAL CONSTANTS) ğŸ”¥
// ======================================================================

// ğŸ”¥ ì¤‘ë³µ ì œê±°: ìƒìˆ˜ëŠ” sajuConstants.tsì—ì„œ import
import { ê°‘ì60ìˆœí™˜, ê°‘ìí•œìë§¤í•‘, getê°‘ìí‘œì‹œ } from './sajuConstants';
import { 
  getì ˆê¸°, getì ˆê¸°ìƒì„¸ì •ë³´, isì ˆê¸°ë‚ , getì ˆê¸°ìš´ì„¸ë³´ì •, ì ˆê¸°ì•„ì´ì½˜ë§¤í•‘,
  getìš´ì„¸ì ìˆ˜, getíŠ¹ì´ì‚¬í•­, getê¸¸í‰, isì†ì—†ëŠ”ë‚  
} from './calendarUtils';

// ğŸš€ Atomic API ì „í™˜ ì„¤ì • (ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜)
export const ATOMIC_API_CONFIG = {
  /** 
   * ğŸ”¥ Atomic API ì‚¬ìš© ì—¬ë¶€ (ê¸°ë³¸ê°’: false - ê¸°ì¡´ ì‹œìŠ¤í…œ ìœ ì§€)
   * âš ï¸  trueë¡œ ì„¤ì • ì‹œ ëª¨ë“  ê³„ì‚°ì´ ë°±ì—”ë“œ atomic ëª¨ë“ˆë¡œ ì´ë™
   * ğŸ“ˆ ì„±ëŠ¥: í”„ë¡ íŠ¸ì—”ë“œ ë¡œì§ ì œê±°, ì„œë²„ ì¤‘ì•™í™”
   */
  USE_ATOMIC_API: false, // ê°œë°œ ë‹¨ê³„ì—ì„œëŠ” falseë¡œ ì‹œì‘
  
  /** 
   * ğŸ¯ ë¶€ë¶„ì  ì „í™˜ ì„¤ì • (íŠ¹ì • ê¸°ëŠ¥ë§Œ atomic ì‚¬ìš©)
   */
  ATOMIC_FEATURES: {
    GAPJA_CALCULATION: true,   // 60ê°‘ì ê³„ì‚°ì„ atomicìœ¼ë¡œ
    YEAR_PILLAR: true,         // ë…„ì£¼ ê³„ì‚°ì„ atomicìœ¼ë¡œ
    LUNAR_CONVERSION: false,   // ìŒë ¥ ë³€í™˜ì€ ì•„ì§ ê¸°ì¡´ ì‹œìŠ¤í…œ
    COMPLETE_SAJU: false,      // ì™„ì „í•œ ì‚¬ì£¼ëŠ” ì•„ì§ ê¸°ì¡´ ì‹œìŠ¤í…œ
  },
  
  /** 
   * ğŸ”§ í´ë°± ì„¤ì • (atomic API ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë¡œì§ ì‚¬ìš©)
   */
  ENABLE_FALLBACK: true,
  
  /** 
   * ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (atomic vs ê¸°ì¡´ ë¡œì§ ë¹„êµ)
   */
  ENABLE_PERFORMANCE_MONITORING: true,
} as const;

// ğŸ¯ 1. 60ê°‘ì ê³„ì‚° í•µì‹¬ ê¸°ì¤€ì  (ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€)
export const GAPJA_REFERENCE_CONSTANTS = {
  /** 
   * ğŸ”¥ 60ê°‘ì ì ˆëŒ€ ê¸°ì¤€ì¼: 1900ë…„ 1ì›” 31ì¼ = ê°‘ì§„ì¼
   * âš ï¸  ì´ ê°’ì„ ë³€ê²½í•˜ë©´ ëª¨ë“  ë§Œì„¸ë ¥ ê³„ì‚°ì´ í‹€ì–´ì§
   * ğŸ“š ì¶œì²˜: ì „í†µ ëª…ë¦¬í•™ í‘œì¤€, KASI API í˜¸í™˜
   */
  REFERENCE_DATE: new Date(1900, 0, 31), // 1900ë…„ 1ì›” 31ì¼
  REFERENCE_GAPJA: 'ê°‘ì§„',
  REFERENCE_GAPJA_INDEX: 40, // ê°‘ì60ìˆœí™˜ ë°°ì—´ì—ì„œì˜ ìœ„ì¹˜
  
  /** 
   * ğŸ”¥ ì…ì¶˜ ê¸°ì¤€ (ì—°ì£¼ ê³„ì‚°ì˜ í•µì‹¬)
   * âš ï¸  ë§¤ë…„ 2ì›” 4ì¼ ì „í›„ê°€ ì…ì¶˜ì´ë©°, ì´ ê¸°ì¤€ìœ¼ë¡œ ì—°ì£¼ê°€ ë°”ë€œ
   */
  SPRING_START_MONTH: 2,
  SPRING_START_DAY: 4,
} as const;

// ğŸ¯ 2. ì§„íƒœì–‘ì‹œ ê³„ì‚° ìƒìˆ˜ (êµ­ê°€ë³„ ì§€ì—­ ê¸°ì¤€)
export const SOLAR_TIME_CONSTANTS = {
  /** 
   * ğŸ”¥ í•œêµ­(ì„œìš¸) ê¸°ì¤€ ì§„íƒœì–‘ì‹œ ë³´ì •
   * ìœ„ë„: 37.5665Â°N, ê²½ë„: 126.9780Â°E (ì„œìš¸ ì¤‘ì‹¬)
   * í‘œì¤€ ê²½ë„: 135Â°E (ë™ê²½ 135ë„ - í•œêµ­í‘œì¤€ì‹œ)
   * ë³´ì •ê°’: (126.978 - 135) Ã— 4ë¶„/ë„ = -32.09ë¶„ â‰ˆ -32ë¶„
   */
  KOREA_LONGITUDE: 126.978,
  KOREA_STANDARD_LONGITUDE: 135.0,
  KOREA_TIME_CORRECTION_MINUTES: -32, // ì„œìš¸ í‘œì¤€ì‹œ ê¸°ì¤€ ê²½ë„ì°¨ ë³´ì •
  
  /** 
   * ğŸ”¥ ë‹¤ë¥¸ êµ­ê°€ í™•ì¥ìš© (í–¥í›„ ê¸€ë¡œë²Œ ì„œë¹„ìŠ¤ ëŒ€ë¹„)
   */
  CHINA_LONGITUDE: 116.4074, // ë² ì´ì§•
  CHINA_TIME_CORRECTION_MINUTES: -46,
  JAPAN_LONGITUDE: 139.6917, // ë„ì¿„  
  JAPAN_TIME_CORRECTION_MINUTES: 19,
} as const;

// ğŸ¯ 3. 24ì ˆê¸° ë° ê³„ì ˆ ê¸°ì¤€ ìƒìˆ˜
export const SEASONAL_CONSTANTS = {
  /** 
   * ğŸ”¥ 24ì ˆê¸° ê¸°ì¤€ (ì›”ì£¼ ê³„ì‚°ì˜ í•µì‹¬)
   * âš ï¸  KASI API ê¸°ì¤€ì´ì§€ë§Œ í‘œì¤€ì‹œ â†’ ì§„íƒœì–‘ì‹œ ë³´ì • í•„ìš”
   * ğŸ“Œ KASIëŠ” í‘œì¤€ì‹œ(KST) ê¸°ì¤€ì´ë¯€ë¡œ ì§„íƒœì–‘ì‹œ ì ìš©ì‹œ -32ë¶„ ë³´ì • ì ìš©
   */
  SOLAR_TERMS_REFERENCE: {
    1: { term: 'ì…ì¶˜', approx_date: [2, 4], kasi_time_offset: -32 }, // 2ì›” 4ì¼ ì „í›„, ì§„íƒœì–‘ì‹œ -32ë¶„
    2: { term: 'ê²½ì¹©', approx_date: [3, 5], kasi_time_offset: -32 },
    3: { term: 'ì²­ëª…', approx_date: [4, 5], kasi_time_offset: -32 },  
    4: { term: 'ì…í•˜', approx_date: [5, 5], kasi_time_offset: -32 },
    5: { term: 'ë§ì¢…', approx_date: [6, 6], kasi_time_offset: -32 },
    6: { term: 'ì†Œì„œ', approx_date: [7, 7], kasi_time_offset: -32 },
    7: { term: 'ì…ì¶”', approx_date: [8, 7], kasi_time_offset: -32 },
    8: { term: 'ë°±ë¡œ', approx_date: [9, 8], kasi_time_offset: -32 },
    9: { term: 'í•œë¡œ', approx_date: [10, 8], kasi_time_offset: -32 },
    10: { term: 'ì…ë™', approx_date: [11, 7], kasi_time_offset: -32 },
    11: { term: 'ëŒ€ì„¤', approx_date: [12, 7], kasi_time_offset: -32 },
    12: { term: 'ì†Œí•œ', approx_date: [1, 5], kasi_time_offset: -32 }, // ë‹¤ìŒí•´ 1ì›”
  },
  
  /** 
   * ğŸ”¥ KASI API vs ì§„íƒœì–‘ì‹œ ë³´ì • ìƒìˆ˜
   * âš ï¸  KASI APIëŠ” KST(í•œêµ­í‘œì¤€ì‹œ) ê¸°ì¤€ìœ¼ë¡œ ì ˆê¸°ë¥¼ ì œê³µ
   * ğŸ“Œ ì§„íƒœì–‘ì‹œ ì‚¬ì£¼ê³„ì‚°ì—ì„œëŠ” ì´ ë³´ì •ê°’ì„ ì ìš©í•´ì•¼ ì •í™•í•¨
   */
  KASI_TO_TRUE_SOLAR_CORRECTION: {
    KOREA_KST_OFFSET_MINUTES: -32, // ì„œìš¸ ê¸°ì¤€ ì§„íƒœì–‘ì‹œ ë³´ì •
    DST_ADJUSTMENT_NEEDED: false, // í•œêµ­ì€ ì„œë¨¸íƒ€ì„ ì—†ìŒ
    PRECISION_THRESHOLD_HOURS: 2, // ì ˆê¸° ì „í›„ 2ì‹œê°„ ë‚´ì—ì„œëŠ” ì •ë°€ ê³„ì‚° í•„ìš”
  },
  
  /** 
   * ğŸ”¥ ì›”ì§€ì§€ ë§¤í•‘ (ì ˆê¸° ê¸°ì¤€)
   * âš ï¸  ì…ì¶˜ë¶€í„° ì‹œì‘í•˜ì—¬ 12ê°œì›” ìˆœí™˜
   */
  MONTH_JIJI_MAP: {
    1: 'å¯…', 2: 'å¯', 3: 'è¾°', 4: 'å·³', 5: 'åˆ', 6: 'æœª',
    7: 'ç”³', 8: 'é…‰', 9: 'æˆŒ', 10: 'äº¥', 11: 'å­', 12: 'ä¸‘'
  },
  
  /** 
   * ğŸ”¥ ìŒë ¥ + ì ˆê¸° ë¹„êµëŒ€ì¡° ê³„ì‚° ì›ì¹™ (2025-09-04 ì‹ ê·œ ë°˜ì˜)
   * âš ï¸  ì›”ì£¼, ì¼ì£¼ ê³„ì‚°ì˜ ì •í™•ì„±ì„ ìœ„í•œ í•µì‹¬ ì›ì¹™
   * ğŸ“Œ ì–‘ë ¥ ê³„ì‚° ëŒ€ë¹„ ë³µì¡ë„ ê°ì†Œ ë° ì •í™•ë„ í–¥ìƒ
   */
  LUNAR_SOLAR_TERMS_PRINCIPLE: {
    /** ì›”ì£¼ ê³„ì‚° ë°©ì‹: ìŒë ¥ ì›” + í•´ë‹¹ ì ˆê¸° í™•ì¸ */
    MONTH_PILLAR_METHOD: 'ìŒë ¥_ì ˆê¸°_ë¹„êµëŒ€ì¡°',
    
    /** ì¼ì£¼ ê³„ì‚° ë°©ì‹: ìŒë ¥ ë‚ ì§œ ê¸°ì¤€ 60ê°‘ì ìˆœí™˜ */
    DAY_PILLAR_METHOD: 'ìŒë ¥_60ê°‘ì_ìˆœí™˜',
    
    /** ê³„ì‚° ë³µì¡ë„ ê°ì†Œ: ì–‘ë ¥ â†’ ìŒë ¥ ë³€í™˜ í›„ ê³„ì‚° */
    COMPLEXITY_REDUCTION: true,
    
    /** ì •í™•ë„ ë³´ì¥: ì „í†µ ëª…ë¦¬í•™ í‘œì¤€ ì¤€ìˆ˜ */
    TRADITIONAL_ACCURACY: true,
    
    /** 
     * ğŸ”¥ í•µì‹¬ ê³„ì‚° ìˆœì„œ (ë°˜ë“œì‹œ ì¤€ìˆ˜)
     * 1. ì–‘ë ¥ ì¶œìƒì¼ â†’ KASI API â†’ ìŒë ¥ ë³€í™˜
     * 2. ìŒë ¥ ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹ ì ˆê¸° í™•ì¸
     * 3. ì ˆê¸°ì™€ ìŒë ¥ ì›” ë¹„êµëŒ€ì¡°í•˜ì—¬ ì›”ì£¼ ê²°ì •
     * 4. ìŒë ¥ ì¼ìë¡œ 60ê°‘ì ìˆœí™˜ ê³„ì‚°í•˜ì—¬ ì¼ì£¼ ê²°ì •
     */
    CALCULATION_ORDER: [
      'solar_to_lunar_conversion',
      'solar_term_identification', 
      'lunar_month_solar_term_comparison',
      'month_pillar_determination',
      'lunar_date_60gapja_calculation',
      'day_pillar_determination'
    ],
  },
} as const;

// ğŸ¯ 4. ì„œë¨¸íƒ€ì„ ë° ì‹œê°„ëŒ€ ìƒìˆ˜
export const TIMEZONE_CONSTANTS = {
  /** 
   * ğŸ”¥ í•œêµ­ì€ ì„œë¨¸íƒ€ì„ ì—†ìŒ (ì—°ì¤‘ UTC+9 ê³ ì •)
   * âš ï¸  ë”°ë¼ì„œ KASI APIë„ ì„œë¨¸íƒ€ì„ ê³ ë ¤ ë¶ˆí•„ìš”
   */
  KOREA_USES_DST: false,
  KOREA_UTC_OFFSET: 9,
  
  /** 
   * ğŸ”¥ ì„œë¨¸íƒ€ì„ ì ìš© êµ­ê°€ë“¤ (í–¥í›„ í™•ì¥ìš©)
   * âš ï¸  ì´ë“¤ êµ­ê°€ì—ì„œëŠ” KASI ëŒ€ì‘ APIì˜ ì ˆê¸° ì‹œê°„ë„ DST ë³´ì • í•„ìš”
   */
  DST_COUNTRIES: {
    'US': { 
      start: [3, 2, 0], end: [11, 1, 0], // 3ì›” 2ì£¼ ì¼ìš”ì¼ ~ 11ì›” 1ì£¼ ì¼ìš”ì¼
      standard_offset: -5, // EST UTC-5
      dst_offset: -4, // EDT UTC-4
      solar_time_correction_needed: true
    },
    'EU': { 
      start: [3, -1, 0], end: [10, -1, 0], // 3ì›” ë§ˆì§€ë§‰ ì¼ìš”ì¼ ~ 10ì›” ë§ˆì§€ë§‰ ì¼ìš”ì¼  
      standard_offset: 1, // CET UTC+1
      dst_offset: 2, // CEST UTC+2
      solar_time_correction_needed: true
    },
  },
  
  /** 
   * ğŸ”¥ ì‹œê°„ëŒ€ë³„ KASI ëŒ€ì‘ API ì •ë³´ (í–¥í›„ ê¸€ë¡œë²Œ ì„œë¹„ìŠ¤ìš©)
   * âš ï¸  ê° êµ­ê°€ì˜ ì²œë¬¸ APIëŠ” í•´ë‹¹ ì§€ì—­ í‘œì¤€ì‹œ ê¸°ì¤€ì´ë¯€ë¡œ ì§„íƒœì–‘ì‹œ ë³´ì • í•„ìˆ˜
   */
  GLOBAL_ASTRONOMICAL_APIS: {
    'KOREA': { source: 'KASI', timezone: 'KST', needs_solar_correction: true },
    'CHINA': { source: 'CAS', timezone: 'CST', needs_solar_correction: true },
    'JAPAN': { source: 'NAOJ', timezone: 'JST', needs_solar_correction: true },
    'US': { source: 'USNO', timezone: 'multiple', needs_dst_handling: true },
  },
} as const;

// ğŸ¯ 5. ì‹œì£¼ ê³„ì‚° í•µì‹¬ ìƒìˆ˜
export const HOUR_CONSTANTS = {
  /** 
   * ğŸ”¥ ì‹œë‘ë²• ë§¤í•‘ (ì¼ê°„ì— ë”°ë¥¸ ì‹œì²œê°„ ê²°ì •)
   * âš ï¸  ì´ ë§¤í•‘ì´ ì‹œì£¼ ê³„ì‚°ì˜ í•µì‹¬
   */
  HOUR_CHEONGAN_BY_DAY: {
    'ç”²': ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ç”²', 'ä¹™'],
    'ä¹™': ['ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸'],
    'ä¸™': ['æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±'],
    'ä¸': ['åºš', 'è¾›', 'å£¬', 'ç™¸', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›'],
    'æˆŠ': ['å£¬', 'ç™¸', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'],
    'å·±': ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ç”²', 'ä¹™'],
    'åºš': ['ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸'],
    'è¾›': ['æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±'],
    'å£¬': ['åºš', 'è¾›', 'å£¬', 'ç™¸', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›'],
    'ç™¸': ['å£¬', 'ç™¸', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'],
  },
  
  /** 
   * ğŸ”¥ ì‹œì§€ì§€ ë§¤í•‘ (2ì‹œê°„ ë‹¨ìœ„)
   * 23:00-01:00=ì, 01:00-03:00=ì¶•, ... ìˆœì„œ
   */
  HOUR_JIJI_BOUNDARIES: [23, 1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23],
} as const;

export interface CalendarDate {
  date: Date;
  lunarDate: string;
  lunarYear: number;
  lunarMonth: number;
  lunarDay: number;
  isLeapMonth: boolean; // ìœ¤ë‹¬ ì—¬ë¶€
  gapja: string;
  zodiac: string;
  element: string;
  sonEobNeunNal: boolean; // ì†ì—†ëŠ”ë‚ 
  gilil: boolean; // ê¸¸ì¼
  í‰ì¼: boolean; // í‰ì¼
  ì ˆê¸°: string | null;
  ìš´ì„¸ì ìˆ˜: number; // 1-5
  íŠ¹ì´ì‚¬í•­: string[];
  solarCalendarType: 'solar'; // ì–‘ë ¥ í‘œê¸°
  yearPillar?: string; // ì—°ì£¼
  monthPillar?: string; // ì›”ì£¼
}

export interface MonthlyFortune {
  month: number;
  year: number;
  bestDates: CalendarDate[];
  worstDates: CalendarDate[];
  importantDates: CalendarDate[];
  monthlyMessage: string;
}

// ì²œê°„ ë°ì´í„°
export const ì²œê°„ = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„'];
export const ì§€ì§€ = ['ì', 'ì¶•', 'ì¸', 'ë¬˜', 'ì§„', 'ì‚¬', 'ì˜¤', 'ë¯¸', 'ì‹ ', 'ìœ ', 'ìˆ ', 'í•´'];

// 12ì§€ì‹  ë™ë¬¼ ë§¤í•‘
export const ë ë™ë¬¼: Record<string, string> = {
  'ì': 'ì¥', 'ì¶•': 'ì†Œ', 'ì¸': 'í˜¸ë‘ì´', 'ë¬˜': 'í† ë¼', 
  'ì§„': 'ìš©', 'ì‚¬': 'ë±€', 'ì˜¤': 'ë§', 'ë¯¸': 'ì–‘',
  'ì‹ ': 'ì›ìˆ­ì´', 'ìœ ': 'ë‹­', 'ìˆ ': 'ê°œ', 'í•´': 'ë¼ì§€'
};

// ì˜¤í–‰ ë§¤í•‘
export const ì˜¤í–‰ë§¤í•‘: Record<string, string> = {
  'ê°‘': 'ëª©', 'ì„': 'ëª©', 'ë³‘': 'í™”', 'ì •': 'í™”', 'ë¬´': 'í† ',
  'ê¸°': 'í† ', 'ê²½': 'ê¸ˆ', 'ì‹ ': 'ê¸ˆ', 'ì„': 'ìˆ˜', 'ê³„': 'ìˆ˜'
};

// ğŸ”¥ ì¤‘ë³µ ì œê±°: 60ê°‘ì ë°°ì—´ì€ sajuConstants.tsì—ì„œ importë¨

// ğŸ”¥ ì¤‘ë³µ ì œê±°: ê°‘ìí•œìë§¤í•‘ê³¼ getê°‘ìí‘œì‹œ í•¨ìˆ˜ëŠ” sajuConstants.tsì—ì„œ importë¨

// ğŸš€ Atomic API í†µí•© (ë™ì  importë¡œ ë²ˆë“¤ í¬ê¸° ìµœì í™”)
let atomicAPIModule: any = null;

async function getAtomicAPI() {
  if (!atomicAPIModule) {
    try {
      atomicAPIModule = await import('../utils/atomicSajuAPI');
    } catch (error) {
      console.warn('Atomic API ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
      return null;
    }
  }
  return atomicAPIModule;
}

// ğŸ¯ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹°
interface PerformanceMetric {
  method: 'local' | 'atomic';
  duration: number;
  success: boolean;
  timestamp: number;
}

const performanceMetrics: PerformanceMetric[] = [];

function recordPerformance(method: 'local' | 'atomic', duration: number, success: boolean) {
  if (ATOMIC_API_CONFIG.ENABLE_PERFORMANCE_MONITORING) {
    performanceMetrics.push({
      method,
      duration,
      success,
      timestamp: Date.now()
    });
    
    // ìµœê·¼ 100ê°œ ê¸°ë¡ë§Œ ìœ ì§€
    if (performanceMetrics.length > 100) {
      performanceMetrics.splice(0, 50);
    }
  }
}

export function getPerformanceMetrics() {
  return [...performanceMetrics];
}

// ğŸ”¥ ë¡œì»¬ 60ê°‘ì ê³„ì‚° í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
const get60ê°‘ìLocal = (date: Date): string => {
  const ê¸°ì¤€ì¼ = GAPJA_REFERENCE_CONSTANTS.REFERENCE_DATE;
  const ê¸°ì¤€ê°‘ìì¸ë±ìŠ¤ = GAPJA_REFERENCE_CONSTANTS.REFERENCE_GAPJA_INDEX;
  
  const ë‚ ì§œì°¨ì´ = Math.floor((date.getTime() - ê¸°ì¤€ì¼.getTime()) / (24 * 60 * 60 * 1000));
  let ê°‘ìì¸ë±ìŠ¤ = (ê¸°ì¤€ê°‘ìì¸ë±ìŠ¤ + ë‚ ì§œì°¨ì´) % 60;
  
  if (ê°‘ìì¸ë±ìŠ¤ < 0) {
    ê°‘ìì¸ë±ìŠ¤ += 60;
  }
  
  return ê°‘ì60ìˆœí™˜[ê°‘ìì¸ë±ìŠ¤];
};

// ğŸš€ í•˜ì´ë¸Œë¦¬ë“œ 60ê°‘ì ê³„ì‚° í•¨ìˆ˜ (Atomic API + ë¡œì»¬ ê³„ì‚°)
export const get60ê°‘ì = async (date: Date): Promise<string> => {
  const startTime = performance.now();
  
  // Atomic API ì‚¬ìš© ì—¬ë¶€ í™•ì¸
  if (ATOMIC_API_CONFIG.ATOMIC_FEATURES.GAPJA_CALCULATION) {
    try {
      const atomicAPI = await getAtomicAPI();
      if (atomicAPI) {
        const result = await atomicAPI.get60ê°‘ìAtomic(date);
        const duration = performance.now() - startTime;
        recordPerformance('atomic', duration, result !== 'âŒì˜¤ë¥˜');
        
        if (result !== 'âŒì˜¤ë¥˜') {
          console.log(`ğŸš€ Atomic 60ê°‘ì: ${date.toISOString().split('T')[0]} = ${result}`);
          return result;
        }
      }
    } catch (error) {
      console.warn('Atomic API ê°‘ì ê³„ì‚° ì‹¤íŒ¨, ë¡œì»¬ë¡œ í´ë°±:', error);
    }
  }
  
  // í´ë°± ë˜ëŠ” ê¸°ë³¸ ë¡œì»¬ ê³„ì‚°
  if (ATOMIC_API_CONFIG.ENABLE_FALLBACK || !ATOMIC_API_CONFIG.ATOMIC_FEATURES.GAPJA_CALCULATION) {
    const result = get60ê°‘ìLocal(date);
    const duration = performance.now() - startTime;
    recordPerformance('local', duration, true);
    
    // ğŸ” 9ì›” 5-6ì¼ ë””ë²„ê¹… ë¡œê·¸ (ë¡œì»¬ ê³„ì‚°ì‹œì—ë§Œ)
    if (date.getMonth() === 8 && (date.getDate() === 5 || date.getDate() === 6)) {
      console.log(`ğŸ” ë¡œì»¬ 60ê°‘ì ê³„ì‚° (9ì›” ${date.getDate()}ì¼): ${result}`);
    }
    
    return result;
  }
  
  return 'âŒì˜¤ë¥˜';
};

// ğŸ”„ ë™ê¸° ë²„ì „ (ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„±)
export const get60ê°‘ìSync = (date: Date): string => {
  return get60ê°‘ìLocal(date);
};

// í¬ë¡œìŠ¤ì²´í¬ í•¨ìˆ˜ (ê²€ì¦ìš©) - 60ê°‘ìì— ì‹¤ì œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
export const isìœ íš¨í•œ60ê°‘ì = (gapja: string): boolean => {
  return ê°‘ì60ìˆœí™˜.includes(gapja);
};

// ë ˆê±°ì‹œ ë°©ì‹ê³¼ ë¹„êµ ê²€ì¦ í•¨ìˆ˜ (ê°œë°œ/ë””ë²„ê¹…ìš©)
export const get60ê°‘ìWithValidation = (date: Date): { result: string; isValid: boolean; legacy: string } => {
  // ìƒˆë¡œìš´ ë°°ì—´ ê¸°ë°˜ ë°©ì‹
  const ìƒˆë¡œìš´ê²°ê³¼ = get60ê°‘ìSync(date);
  
  // ë ˆê±°ì‹œ ë°©ì‹ (ì²œê°„/ì§€ì§€ ê°œë³„ ê³„ì‚°)
  const ê¸°ì¤€ì¼ = new Date(1900, 0, 1);
  const ë‚ ì§œì°¨ì´ = Math.floor((date.getTime() - ê¸°ì¤€ì¼.getTime()) / (24 * 60 * 60 * 1000));
  let ê°‘ìì¸ë±ìŠ¤ = (40 + ë‚ ì§œì°¨ì´) % 60;
  if (ê°‘ìì¸ë±ìŠ¤ < 0) ê°‘ìì¸ë±ìŠ¤ += 60;
  
  const ì²œê°„ì¸ë±ìŠ¤ = ê°‘ìì¸ë±ìŠ¤ % 10;
  const ì§€ì§€ì¸ë±ìŠ¤ = ê°‘ìì¸ë±ìŠ¤ % 12;
  const ë ˆê±°ì‹œê²°ê³¼ = ì²œê°„[ì²œê°„ì¸ë±ìŠ¤] + ì§€ì§€[ì§€ì§€ì¸ë±ìŠ¤];
  
  return {
    result: ìƒˆë¡œìš´ê²°ê³¼,
    isValid: isìœ íš¨í•œ60ê°‘ì(ë ˆê±°ì‹œê²°ê³¼),
    legacy: ë ˆê±°ì‹œê²°ê³¼
  };
};

// ğŸ”¥ ì…ì¶˜ ê¸°ì¤€ ë…„ì£¼ ê³„ì‚° í•¨ìˆ˜ (60ê°‘ì ê¸°ì¤€)
export const getë…„ì£¼ = (date: Date): string => {
  const year = date.getFullYear();
  const month = date.getMonth() + 1; // 1-12ì›”
  const day = date.getDate();
  
  // ğŸ”¥ ì…ì¶˜ ê¸°ì¤€: ë§¤ë…„ 2ì›” 4ì¼ ì „í›„ (KASI ê¸°ì¤€)
  // ì…ì¶˜ ì´ì „ì€ ì „ë…„ë„ ë…„ì£¼, ì…ì¶˜ ì´í›„ëŠ” ë‹¹ë…„ë„ ë…„ì£¼
  let sajuYear = year;
  if (month < 2 || (month === 2 && day < 4)) {
    sajuYear = year - 1; // ì…ì¶˜ ì´ì „ì€ ì „ë…„ë„
  }
  
  // ğŸ¯ 1900ë…„ = ê²½ìë…„(36ë²ˆì§¸) ê¸°ì¤€ìœ¼ë¡œ 60ê°‘ì ìˆœí™˜ ê³„ì‚°
  const ê¸°ì¤€ë…„ë„ = 1900;
  const ê¸°ì¤€ë…„ê°‘ìì¸ë±ìŠ¤ = 36; // ê²½ì = ê°‘ì60ìˆœí™˜ ë°°ì—´ì—ì„œ 36ë²ˆì§¸
  
  let ë…„ê°‘ìì¸ë±ìŠ¤ = (ê¸°ì¤€ë…„ê°‘ìì¸ë±ìŠ¤ + (sajuYear - ê¸°ì¤€ë…„ë„)) % 60;
  if (ë…„ê°‘ìì¸ë±ìŠ¤ < 0) ë…„ê°‘ìì¸ë±ìŠ¤ += 60;
  
  const ë…„ì£¼ = ê°‘ì60ìˆœí™˜[ë…„ê°‘ìì¸ë±ìŠ¤];
  
  // ğŸ” 2025ë…„ ê²€ì¦ ë¡œê·¸
  if (year === 2025) {
    console.log(`ğŸ”¥ ë…„ì£¼ ê³„ì‚° (${year}-${month}-${day}):`, {
      ì…ë ¥ë‚ ì§œ: `${year}ë…„ ${month}ì›” ${day}ì¼`,
      ì‚¬ì£¼ê¸°ì¤€ë…„ë„: sajuYear,
      ì…ì¶˜ê¸°ì¤€ì ìš©: month < 2 || (month === 2 && day < 4) ? 'ì „ë…„ë„' : 'ë‹¹ë…„ë„',
      ê³„ì‚°ëœì¸ë±ìŠ¤: ë…„ê°‘ìì¸ë±ìŠ¤,
      ìµœì¢…ë…„ì£¼: ë…„ì£¼
    });
  }
  
  return ë…„ì£¼;
};

// ì •ë°€ ìŒë ¥ ë³€í™˜ í•¨ìˆ˜ (2025ë…„ ì •í™•í•œ ìŒë ¥ ëŒ€ì¡°í‘œ ê¸°ì¤€)
export const getìŒë ¥ë³€í™˜ = (date: Date): string => {
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  
  // ğŸ”¥ 2025ë…„ ì •í™•í•œ ìŒë ¥-ì–‘ë ¥ ëŒ€ì¡°í‘œ (í•œêµ­ì²œë¬¸ì—°êµ¬ì› ê¸°ì¤€)
  const ì •í™•í•œìŒë ¥í‘œ = {
    2025: [
      // [ì–‘ë ¥ì›”, ì–‘ë ¥ì¼, ìŒë ¥ì›”, ìŒë ¥ì¼, ìœ¤ë‹¬ì—¬ë¶€] í˜•íƒœ
      [1, 29, 1, 1, false],   // ì„¤ë‚ 
      [2, 12, 1, 15, false],  // ì •ì›”ëŒ€ë³´ë¦„
      [2, 27, 1, 30, false],  // 1ì›” ê·¸ë¯
      [2, 28, 2, 1, false],   // ìŒë ¥ 2ì›” 1ì¼
      [3, 14, 2, 15, false],  // ìŒë ¥ 2ì›” 15ì¼
      [3, 29, 3, 1, false],   // ìŒë ¥ 3ì›” 1ì¼
      [4, 12, 3, 15, false],  // ìŒë ¥ 3ì›” 15ì¼
      [4, 27, 4, 1, false],   // ìŒë ¥ 4ì›” 1ì¼
      [5, 12, 4, 15, false],  // ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ 
      [5, 26, 5, 1, false],   // ìŒë ¥ 5ì›” 1ì¼
      [6, 10, 5, 15, false],  // ìŒë ¥ 5ì›” 15ì¼
      [6, 24, 6, 1, false],   // ìŒë ¥ 6ì›” 1ì¼ 
      [7, 9, 6, 15, false],   // ìŒë ¥ 6ì›” 15ì¼
      [7, 23, 7, 1, false],   // ìŒë ¥ 7ì›” 1ì¼
      [8, 7, 7, 15, false],   // ì¤‘ì›ì ˆ (ì¹ ì›”ì¹ ì„)
      [8, 21, 8, 1, false],   // ìŒë ¥ 8ì›” 1ì¼
      [9, 5, 8, 15, false],   // ì¶”ì„ (ì¤‘ì¶”ì ˆ)
      [9, 19, 9, 1, false],   // ìŒë ¥ 9ì›” 1ì¼
      [10, 4, 9, 15, false],  // ìŒë ¥ 9ì›” 15ì¼
      [10, 18, 10, 1, false], // ìŒë ¥ 10ì›” 1ì¼
      [11, 2, 10, 15, false], // ìŒë ¥ 10ì›” 15ì¼
      [11, 16, 11, 1, false], // ìŒë ¥ 11ì›” 1ì¼
      [11, 30, 11, 15, false],// ìŒë ¥ 11ì›” 15ì¼
      [12, 15, 12, 1, false], // ìŒë ¥ 12ì›” 1ì¼
      [12, 30, 12, 16, false] // ìŒë ¥ 12ì›” 16ì¼ (ì—°ë§)
    ]
  };
  
  const ê¸°ì¤€ì ë“¤ = ì •í™•í•œìŒë ¥í‘œ[year];
  if (!ê¸°ì¤€ì ë“¤) {
    return `ìŒë ¥ ${month}ì›” ${day}ì¼ (ê·¼ì‚¬)`; // ê¸°ë³¸ê°’
  }
  
  // ê°€ì¥ ê°€ê¹Œìš´ ê¸°ì¤€ì  ì°¾ê¸°
  let ê°€ì¥ê°€ê¹Œìš´ê¸°ì¤€ = ê¸°ì¤€ì ë“¤[0];
  let ìµœì†Œì°¨ì´ = Math.abs((month - ê°€ì¥ê°€ê¹Œìš´ê¸°ì¤€[0]) * 31 + (day - ê°€ì¥ê°€ê¹Œìš´ê¸°ì¤€[1]));
  
  for (const ê¸°ì¤€ì  of ê¸°ì¤€ì ë“¤) {
    const ì°¨ì´ = Math.abs((month - ê¸°ì¤€ì [0]) * 31 + (day - ê¸°ì¤€ì [1]));
    if (ì°¨ì´ < ìµœì†Œì°¨ì´) {
      ìµœì†Œì°¨ì´ = ì°¨ì´;
      ê°€ì¥ê°€ê¹Œìš´ê¸°ì¤€ = ê¸°ì¤€ì ;
    }
  }
  
  // ê¸°ì¤€ì ìœ¼ë¡œë¶€í„° ìŒë ¥ ë‚ ì§œ ì¶”ì •
  const ì–‘ë ¥ê¸°ì¤€ì¼ = ê°€ì¥ê°€ê¹Œìš´ê¸°ì¤€[0] * 31 + ê°€ì¥ê°€ê¹Œìš´ê¸°ì¤€[1];
  const í˜„ì¬ì–‘ë ¥ì¼ = month * 31 + day;
  const ì¼ìˆ˜ì°¨ì´ = í˜„ì¬ì–‘ë ¥ì¼ - ì–‘ë ¥ê¸°ì¤€ì¼;
  
  let ìŒë ¥ì›” = ê°€ì¥ê°€ê¹Œìš´ê¸°ì¤€[2];
  let ìŒë ¥ì¼ = ê°€ì¥ê°€ê¹Œìš´ê¸°ì¤€[3] + ì¼ìˆ˜ì°¨ì´;
  
  // ì›” ê²½ê³„ ì²˜ë¦¬ (29ì¼/30ì¼ ê¸°ì¤€)
  while (ìŒë ¥ì¼ > 30) {
    ìŒë ¥ì¼ -= 29; // í‰ê·  ìŒë ¥ì›” ê¸¸ì´
    ìŒë ¥ì›”++;
  }
  while (ìŒë ¥ì¼ < 1) {
    ìŒë ¥ì¼ += 29;
    ìŒë ¥ì›”--;
  }
  
  // ì—°ë„ ê²½ê³„ ì²˜ë¦¬
  if (ìŒë ¥ì›” > 12) {
    ìŒë ¥ì›” = ìŒë ¥ì›” % 12 || 12;
  }
  if (ìŒë ¥ì›” < 1) {
    ìŒë ¥ì›” = 12 + ìŒë ¥ì›”;
  }
  
  return `ìŒë ¥ ${ìŒë ¥ì›”}ì›” ${ìŒë ¥ì¼}ì¼`;
};

// ğŸ”¥ ì´ë™ë¨: calendarUtils.tsì—ì„œ import

// ğŸ”¥ ì´ë™ë¨: calendarUtils.tsì—ì„œ import

// ğŸ”¥ ì´ë™ë¨: calendarUtils.tsì—ì„œ import

// ğŸ”¥ ë™ì  24ì ˆê¸° ë°ì´í„° ì‹œìŠ¤í…œ (KASI API ê¸°ë°˜)
interface SolarTermData {
  ì´ë¦„: string;
  ë‚ ì§œ: Date;
  icon: string;
  color: string; 
  description: string;
  season: string;
}

// ë©”ëª¨ë¦¬ ìºì‹œ: 2ë…„ì¹˜ 24ì ˆê¸° ë°ì´í„° ì €ì¥
let cachedSolarTerms: Record<number, SolarTermData[]> = {};
let cacheTimestamp: number = 0;
const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24ì‹œê°„ ìºì‹œ

// ğŸ”¥ KASI APIë¥¼ í†µí•œ 2ë…„ì¹˜ 24ì ˆê¸° í”„ë¦¬ë¡œë“œ
export const preloadSolarTermsData = async (): Promise<boolean> => {
  try {
    const now = Date.now();
    const currentYear = new Date().getFullYear();
    
    // ìºì‹œê°€ ìœ íš¨í•œ ê²½ìš° ìŠ¤í‚µ
    if (cacheTimestamp > 0 && (now - cacheTimestamp) < CACHE_DURATION && 
        cachedSolarTerms[currentYear] && cachedSolarTerms[currentYear + 1]) {
      console.log('âœ… 24ì ˆê¸° ìºì‹œ ìœ íš¨ - ë¡œë“œ ìŠ¤í‚µ');
      return true;
    }
    
    console.log('ğŸ”® 2ë…„ì¹˜ 24ì ˆê¸° ë°ì´í„° í”„ë¦¬ë¡œë“œ ì‹œì‘...');
    
    // ë°±ì—”ë“œ KASI API í˜¸ì¶œ
    const response = await fetch('/api/kasi/solar-terms/preload');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    
    if (!result.success || !result.data) {
      throw new Error(result.error || '24ì ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
    }
    
    // ìºì‹œì— ì €ì¥ (ì•„ì´ì½˜ ì •ë³´ì™€ í•¨ê»˜)
    cachedSolarTerms = {};
    
    for (const [yearStr, termsList] of Object.entries(result.data)) {
      const year = parseInt(yearStr);
      const processedTerms: SolarTermData[] = [];
      
      for (const term of termsList as any[]) {
        const iconInfo = ì ˆê¸°ì•„ì´ì½˜ë§¤í•‘[term.name];
        
        if (iconInfo) {
          processedTerms.push({
            ì´ë¦„: term.name,
            ë‚ ì§œ: new Date(term.date),
            icon: iconInfo.icon,
            color: iconInfo.color,
            description: iconInfo.description,
            season: iconInfo.season
          });
        }
      }
      
      cachedSolarTerms[year] = processedTerms;
    }
    
    cacheTimestamp = now;
    
    console.log(`âœ… 2ë…„ì¹˜ 24ì ˆê¸° í”„ë¦¬ë¡œë“œ ì™„ë£Œ: ${result.preload_years.join(', ')}ë…„`);
    console.log(`ğŸ“Š ì´ ${result.total_terms}ê°œ ì ˆê¸° ë¡œë“œë¨`);
    
    return true;
    
  } catch (error) {
    console.error('âŒ 24ì ˆê¸° í”„ë¦¬ë¡œë“œ ì‹¤íŒ¨:', error);
    return false;
  }
};

// ğŸ”¥ ì—°ë„ë³„ 24ì ˆê¸° ë°ì´í„° ì¡°íšŒ (ë™ì )
export const getì—°ë„ë³„ì ˆê¸° = async (year: number): Promise<SolarTermData[]> => {
  // í”„ë¦¬ë¡œë“œ ì‹œë„
  await preloadSolarTermsData();
  
  // ìºì‹œì—ì„œ ì¡°íšŒ
  if (cachedSolarTerms[year]) {
    return cachedSolarTerms[year];
  }
  
  // ìºì‹œ ë¯¸ìŠ¤ ì‹œ ê°œë³„ ì¡°íšŒ
  try {
    const response = await fetch(`/api/kasi/solar-terms/${year}`);
    const result = await response.json();
    
    if (result.success && result.solar_terms) {
      const processedTerms: SolarTermData[] = [];
      
      for (const term of result.solar_terms) {
        const iconInfo = ì ˆê¸°ì•„ì´ì½˜ë§¤í•‘[term.name];
        
        if (iconInfo) {
          processedTerms.push({
            ì´ë¦„: term.name,
            ë‚ ì§œ: new Date(term.date),
            icon: iconInfo.icon,
            color: iconInfo.color,
            description: iconInfo.description,
            season: iconInfo.season
          });
        }
      }
      
      // ìºì‹œì— ì €ì¥
      cachedSolarTerms[year] = processedTerms;
      return processedTerms;
    }
  } catch (error) {
    console.error(`âŒ ${year}ë…„ 24ì ˆê¸° ì¡°íšŒ ì‹¤íŒ¨:`, error);
  }
  
  // í´ë°±: ë¹ˆ ë°°ì—´ ë°˜í™˜
  console.warn(`âš ï¸  ${year}ë…„ 24ì ˆê¸° ë°ì´í„° ì—†ìŒ - ë¹ˆ ë°°ì—´ ë°˜í™˜`);
  return [];
};

// ğŸ”¥ ì•± ì‹œì‘ì‹œ ìë™ í”„ë¦¬ë¡œë“œ (ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰)
// ì´ í•¨ìˆ˜ëŠ” ì•±ì´ ë¡œë“œë  ë•Œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤
setTimeout(() => {
  preloadSolarTermsData().then(success => {
    if (success) {
      console.log('ğŸš€ 24ì ˆê¸° í”„ë¦¬ë¡œë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
    } else {
      console.warn('âš ï¸  24ì ˆê¸° í”„ë¦¬ë¡œë“œ ì‹¤íŒ¨ - í´ë°± ëª¨ë“œë¡œ ë™ì‘');
    }
  });
}, 1000); // 1ì´ˆ í›„ ë°±ê·¸ë¼ìš´ë“œ í”„ë¦¬ë¡œë“œ

// ğŸ”¥ ë™ì  ì ˆê¸° ì°¾ê¸° - KASI API ê¸°ë°˜
export const getì ˆê¸° = (date: Date): string | null => {
  const year = date.getFullYear();
  
  // ìºì‹œëœ ì ˆê¸° ë°ì´í„°ì—ì„œ ì°¾ê¸°
  if (cachedSolarTerms[year]) {
    const í•´ë‹¹ì ˆê¸° = cachedSolarTerms[year].find(ì ˆê¸° => {
      const diff = Math.abs(date.getTime() - ì ˆê¸°.ë‚ ì§œ.getTime());
      return diff < 24 * 60 * 60 * 1000; // 1ì¼ ì´ë‚´
    });
    return í•´ë‹¹ì ˆê¸°?.ì´ë¦„ || null;
  }
  
  // ìºì‹œê°€ ì—†ìœ¼ë©´ null ë°˜í™˜ (í”„ë¦¬ë¡œë“œ ëŒ€ê¸° ì¤‘)
  return null;
};

// ğŸ”¥ ë™ì  ì ˆê¸° ìƒì„¸ ì •ë³´ ë°˜í™˜ - KASI API ê¸°ë°˜
export const getì ˆê¸°ìƒì„¸ì •ë³´ = (date: Date): { 
  name: string; 
  icon: string; 
  color: string; 
  description: string; 
  season: string; 
} | null => {
  const year = date.getFullYear();
  
  // ìºì‹œëœ ì ˆê¸° ë°ì´í„°ì—ì„œ ì§ì ‘ ì°¾ê¸°
  if (cachedSolarTerms[year]) {
    const í•´ë‹¹ì ˆê¸° = cachedSolarTerms[year].find(ì ˆê¸° => {
      const diff = Math.abs(date.getTime() - ì ˆê¸°.ë‚ ì§œ.getTime());
      return diff < 24 * 60 * 60 * 1000; // 1ì¼ ì´ë‚´
    });
    
    if (í•´ë‹¹ì ˆê¸°) {
      return {
        name: í•´ë‹¹ì ˆê¸°.ì´ë¦„,
        icon: í•´ë‹¹ì ˆê¸°.icon,
        color: í•´ë‹¹ì ˆê¸°.color,
        description: í•´ë‹¹ì ˆê¸°.description,
        season: í•´ë‹¹ì ˆê¸°.season
      };
    }
  }
  
  // ìºì‹œê°€ ì—†ìœ¼ë©´ null ë°˜í™˜
  return null;
};

// ğŸŒŸ ì ˆê¸° ê°•ì¡° í‘œì‹œìš© í•¨ìˆ˜ (ë‹¬ë ¥ì—ì„œ ì ˆê¸° ë‚ ì§œ í•˜ì´ë¼ì´íŠ¸)
export const isì ˆê¸°ë‚  = (date: Date): boolean => {
  return getì ˆê¸°(date) !== null;
};

// ğŸ”¥ ì ˆê¸° ê¸°ë°˜ íŠ¹ë³„í•œ ìš´ì„¸ ë³´ì • (ì ˆê¸°ëŠ” ìš´ì„¸ ì ìˆ˜ì— ê¸ì •ì  ì˜í–¥)
export const getì ˆê¸°ìš´ì„¸ë³´ì • = (ì ˆê¸°ì´ë¦„: string | null): number => {
  if (!ì ˆê¸°ì´ë¦„) return 0;
  
  // ê³„ì ˆë³„ ìš´ì„¸ ë³´ì •ê°’
  const ê³„ì ˆë³´ì •: Record<string, number> = {
    'ë´„': 1,    // ìƒˆë¡œìš´ ì‹œì‘, ìƒëª…ë ¥
    'ì—¬ë¦„': 0.5, // í™œê¸°, ì„±ì¥
    'ê°€ì„': 1,   // ìˆ˜í™•, ê²°ì‹¤
    'ê²¨ìš¸': 0.5  // ì •í™”, ì¤€ë¹„
  };
  
  const ì ˆê¸°ì •ë³´ = ì ˆê¸°ì•„ì´ì½˜ë§¤í•‘[ì ˆê¸°ì´ë¦„];
  return ì ˆê¸°ì •ë³´ ? (ê³„ì ˆë³´ì •[ì ˆê¸°ì •ë³´.season] || 0) : 0;
};

// ìš´ì„¸ ì ìˆ˜ ê³„ì‚° (1-5) - ì ˆê¸° ë³´ì • í¬í•¨
export const getìš´ì„¸ì ìˆ˜ = (gapja: string, date: Date): number => {
  const ì²œê°„ = gapja[0];
  const ì§€ì§€ = gapja[1];
  const ì˜¤í–‰ = ì˜¤í–‰ë§¤í•‘[ì²œê°„];
  const dayOfWeek = date.getDay();
  const day = date.getDate();
  
  let ì ìˆ˜ = 3; // ê¸°ë³¸ ì ìˆ˜
  
  // ì˜¤í–‰ë³„ ìš”ì¼ ë³´ì •
  const ì˜¤í–‰ìš”ì¼ë³´ì •: Record<string, number[]> = {
    'ëª©': [1, 4], // ì›”, ëª©
    'í™”': [2], // í™”
    'í† ': [6], // í† 
    'ê¸ˆ': [5], // ê¸ˆ
    'ìˆ˜': [0, 3] // ì¼, ìˆ˜
  };
  
  if (ì˜¤í–‰ìš”ì¼ë³´ì •[ì˜¤í–‰]?.includes(dayOfWeek)) {
    ì ìˆ˜ += 1;
  }
  
  // ë‚ ì§œë³„ ë³´ì •
  if (day % 6 === 0) ì ìˆ˜ += 1; // 6ì˜ ë°°ìˆ˜
  if (day === 8 || day === 18 || day === 28) ì ìˆ˜ += 1; // ë°œìŒì´ ì¢‹ì€ ë‚ 
  
  // ì§€ì§€ë³„ ë³´ì •
  const ì§€ì§€ë³´ì •: Record<string, number> = {
    'ìš©': 1, 'í˜¸ë‘ì´': 1, 'ë§': 1, 'ë‹­': 1, // í™œë™ì 
    'ì¥': -1, 'ë±€': -1 // ì¡°ìš©í•œ
  };
  
  const ë  = ë ë™ë¬¼[ì§€ì§€];
  if (ë ) {
    ì ìˆ˜ += ì§€ì§€ë³´ì •[ë ] || 0;
  }
  
  // ğŸ”¥ ì ˆê¸° ë³´ì • ì¶”ê°€ (ì ˆê¸°ì¼ì€ íŠ¹ë³„í•œ ë‚ ì´ë¯€ë¡œ ìš´ì„¸ ì ìˆ˜ ìƒìŠ¹)
  const ì ˆê¸°ì´ë¦„ = getì ˆê¸°(date);
  const ì ˆê¸°ë³´ì • = getì ˆê¸°ìš´ì„¸ë³´ì •(ì ˆê¸°ì´ë¦„);
  ì ìˆ˜ += ì ˆê¸°ë³´ì •;
  
  return Math.max(1, Math.min(5, ì ìˆ˜));
};

// íŠ¹ì´ì‚¬í•­ ìƒì„± (ìœ¤ë‹¬ ì •ë³´ í¬í•¨)
export const getíŠ¹ì´ì‚¬í•­ = (date: Date, gapja: string, isLeapMonth?: boolean): string[] => {
  const íŠ¹ì´ì‚¬í•­: string[] = [];
  const ì²œê°„ = gapja[0];
  const ì§€ì§€ = gapja[1];
  const ë  = ë ë™ë¬¼[ì§€ì§€];
  const dayOfWeek = date.getDay();
  
  // ğŸ”¥ ìœ¤ë‹¬ ì •ë³´ ìµœìš°ì„  í‘œì‹œ
  if (isLeapMonth) {
    íŠ¹ì´ì‚¬í•­.push('ğŸŒ™+ ìœ¤ë‹¬ (ìŒë ¥ íŠ¹ë³„í•œ ë‹¬)');
  }
  
  if (isì†ì—†ëŠ”ë‚ (date)) {
    íŠ¹ì´ì‚¬í•­.push('ğŸ‘» ì†ì—†ëŠ”ë‚ ');
  }
  
  const { ê¸¸ì¼, í‰ì¼ } = getê¸¸í‰(gapja, date);
  if (ê¸¸ì¼) íŠ¹ì´ì‚¬í•­.push('âœ¨ ê¸¸ì¼');
  if (í‰ì¼) íŠ¹ì´ì‚¬í•­.push('âš ï¸ í‰ì¼');
  
  const ì ˆê¸° = getì ˆê¸°(date);
  if (ì ˆê¸°) {
    const ì ˆê¸°ì •ë³´ = getì ˆê¸°ìƒì„¸ì •ë³´(date);
    if (ì ˆê¸°ì •ë³´) {
      íŠ¹ì´ì‚¬í•­.push(`${ì ˆê¸°ì •ë³´.icon} ${ì ˆê¸°} (${ì ˆê¸°ì •ë³´.description})`);
    } else {
      íŠ¹ì´ì‚¬í•­.push(`ğŸŒ¸ ${ì ˆê¸°}`);
    }
  }
  
  // íŠ¹ë³„í•œ ì¡°í•©
  if (ì²œê°„ === 'ê°‘' && ì§€ì§€ === 'ì') {
    íŠ¹ì´ì‚¬í•­.push('ğŸŒŸ ê°‘ìì¼ (ìƒˆë¡œìš´ ì‹œì‘)');
  }
  
  if (dayOfWeek === 0) {
    íŠ¹ì´ì‚¬í•­.push('â˜€ï¸ ì¼ìš”ì¼ (íœ´ì‹)');
  }
  
  if (ë  === 'ìš©') {
    íŠ¹ì´ì‚¬í•­.push('ğŸ‰ ìš©ì˜ ê¸°ìš´ (ê°•ìš´)');
  }
  
  return íŠ¹ì´ì‚¬í•­;
};

// ===== KASI API ì „ìš© ìº˜ë¦°ë” ë°ì´í„° ìƒì„± =====
// í´ë°± ì—†ìŒ, ì˜¤ë¥˜ ë°œìƒ ì‹œ êµ¬ì²´ì  í‘œê¸° ë° ê¸°ë¡

interface KasiApiError {
  date: Date;
  errorType: 'API_CALL_FAILED' | 'PARSING_FAILED' | 'NETWORK_ERROR' | 'TIMEOUT';
  errorMessage: string;
  timestamp: string;
}

// KASI API ì˜¤ë¥˜ ë¡œê·¸ (ë©”ëª¨ë¦¬ ì €ì¥)
const kasiApiErrors: KasiApiError[] = [];

// ğŸš€ ìµœì í™”ëœ ìº˜ë¦°ë” ë°ì´í„° ìƒì„± (ë°°ì¹˜ ì²˜ë¦¬ + ë¡œì»¬ ìºì‹œ)
export const generateCalendarMonth = async (year: number, month: number): Promise<CalendarDate[]> => {
  const daysInMonth = new Date(year, month, 0).getDate();
  const calendarDates: CalendarDate[] = [];
  
  console.log(`ğŸ”® ìµœì í™”ëœ ìº˜ë¦°ë” ìƒì„± ì‹œì‘: ${year}ë…„ ${month}ì›” (${daysInMonth}ì¼)`);
  
  // ğŸ”¥ ìµœì í™”ëœ 60ê°‘ì íŒ¨í„´ ê¸°ë°˜ ê³„ì‚°: ë‹¨ 1ê°œì˜ ê¸°ì¤€ì ë§Œ KASI API í˜¸ì¶œ
  const referenceDay = 15; // ì›” ì¤‘ìˆœ ê¸°ì¤€ì  (ì•ˆì •ì )
  let kasiReferenceData = null;
  let gapjaOffset = 0; // KASI ê¸°ì¤€ì ê³¼ ë¡œì»¬ ê³„ì‚°ê°„ì˜ ì˜¤í”„ì…‹
  
  // ê¸°ì¤€ì  KASI API í˜¸ì¶œ
  if (referenceDay <= daysInMonth) {
    try {
      kasiReferenceData = await fetchKasiCalendarInfo(year, month, referenceDay);
      if (kasiReferenceData) {
        // KASI ê°‘ìì™€ ë¡œì»¬ ê³„ì‚° ê°‘ì ë¹„êµí•˜ì—¬ ì˜¤í”„ì…‹ ê³„ì‚°
        const referenceDate = new Date(year, month - 1, referenceDay);
        const localGapja = get60ê°‘ìSync(referenceDate);
        const kasiGapja = kasiReferenceData.lunIljin;
        
        // ê°‘ì ë°°ì—´ì—ì„œ ì¸ë±ìŠ¤ ì°¾ê¸°
        const localIndex = ê°‘ì60ìˆœí™˜.indexOf(localGapja);
        const kasiIndex = ê°‘ì60ìˆœí™˜.indexOf(kasiGapja);
        
        if (localIndex !== -1 && kasiIndex !== -1) {
          gapjaOffset = kasiIndex - localIndex;
          console.log(`ğŸ¯ KASI-ë¡œì»¬ ê°‘ì ì˜¤í”„ì…‹ ê³„ì‚°: ${year}-${month}-${referenceDay}`, {
            localGapja, kasiGapja, localIndex, kasiIndex, gapjaOffset
          });
        } else {
          console.error(`âŒ ê°‘ì ë°°ì—´ì—ì„œ ì°¾ê¸° ì‹¤íŒ¨:`, {
            localGapja, kasiGapja, 
            localFound: localIndex !== -1, 
            kasiFound: kasiIndex !== -1
          });
        }
      }
    } catch (error) {
      console.warn(`KASI API ê¸°ì¤€ì  í˜¸ì¶œ ì‹¤íŒ¨ (${year}-${month}-${referenceDay}):`, error);
    }
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month - 1, day);
    
    // ğŸ¯ íŒ¨í„´ ê¸°ë°˜ 60ê°‘ì ê³„ì‚° (KASI ì˜¤í”„ì…‹ ì ìš©)
    let gapja = get60ê°‘ìSync(date);
    let lunarYear, lunarMonth, lunarDay, isLeapMonth, yearPillar, monthPillar;
    
    if (kasiReferenceData) {
      // KASI ì˜¤í”„ì…‹ ì ìš©í•˜ì—¬ ì •í™•í•œ ê°‘ì ê³„ì‚° (ì˜¤í”„ì…‹ì´ 0ì´ì–´ë„ ì ìš©)
      if (!gapja || gapja === 'âŒì˜¤ë¥˜') {
        console.error(`âŒ ê°‘ì ê³„ì‚° ì‹¤íŒ¨: ${year}-${month}-${day}`, { gapja, date });
        gapja = 'ì˜¤ë¥˜';
      } else {
        const localIndex = ê°‘ì60ìˆœí™˜.indexOf(gapja);
        if (localIndex !== -1) {
          let correctedIndex = (localIndex + gapjaOffset) % 60;
          if (correctedIndex < 0) correctedIndex += 60;
          
          const correctedGapja = ê°‘ì60ìˆœí™˜[correctedIndex];
          if (correctedGapja) {
            gapja = correctedGapja;
          } else {
            console.error(`âŒ ë³´ì •ëœ ê°‘ì ì¡°íšŒ ì‹¤íŒ¨:`, { correctedIndex });
            gapja = 'ì˜¤ë¥˜';
          }
          
          // ğŸ” ì˜¤í”„ì…‹ ì ìš© ë¡œê·¸ (9ì›”ë§Œ)
          if (month === 9 && (day === 5 || day === 6)) {
            console.log(`ğŸ”§ 9ì›” ${day}ì¼ ì˜¤í”„ì…‹ ì ìš©:`, {
              ë¡œì»¬ê°‘ì: ê°‘ì60ìˆœí™˜[localIndex],
              ë¡œì»¬ì¸ë±ìŠ¤: localIndex,
              ì˜¤í”„ì…‹: gapjaOffset,
              ë³´ì •ì¸ë±ìŠ¤: correctedIndex,
              ìµœì¢…ê°‘ì: gapja
            });
          }
        } else {
          console.error(`âŒ ë¡œì»¬ ê°‘ì ë°°ì—´ì—ì„œ ì°¾ê¸° ì‹¤íŒ¨:`, { gapja, day });
          gapja = 'ì˜¤ë¥˜';
        }
      }
    } else {
      // KASI ë°ì´í„° ì—†ëŠ” ê²½ìš° ì•ˆì „ì¥ì¹˜
      if (!gapja || gapja === 'âŒì˜¤ë¥˜') {
        gapja = 'ì˜¤ë¥˜';
      }
    }
    
    // ìŒë ¥ ì •ë³´ëŠ” ê¸°ì¤€ì¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì • ê³„ì‚°
    if (kasiReferenceData) {
      const dayDiff = day - referenceDay;
      let estimatedLunarDay = parseInt(kasiReferenceData.lunDay) + dayDiff;
      let estimatedLunarMonth = parseInt(kasiReferenceData.lunMonth);
      
      // ğŸ”¥ ìŒë ¥ ì›” ê²½ê³„ ì²˜ë¦¬ (ì •í™•í•œ ìŒë ¥ ë‹¬ë ¥ ê¸°ì¤€)
      // ìŒë ¥ ì›”ì€ 29ì¼ ë˜ëŠ” 30ì¼ì´ë¯€ë¡œ ì •í™•í•œ ì²˜ë¦¬ í•„ìš”
      while (estimatedLunarDay > 30) {
        estimatedLunarDay -= 30; // 30ì¼ ê¸°ì¤€ìœ¼ë¡œ ì›” ë„˜ê¹€
        estimatedLunarMonth++;
      }
      while (estimatedLunarDay < 1) {
        estimatedLunarDay += 30; // 30ì¼ ê¸°ì¤€ìœ¼ë¡œ ì´ì „ ì›”
        estimatedLunarMonth--;
      }
      
      // ìŒë ¥ ì›” ë²”ìœ„ ë³´ì • (1-12ì›”)
      lunarYear = year; // ê¸°ë³¸ê°’ ì„¤ì •
      if (estimatedLunarMonth > 12) {
        estimatedLunarMonth = 1;
        lunarYear = year + 1;
      } else if (estimatedLunarMonth < 1) {
        estimatedLunarMonth = 12;
        lunarYear = year - 1;
      }
      
      // lunarYearëŠ” ìœ„ì—ì„œ ì´ë¯¸ ë³´ì •ë¨ (ì›” ê²½ê³„ ì²˜ë¦¬ ì‹œ)
      lunarMonth = estimatedLunarMonth;
      lunarDay = estimatedLunarDay;
      isLeapMonth = kasiReferenceData.lunLeapmonth === 'ìœ¤';
      
      // ğŸ”¥ ì…ì¶˜ ê¸°ì¤€ ë…„ì£¼ ê³„ì‚° (60ê°‘ì ê¸°ì¤€)
      yearPillar = getë…„ì£¼(date);
      monthPillar = kasiReferenceData.lunWolgeon || `${month}ì›”ì£¼`;
    } else {
      // ì™„ì „ í´ë°±: ë¡œì»¬ ê³„ì‚°ë§Œ ì‚¬ìš©
      lunarYear = year;
      lunarMonth = 0; // ìŒë ¥ ì •ë³´ ì—†ìŒ
      lunarDay = 0;
      isLeapMonth = false;
      yearPillar = getë…„ì£¼(date);
      monthPillar = `${month}ì›”ì£¼(ì¶”ì •)`;
    }
    
    // ìŒë ¥ ë‚ ì§œ ë¬¸ìì—´ ìƒì„±
    const lunarDate = lunarMonth === 0 || lunarDay === 0 
      ? `ìŒë ¥ ì •ë³´ ì—†ìŒ (KASI API ì˜¤ë¥˜)`
      : `ìŒë ¥ ${lunarYear}ë…„ ${lunarMonth}ì›” ${lunarDay}ì¼${isLeapMonth ? ' (ìœ¤ë‹¬)' : ''}`;
    
    // ê¸°ë³¸ ì •ë³´ ê³„ì‚°
    const ì²œê°„ = gapja[0] || 'ë¯¸';
    const ì§€ì§€ = gapja[1] || 'ì§€';
    const ë  = ë ë™ë¬¼[ì§€ì§€] || 'ë¯¸ì§€';
    const ì˜¤í–‰ = ì˜¤í–‰ë§¤í•‘[ì²œê°„] || 'ë¯¸ì§€';
    const { ê¸¸ì¼, í‰ì¼ } = getê¸¸í‰(gapja, date);
    const ì†ì—†ëŠ”ë‚  = isì†ì—†ëŠ”ë‚ (date);
    const ì ˆê¸° = getì ˆê¸°(date); // ğŸ”¥ ë™ì  KASI ê¸°ë°˜ 24ì ˆê¸°
    const ìš´ì„¸ì ìˆ˜ = getìš´ì„¸ì ìˆ˜(gapja, date);
    const íŠ¹ì´ì‚¬í•­ = getíŠ¹ì´ì‚¬í•­(date, gapja, isLeapMonth); // ğŸ”¥ ìœ¤ë‹¬ ì •ë³´ í¬í•¨
    
    // ğŸ” 9ì›” ì „ì²´ ë‚ ì§œ ê°‘ì ê²€ì¦ ë¡œê·¸ (í•œì‹œì )
    if (month === 9 && year === 2025) {
      console.log(`ğŸ” 9ì›” ${day}ì¼ ê°‘ì ê²€ì¦:`, {
        day,
        finalGapja: gapja,
        dataSource: kasiReferenceData ? 'PATTERN_BASED' : 'LOCAL_ONLY'
      });
    }
    
    calendarDates.push({
      date,
      lunarDate,
      lunarYear,
      lunarMonth,
      lunarDay,
      isLeapMonth,
      gapja,
      zodiac: ë ,
      element: ì˜¤í–‰,
      sonEobNeunNal: ì†ì—†ëŠ”ë‚ ,
      gilil: ê¸¸ì¼,
      í‰ì¼,
      ì ˆê¸°,
      ìš´ì„¸ì ìˆ˜,
      íŠ¹ì´ì‚¬í•­,
      solarCalendarType: 'solar',
      yearPillar,
      monthPillar,
    });
      
  }
  
  console.log(`ğŸ”® íŒ¨í„´ ê¸°ë°˜ ìº˜ë¦°ë” ìƒì„± ì™„ë£Œ: ${year}ë…„ ${month}ì›”`);
  console.log(`âœ… ìƒì„±ëœ ë‚ ì§œ: ${daysInMonth}ì¼ | ğŸ¯ KASI ê¸°ì¤€ì : ${kasiReferenceData ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);
  
  // ğŸ” 9ì›” 5-6ì¼ ìµœì¢… ê²€ì¦ ë¡œê·¸
  if (month === 9 && year === 2025) {
    const day5Data = calendarDates.find(d => d.date.getDate() === 5);
    const day6Data = calendarDates.find(d => d.date.getDate() === 6);
    console.log('ğŸ¯ 9ì›” 5-6ì¼ ìµœì¢… ê²€ì¦:', {
      '5ì¼': day5Data ? `${day5Data.date.getDate()}ì¼ = ${day5Data.gapja}` : 'ë°ì´í„°ì—†ìŒ',
      '6ì¼': day6Data ? `${day6Data.date.getDate()}ì¼ = ${day6Data.gapja}` : 'ë°ì´í„°ì—†ìŒ',
      '5ì¼ì •ë‹µì—¬ë¶€': day5Data?.gapja === 'ì •ì¶•',
      '6ì¼ì •ë‹µì—¬ë¶€': day6Data?.gapja === 'ë¬´ì¸'
    });
  }
  
  
  return calendarDates;
};

// KASI API ì˜¤ë¥˜ í†µê³„ ì¡°íšŒ
export const getKasiApiErrors = (): KasiApiError[] => {
  return [...kasiApiErrors];
};

// KASI API ì˜¤ë¥˜ í†µê³„ ìš”ì•½
export const getKasiApiErrorSummary = () => {
  const total = kasiApiErrors.length;
  const byType = kasiApiErrors.reduce((acc, err) => {
    acc[err.errorType] = (acc[err.errorType] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);
  
  return { total, byType, recentErrors: kasiApiErrors.slice(-5) };
};

// ì›”ë³„ ìš´ì„¸ ë©”ì‹œì§€ ìƒì„±
export const getMonthlyFortune = async (year: number, month: number): Promise<MonthlyFortune> => {
  const dates = await generateCalendarMonth(year, month);
  
  const bestDates = dates
    .filter(d => d.ìš´ì„¸ì ìˆ˜ >= 4)
    .sort((a, b) => b.ìš´ì„¸ì ìˆ˜ - a.ìš´ì„¸ì ìˆ˜)
    .slice(0, 5);
    
  const worstDates = dates
    .filter(d => d.ìš´ì„¸ì ìˆ˜ <= 2)
    .sort((a, b) => a.ìš´ì„¸ì ìˆ˜ - b.ìš´ì„¸ì ìˆ˜)
    .slice(0, 3);
    
  const importantDates = dates.filter(d => 
    d.ì ˆê¸° || d.gilil || d.íŠ¹ì´ì‚¬í•­.length > 1
  );
  
  const monthlyMessages = [
    'ìƒˆí•´ë¥¼ ë§ì´í•˜ëŠ” í¬ë§ì°¬ ë‹¬ì…ë‹ˆë‹¤.',
    'ì‚¬ë‘ì˜ ê¸°ìš´ì´ ê°€ë“í•œ ë‹¬ì…ë‹ˆë‹¤.',
    'ìƒˆë¡œìš´ ì‹œì‘ê³¼ ì„±ì¥ì˜ ë‹¬ì…ë‹ˆë‹¤.',
    'ì•ˆì •ê³¼ ì¡°í™”ë¥¼ ì°¾ëŠ” ë‹¬ì…ë‹ˆë‹¤.',
    'í™œë°œí•œ í™œë™ê³¼ ì„±ì·¨ì˜ ë‹¬ì…ë‹ˆë‹¤.',
    'ê· í˜•ê³¼ í™”í•©ì´ ì¤‘ìš”í•œ ë‹¬ì…ë‹ˆë‹¤.',
    'ì—¬ë¦„ì˜ í™œê¸°ê°€ ë„˜ì¹˜ëŠ” ë‹¬ì…ë‹ˆë‹¤.',
    'í’ì„±í•œ ìˆ˜í™•ì„ ê¸°ëŒ€í•˜ëŠ” ë‹¬ì…ë‹ˆë‹¤.',
    'ë³€í™”ì™€ ì ì‘ì˜ ì§€í˜œê°€ í•„ìš”í•œ ë‹¬ì…ë‹ˆë‹¤.',
    'ê¹Šì´ ìˆëŠ” ì„±ì°°ê³¼ ì¤€ë¹„ì˜ ë‹¬ì…ë‹ˆë‹¤.',
    'ë§ˆë¬´ë¦¬ì™€ ì •ë¦¬ê°€ ì¤‘ìš”í•œ ë‹¬ì…ë‹ˆë‹¤.',
    'í•œ í•´ë¥¼ ëŒì•„ë³´ë©° ê°ì‚¬í•˜ëŠ” ë‹¬ì…ë‹ˆë‹¤.'
  ];
  
  return {
    month,
    year,
    bestDates,
    worstDates,
    importantDates,
    monthlyMessage: monthlyMessages[month - 1]
  };
};

// ì˜¤ëŠ˜ì˜ ìš´ì„¸ ì •ë³´
export const getTodayFortune = async (): Promise<CalendarDate> => {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth() + 1;
  const day = today.getDate();
  
  const monthData = await generateCalendarMonth(year, month);
  return monthData.find(d => d.date.getDate() === day) || monthData[0];
};

// ===== KASI API ì—°ë™ í•¨ìˆ˜ë“¤ =====

// KASI API ê¸°ë³¸ ì„¤ì • (í”„ë¡ì‹œ ì„œë²„ ê²½ìœ )
const KASI_API_BASE = '/api/kasi'; // í”„ë¡ì‹œë¥¼ í†µí•´ CORS ë¬¸ì œ í•´ê²°
const KASI_SERVICE_KEY = 'AR2zMFQPIPEq1WK5i1YIrWJO1jzGpBGGJUxFLQN5TXXWqFgBhC6r9WjKNFa5zWQF'; // ì‹¤ì œ í‚¤

// KASI API ì „ìš© í˜¸ì¶œ í•¨ìˆ˜ (ë°±ì—”ë“œ í”„ë¡ì‹œ ì—°ë™)
export const fetchKasiCalendarInfo = async (year: number, month: number, day: number): Promise<any> => {
  const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
  
  try {
    // ë°±ì—”ë“œ KASI í”„ë¡ì‹œë¥¼ í†µí•´ í˜¸ì¶œ
    const proxyUrl = `/api/kasi/calendar?year=${year}&month=${month}&day=${day}`;
    
    console.log(`ğŸ”® KASI API í”„ë¡ì‹œ í˜¸ì¶œ: ${dateStr}`);
    
    const response = await fetch(proxyUrl, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    
    if (result.success && result.data) {
      console.log(`âœ… KASI API í”„ë¡ì‹œ ì„±ê³µ (${dateStr}):`, result.data);
      return result.data; // lunYear, lunMonth, lunDay, lunIljin ë“±ì´ í¬í•¨ëœ ë°ì´í„°
    } else {
      throw new Error(result.error || 'KASI API í”„ë¡ì‹œ ì‘ë‹µ ì‹¤íŒ¨');
    }
    
  } catch (error) {
    console.warn(`âš ï¸  KASI API í”„ë¡ì‹œ í˜¸ì¶œ ì‹¤íŒ¨ (${dateStr}):`, error);
    return null; // ì‹¤íŒ¨ ì‹œ null ë°˜í™˜í•˜ì—¬ í´ë°± ë¡œì§ ì‹¤í–‰
  }
};

// KASI XML ì‘ë‹µ íŒŒì‹±
const parseKasiXmlResponse = (xmlText: string): any => {
  try {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
    
    const item = xmlDoc.querySelector('item');
    if (!item) return null;

    return {
      lunDay: item.querySelector('lunDay')?.textContent || '',
      lunIljin: item.querySelector('lunIljin')?.textContent || '',
      lunLeapmonth: item.querySelector('lunLeapmonth')?.textContent || 'í‰',
      lunMonth: item.querySelector('lunMonth')?.textContent || '',
      lunNday: item.querySelector('lunNday')?.textContent || '',
      lunSecha: item.querySelector('lunSecha')?.textContent || '',
      lunWolgeon: item.querySelector('lunWolgeon')?.textContent || '',
      lunYear: item.querySelector('lunYear')?.textContent || '',
      solWeek: item.querySelector('solWeek')?.textContent || '',
    };
  } catch (error) {
    console.warn('KASI XML íŒŒì‹± ì‹¤íŒ¨:', error);
    return null;
  }
};

// KASI API ì „ìš© 60ê°‘ì ê³„ì‚° (í´ë°± ì—†ìŒ)
export const getKasi60ê°‘ì = async (date: Date): Promise<string> => {
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  
  const kasiData = await fetchKasiCalendarInfo(year, month, day);
  
  if (!kasiData) {
    throw new Error(`KASI API ì‘ë‹µ ì—†ìŒ: ${year}-${month}-${day}`);
  }
  
  if (!kasiData.lunIljin) {
    throw new Error(`KASI API lunIljin í•„ë“œ ì—†ìŒ: ${year}-${month}-${day}`);
  }
  
  // KASIì—ì„œ ë°›ì€ ì¼ì§„(lunIljin)ì—ì„œ í•œê¸€ ë¶€ë¶„ ì¶”ì¶œ
  // ì˜ˆ: "ì„í•´(ä¹™äº¥)" -> "ì„í•´"
  const match = kasiData.lunIljin.match(/^([ê°€-í£]+)/);
  if (!match) {
    throw new Error(`KASI API lunIljin íŒŒì‹± ì‹¤íŒ¨: ${kasiData.lunIljin}`);
  }
  
  return match[1];
};

// KASI API ì „ìš© ìŒë ¥ ì •ë³´ ê³„ì‚° (í´ë°± ì—†ìŒ)
export const getKasiìŒë ¥ì •ë³´ = async (date: Date): Promise<{
  lunarDate: string;
  lunarYear: number;
  lunarMonth: number;
  lunarDay: number;
  isLeapMonth: boolean;
  yearPillar: string;
  monthPillar: string;
}> => {
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  
  const kasiData = await fetchKasiCalendarInfo(year, month, day);
  
  if (!kasiData) {
    throw new Error(`KASI API ì‘ë‹µ ì—†ìŒ: ${year}-${month}-${day}`);
  }
  
  const lunarYear = parseInt(kasiData.lunYear);
  const lunarMonth = parseInt(kasiData.lunMonth);
  const lunarDay = parseInt(kasiData.lunDay);
  const isLeapMonth = kasiData.lunLeapmonth === 'ìœ¤';
  
  if (!lunarYear || !lunarMonth || !lunarDay) {
    throw new Error(`KASI API ìŒë ¥ ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨: ${JSON.stringify(kasiData)}`);
  }
  
  const lunarDateStr = `ìŒë ¥ ${lunarYear}ë…„ ${lunarMonth}ì›” ${lunarDay}ì¼${isLeapMonth ? ' (ìœ¤ë‹¬)' : ''}`;
  
  return {
    lunarDate: lunarDateStr,
    lunarYear,
    lunarMonth,
    lunarDay,
    isLeapMonth,
    yearPillar: kasiData.lunSecha || 'ì—°ì£¼ë¯¸í™•ì¸',
    monthPillar: kasiData.lunWolgeon || 'ì›”ì£¼ë¯¸í™•ì¸',
  };
};

// 24ì ˆê¸° ì •ë³´ (KASI API ê¸°ë°˜)
const ì ˆê¸°ì •ë³´ = {
  1: [['ì†Œí•œ', 5], ['ëŒ€í•œ', 20]],
  2: [['ì…ì¶˜', 4], ['ìš°ìˆ˜', 19]],
  3: [['ê²½ì¹©', 6], ['ì¶˜ë¶„', 21]],
  4: [['ì²­ëª…', 5], ['ê³¡ìš°', 20]],
  5: [['ì…í•˜', 6], ['ì†Œë§Œ', 21]],
  6: [['ë§ì¢…', 6], ['í•˜ì§€', 21]],
  7: [['ì†Œì„œ', 7], ['ëŒ€ì„œ', 23]],
  8: [['ì…ì¶”', 8], ['ì²˜ì„œ', 23]],
  9: [['ë°±ë¡œ', 8], ['ì¶”ë¶„', 23]],
  10: [['í•œë¡œ', 9], ['ìƒê°•', 24]],
  11: [['ì…ë™', 8], ['ì†Œì„¤', 23]],
  12: [['ëŒ€ì„¤', 7], ['ë™ì§€', 22]],
} as const;

export const getKasiì ˆê¸° = (date: Date): string | null => {
  const month = date.getMonth() + 1;
  const day = date.getDate();
  
  const monthInfo = ì ˆê¸°ì •ë³´[month as keyof typeof ì ˆê¸°ì •ë³´];
  if (!monthInfo) return null;
  
  for (const [name, targetDay] of monthInfo) {
    if (Math.abs(day - targetDay) <= 1) { // Â±1ì¼ ì˜¤ì°¨ í—ˆìš©
      return name;
    }
  }
  
  return null;
};

export default {
  generateCalendarMonth,
  getMonthlyFortune,
  getTodayFortune,
  get60ê°‘ì,
  getKasi60ê°‘ì,
  getKasiìŒë ¥ì •ë³´,
  getKasiì ˆê¸°,
  fetchKasiCalendarInfo,
  getìŒë ¥ë³€í™˜,
  isì†ì—†ëŠ”ë‚ ,
  getê¸¸í‰,
  getì ˆê¸°,
  getìš´ì„¸ì ìˆ˜,
  getíŠ¹ì´ì‚¬í•­,
  getê°‘ìí‘œì‹œ,
  ê°‘ìí•œìë§¤í•‘,
  ì²œê°„,
  ì§€ì§€,
  ë ë™ë¬¼,
  ì˜¤í–‰ë§¤í•‘
};