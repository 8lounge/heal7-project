<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Î¨∏ÏÑú Ìé∏ÏßëÍ∏∞ | Paperwork Editor</title>
    <link rel="stylesheet" href="./css/output.css">
    
    <!-- üé® Enhanced UI/UX Design System -->
    <style>
        /* Modern Glassmorphism & Design System */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glassmorphism-strong {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        /* Unified Card System */
        .card-primary {
            @apply glassmorphism rounded-2xl p-6 transition-all duration-300 hover:shadow-2xl hover:scale-[1.01];
            background: rgba(255, 255, 255, 0.1);
        }
        
        .card-secondary {
            @apply bg-white/5 rounded-xl p-4 border border-white/10 transition-all duration-200 hover:bg-white/10;
        }
        
        /* Enhanced Step Sections */
        .step-section {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .step-section:hover {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
        }
        
        .step-section.minimized {
            max-height: 64px;
            overflow: hidden;
            position: sticky;
            top: 0;
            z-index: 40;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Modern Button System */
        .btn-primary {
            @apply bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl;
        }
        
        .btn-secondary {
            @apply bg-white/10 hover:bg-white/20 text-white py-3 px-6 rounded-xl font-medium transition-all duration-300 border border-white/20 hover:border-white/40;
        }
        
        .btn-outline {
            @apply border-2 border-white/30 hover:border-white/60 text-white hover:bg-white/10 py-2.5 px-5 rounded-lg font-medium transition-all duration-300;
        }
        
        /* Enhanced Typography */
        .text-heading {
            @apply text-white font-bold tracking-tight;
        }
        
        .text-subheading {
            @apply text-white/90 font-semibold;
        }
        
        .text-body {
            @apply text-white/80 font-medium;
        }
        
        .text-caption {
            @apply text-white/60 text-sm;
        }
        
        /* Unified Spacing System */
        .section-spacing {
            @apply space-y-6;
        }
        
        .content-spacing {
            @apply space-y-4;
        }
        
        .item-spacing {
            @apply space-y-3;
        }
        
        /* Enhanced Input System */
        .input-field {
            @apply bg-white/10 border border-white/20 rounded-lg px-4 py-2.5 text-white placeholder-white/50 focus:border-blue-400 focus:ring-2 focus:ring-blue-400/30 transition-all duration-300;
        }
        
        /* Progress & Status Indicators */
        .status-indicator {
            @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium;
        }
        
        .status-success {
            @apply bg-green-500/20 text-green-300 border border-green-500/30;
        }
        
        .status-warning {
            @apply bg-yellow-500/20 text-yellow-300 border border-yellow-500/30;
        }
        
        .status-error {
            @apply bg-red-500/20 text-red-300 border border-red-500/30;
        }
        
        .status-info {
            @apply bg-blue-500/20 text-blue-300 border border-blue-500/30;
        }
        
        /* Enhanced Animations */
        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeInScale {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .animate-slide-in-up {
            animation: slideInUp 0.4s ease-out forwards;
        }
        
        .animate-fade-in-scale {
            animation: fadeInScale 0.3s ease-out forwards;
        }
        
        /* Enhanced Grid & Layout */
        .layout-grid {
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr;
        }
        
        @media (min-width: 1024px) {
            .layout-grid {
                grid-template-columns: 320px 1fr;
                gap: 3rem;
            }
        }
        
        /* Quill Editor Enhancements */
        .ql-toolbar {
            border: none !important;
            border-bottom: 1px solid #e5e7eb !important;
            background: #f8fafc !important;
            border-radius: 0.75rem 0.75rem 0 0 !important;
            padding: 1rem !important;
        }
        
        .ql-container {
            border: none !important;
            font-family: 'Inter', 'Noto Sans KR', system-ui, sans-serif !important;
            font-size: 16px !important;
            line-height: 1.7 !important;
        }
        
        .ql-editor {
            padding: 1.5rem !important;
            min-height: 500px !important;
            color: #1f2937 !important;
        }
        
        /* Enhanced Icons & Visual Elements */
        .icon-container {
            @apply w-12 h-12 rounded-xl flex items-center justify-center text-2xl;
        }
        
        .icon-primary {
            @apply bg-blue-500/20 text-blue-300;
        }
        
        .icon-success {
            @apply bg-green-500/20 text-green-300;
        }
        
        .icon-warning {
            @apply bg-yellow-500/20 text-yellow-300;
        }
        
        /* Enhanced Shadows & Depth */
        .shadow-depth-1 {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .shadow-depth-2 {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }
        
        .shadow-depth-3 {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        
        .shadow-depth-4 {
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.2);
        }
    </style>
    
    <!-- üîß Quill.js Ìé∏ÏßëÍ∏∞ -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <!-- üìÑ PDF.js for page count validation (PDF ÌéòÏù¥ÏßÄ Ïàò Í≤ÄÏ¶ùÏö©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', system-ui, -apple-system, sans-serif; }
        
        .glassmorphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* Î∞ïÏä§ ÏµúÏÜåÌôî Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .step-section {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top;
        }
        
        .step-section.minimized {
            max-height: 60px;
            overflow: hidden;
            position: sticky;
            top: 0;
            z-index: 40;
            backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .step-section.minimized .step-content {
            opacity: 0;
            pointer-events: none;
        }
        
        .step-section.minimized .step-header {
            padding: 0.75rem 1.5rem;
            margin: 0;
        }
        
        .step-section.minimized .step-header h3 {
            font-size: 0.875rem;
            margin-bottom: 0;
        }
        
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        /* Quill Ìé∏ÏßëÍ∏∞ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï */
        .ql-editor {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #1f2937;
        }
        
        .ql-toolbar {
            border-top: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .ql-container {
            border-bottom: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            background: white;
        }
        
        .step-indicator {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300;
        }
        
        .step-indicator.active {
            @apply bg-blue-500 text-white shadow-lg;
        }
        
        .step-indicator.completed {
            @apply bg-green-500 text-white;
        }
        
        .step-indicator.pending {
            @apply bg-white/20 text-white/60;
        }
        
        .step-indicator.locked {
            @apply bg-gray-500/20 text-gray-400/60 cursor-not-allowed;
        }
        
        .ai-tool-card {
            @apply glassmorphism rounded-xl p-4 hover:bg-white/30 transition-all duration-300 cursor-pointer border-2 border-transparent hover:border-blue-300/50;
        }
        
        .ai-tool-card.active {
            @apply border-blue-500 bg-blue-50/80;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900">
    <!-- Toast Notification System -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Ï∂îÏ∂ú ÏäπÏù∏ Î†àÏù¥Ïñ¥ ÌåùÏóÖ (Extraction Approval Modal) -->
    <div id="extractionApprovalModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 rounded-3xl p-8 max-w-2xl mx-4 glassmorphism border border-white/20">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">üìÑ</div>
                <h2 class="text-2xl font-bold text-white mb-2">Î¨∏ÏÑú Ï∂îÏ∂ú ÏäπÏù∏</h2>
                <p class="text-white/70">Îã§Ïùå ÏÑ§Ï†ïÏúºÎ°ú Î¨∏ÏÑúÎ•º Ï∂îÏ∂úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            </div>
            
            <div class="space-y-4 mb-8">
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">Î¨∏ÏÑúÎ™Ö:</span>
                        <span id="extractionDocName" class="text-white font-medium"></span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">AI Î™®Îç∏:</span>
                        <span id="extractionAIModel" class="text-white font-medium"></span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">Ï∂îÏ∂ú Î∞©Ïãù:</span>
                        <span id="extractionType" class="text-white font-medium"></span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">ÏòàÏÉÅ Ï≤òÎ¶¨ ÏãúÍ∞Ñ:</span>
                        <span class="text-yellow-300 font-medium">ÏïΩ 30-60Ï¥à</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="cancelExtraction()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="Ï∂îÏ∂ú ÏûëÏóÖ Ï∑®ÏÜå">
                    Ï∑®ÏÜå
                </button>
                <button onclick="confirmExtraction()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="ÌÖçÏä§Ìä∏ Ï∂îÏ∂ú ÏãúÏûë">
                    Ï∂îÏ∂ú ÏãúÏûë
                </button>
            </div>
        </div>
    </div>

    <!-- AI Auto-fill ÏäπÏù∏ Î™®Îã¨ (AI Auto-fill Consent Modal) -->
    <div id="aiAutoFillModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 rounded-3xl p-8 max-w-2xl mx-4 glassmorphism border border-white/20">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ü§ñ</div>
                <h2 class="text-2xl font-bold text-white mb-2">AI ÏûêÎèô Ï±ÑÏö∞Í∏∞</h2>
                <p class="text-white/70">Îπà Ìï≠Î™©Îì§ÏùÑ AIÍ∞Ä ÏûêÎèôÏúºÎ°ú Ï∂îÎ°†Ìï¥ÏÑú Ï±ÑÏõåÎìúÎ¶¨Í≤†ÏäµÎãàÍπå?</p>
            </div>
            
            <div class="space-y-4 mb-8">
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">Í∞êÏßÄÎêú Îπà ÌïÑÎìú:</span>
                        <span id="blankFieldsCount" class="text-yellow-300 font-medium">0Í∞ú</span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">Ï∞∏Í≥†ÏûêÎ£å:</span>
                        <span id="referenceStatus" class="text-white font-medium">ÏóÜÏùå</span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">Ï∂îÎ°† Î™®Îìú:</span>
                        <span id="inferenceMode" class="text-blue-300 font-medium">ÌëúÏ§Ä</span>
                    </div>
                </div>
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="flex justify-between items-center">
                        <span class="text-white/80">ÏòàÏÉÅ Ï≤òÎ¶¨ ÏãúÍ∞Ñ:</span>
                        <span class="text-yellow-300 font-medium">ÏïΩ 1-2Î∂Ñ</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="cancelAutoFill()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="AI ÏûêÎèô Ï±ÑÏö∞Í∏∞ Ï∑®ÏÜå">
                    Ï∑®ÏÜå
                </button>
                <button onclick="startAutoFillStandard()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="AI ÏûêÎèô Ï±ÑÏö∞Í∏∞ ÌëúÏ§Ä Î™®Îìú ÏãúÏûë">
                    ÌëúÏ§Ä Î™®Îìú
                </button>
                <button onclick="startAutoFillDeep()" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white py-3 px-6 rounded-xl font-semibold transition-all" aria-label="AI ÏûêÎèô Ï±ÑÏö∞Í∏∞ Í≥†Í∏â Î™®Îìú ÏãúÏûë">
                    Think Harder üß†
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced File Upload Loading Modal (Í∞úÏÑ†Îêú ÌååÏùº ÏóÖÎ°úÎìú Î°úÎî© Î™®Îã¨) -->
    <div id="upload-loading" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="glassmorphism bg-white/10 rounded-2xl p-8 text-center max-w-lg">
            <!-- ÎèôÏ†Å ÏïÑÏù¥ÏΩò (Dynamic Icon) -->
            <div class="relative mb-6">
                <div id="loading-icon" class="w-16 h-16 mx-auto">
                    <div class="animate-spin w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                </div>
                <!-- Îã®Í≥ÑÎ≥Ñ ÏïÑÏù¥ÏΩò ÌëúÏãú -->
                <div id="step-icon" class="absolute inset-0 flex items-center justify-center text-3xl opacity-0 transition-opacity duration-500">
                    üìÑ
                </div>
            </div>
            
            <!-- Î©îÏù∏ ÏÉÅÌÉú Î©îÏãúÏßÄ (Main Status Message) -->
            <h3 id="loading-title" class="text-2xl font-semibold text-white mb-3">Î¨∏ÏÑú Ï≤òÎ¶¨ Ï§ë</h3>
            <p id="upload-status" class="text-white/70 mb-4">ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÍ≥† Î∂ÑÏÑùÌïòÎäî Ï§ë...</p>
            
            <!-- ÏßÑÌñâÎ•† Î∞î (Progress Bar) -->
            <div class="w-full bg-white/20 rounded-full h-3 mb-4">
                <div id="upload-progress" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            
            <!-- Îã®Í≥ÑÎ≥Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ (Detailed Step Information) -->
            <div id="processing-steps" class="space-y-2 mb-4">
                <div id="step-file-upload" class="flex items-center justify-between text-sm text-white/60">
                    <span>üìÅ ÌååÏùº ÏóÖÎ°úÎìú</span>
                    <span id="step1-status">ÎåÄÍ∏∞ Ï§ë</span>
                </div>
                <div id="step-page-validation" class="flex items-center justify-between text-sm text-white/60">
                    <span>üìä ÌéòÏù¥ÏßÄ Ïàò Í≤ÄÏ¶ù</span>
                    <span id="step2-status">ÎåÄÍ∏∞ Ï§ë</span>
                </div>
                <div id="step-image-conversion" class="flex items-center justify-between text-sm text-white/60">
                    <span>üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Î≥ÄÌôò</span>
                    <span id="step3-status">ÎåÄÍ∏∞ Ï§ë</span>
                </div>
                <div id="step-ocr-processing" class="flex items-center justify-between text-sm text-white/60">
                    <span>üëÅÔ∏è OCR ÌÖçÏä§Ìä∏ Ï∂îÏ∂ú</span>
                    <span id="step4-status">ÎåÄÍ∏∞ Ï§ë</span>
                </div>
                <div id="step-ai-processing" class="flex items-center justify-between text-sm text-white/60">
                    <span>ü§ñ AI ÌõÑÏ≤òÎ¶¨</span>
                    <span id="step5-status">ÎåÄÍ∏∞ Ï§ë</span>
                </div>
            </div>
            
            <!-- ÌòÑÏû¨ Ï≤òÎ¶¨ Ï§ëÏù∏ ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥ (Current Page Information) -->
            <div id="page-info" class="text-xs text-white/50 mb-2 opacity-0 transition-opacity">
                <span id="current-page">1</span>/<span id="total-pages">1</span> ÌéòÏù¥ÏßÄ Ï≤òÎ¶¨ Ï§ë
            </div>
            
            <!-- ÎèÑÏõÄÎßê Î©îÏãúÏßÄ (Help Message) -->
            <div class="text-xs text-white/50">
                üí° ÎåÄÏö©Îüâ ÌååÏùºÏù¥ÎÇò ÎßéÏùÄ ÌéòÏù¥ÏßÄÏùò Í≤ΩÏö∞ Ï≤òÎ¶¨ ÏãúÍ∞ÑÏù¥ Í∏∏Ïñ¥Ïßà Ïàò ÏûàÏäµÎãàÎã§
            </div>
        </div>
    </div>
    <!-- ÌÜµÌï© ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ìó§Îçî -->
    <header class="glassmorphism backdrop-blur-xl bg-white/10 border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <!-- Î∏åÎûúÎìú & ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
                <div class="flex items-center space-x-6">
                    <a href="index.html" class="flex items-center space-x-3 group">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-white group-hover:text-blue-300 transition-colors">
                                Paperwork AI
                            </div>
                            <div class="text-xs text-white/60">AI Î¨∏ÏÑú Ìé∏ÏßëÍ∏∞</div>
                        </div>
                    </a>
                    
                    <!-- Î∏åÎ†àÎìúÌÅ¨Îüº ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
                    <div class="hidden md:flex items-center space-x-2 text-white/60">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        <span class="text-white font-medium">Ìé∏ÏßëÍ∏∞</span>
                    </div>
                </div>
                
                <!-- Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
                <div class="flex items-center space-x-3">
                    <button onclick="saveDocument()" class="hidden md:flex items-center space-x-2 px-4 py-2 bg-green-500/20 text-green-300 rounded-xl border border-green-400/30 hover:bg-green-500/30 hover:text-green-200 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <span>Ï†ÄÏû•</span>
                    </button>
                    <button onclick="exportDocument()" class="flex items-center space-x-2 px-4 py-2 bg-blue-500/20 text-blue-300 rounded-xl border border-blue-400/30 hover:bg-blue-500/30 hover:text-blue-200 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span class="hidden sm:inline">ÎÇ¥Î≥¥ÎÇ¥Í∏∞</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ÏßÑÌñâ Îã®Í≥Ñ ÌëúÏãú -->
    <section class="glassmorphism bg-white/5 border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-center space-x-8">
                <div class="flex items-center space-x-2">
                    <div id="step1" class="step-indicator active">1</div>
                    <span class="text-sm font-medium text-white/80">Î¨∏ÏÑú ÏóÖÎ°úÎìú</span>
                </div>
                <div class="h-px w-16 bg-white/20"></div>
                <div class="flex items-center space-x-2">
                    <div id="step2" class="step-indicator pending">2</div>
                    <span class="text-sm font-medium text-white/80">Ï∂îÏ∂ú ÏòµÏÖò</span>
                </div>
                <div class="h-px w-16 bg-white/20"></div>
                <div class="flex items-center space-x-2">
                    <div id="step3" class="step-indicator pending">3</div>
                    <span class="text-sm font-medium text-white/80">Ï∞∏Í≥†ÏûêÎ£å</span>
                </div>
                <div class="h-px w-16 bg-white/20"></div>
                <div class="flex items-center space-x-2">
                    <div id="step4" class="step-indicator pending">4</div>
                    <span class="text-sm font-medium text-white/80">Ìé∏Ïßë</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="layout-grid animate-fade-in-scale">
            
            <!-- ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞î - ÏóÖÎ°úÎìú Î∞è AI ÎèÑÍµ¨ -->
            <!-- Mobile Sidebar Toggle -->
            <div class="lg:hidden mb-4">
                <button id="mobileSidebarToggle" class="w-full glassmorphism bg-white/10 text-white px-4 py-3 rounded-xl flex items-center justify-between">
                    <span class="flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                        <span>Î¨∏ÏÑú ÏóÖÎ°úÎìú Î∞è AI ÎèÑÍµ¨</span>
                    </span>
                    <svg id="toggleIcon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>
            <div id="mobileSidebar" class="space-y-6 lg:block hidden animate-slide-in-up">
                
                <!-- 1Îã®Í≥Ñ: Î¨∏ÏÑú ÏóÖÎ°úÎìú -->
                <div id="uploadSection" class="glassmorphism rounded-2xl p-6 shadow-depth-2">
                    <div class="step-header cursor-pointer" onclick="toggleStep1()">
                        <h3 class="text-heading text-lg mb-4 flex items-center justify-between">
                            <span class="flex items-center">
                                <div class="icon-container icon-primary mr-3">üìÑ</div>
                                1. Î¨∏ÏÑú ÏóÖÎ°úÎìú
                            </span>
                            <div id="uploadStatus" class="hidden">
                                <span class="status-indicator status-success animate-pulse">‚úÖ ÏôÑÎ£å</span>
                            </div>
                        </h3>
                    </div>
                    
                    <div class="step-content content-spacing">
                        <div class="border-2 border-dashed border-white/20 rounded-xl p-8 text-center hover:border-blue-400 hover:bg-white/5 transition-all duration-300 group" 
                         id="documentDropZone"
                         ondrop="handleDocumentDrop(event)" 
                         ondragover="handleDragOver(event)" 
                         ondragenter="handleDragEnter(event)" 
                         ondragleave="handleDragLeave(event)">
                        <div class="text-5xl mb-4 group-hover:scale-110 transition-transform duration-300">üìÅ</div>
                        <p class="text-body mb-3">Ï∂îÏ∂úÌï† Î¨∏ÏÑúÎ•º ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò</p>
                        <input type="file" id="documentInput" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" 
                               style="display: none" onchange="handleDocumentSelect(event)">
                        <button onclick="document.getElementById('documentInput').click()" 
                                class="btn-primary mb-4">
                            ÌååÏùº ÏÑ†ÌÉù
                        </button>
                        <div class="item-spacing">
                            <p class="text-caption">PDF, DOC, DOCX, JPG, PNG</p>
                            <p class="text-caption text-orange-300 flex items-center justify-center">
                                <span class="mr-1">‚ö†Ô∏è</span>
                                PDFÎäî 10ÌéòÏù¥ÏßÄ ÎØ∏Îßå ÏóÖÎ°úÎìú Í∏àÏßÄ
                            </p>
                        </div>
                    </div>
                    
                    <!-- ÏóÖÎ°úÎìúÎêú Î¨∏ÏÑú Ï†ïÎ≥¥ -->
                    <div id="documentInfo" class="hidden mt-4 card-secondary border border-blue-400/20 bg-blue-500/10">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="icon-container icon-success">
                                    <span id="documentIcon">üìÑ</span>
                                </div>
                                <div>
                                    <div id="documentName" class="text-body text-sm font-semibold"></div>
                                    <div id="documentSize" class="text-caption"></div>
                                </div>
                            </div>
                            <button onclick="clearDocument()" class="btn-outline p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10">
                                ‚ùå
                            </button>
                        </div>
                        </div>
                    </div>
                </div>
                
                <!-- 2Îã®Í≥Ñ: Ï∂îÏ∂ú ÏòµÏÖò -->
                <div id="extractionSection" class="glassmorphism rounded-2xl p-6 shadow-depth-2 opacity-50 transition-opacity duration-500">
                    <h3 class="text-heading text-lg mb-4 flex items-center">
                        <div class="icon-container icon-primary mr-3">‚öôÔ∏è</div>
                        2. Ï∂îÏ∂ú ÏòµÏÖò
                    </h3>
                    
                    <!-- Ï∂îÏ∂ú ÏòµÏÖò ÏÑ†ÌÉù (Extraction Options) -->
                    <div class="content-spacing mb-6">
                        <h4 class="text-subheading text-sm mb-3 flex items-center">
                            <span class="mr-2">üìù</span>
                            Ï∂îÏ∂ú Î∞©Ïãù
                        </h4>
                        <div class="item-spacing">
                            <label class="card-secondary cursor-pointer hover:scale-[1.02] transition-all duration-200 flex items-center space-x-3">
                                <input type="radio" name="extractionType" value="raw" checked class="w-4 h-4 text-blue-500">
                                <div class="flex-1">
                                    <div class="text-body font-semibold">ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú</div>
                                    <div class="text-caption">OCR Í≤∞Í≥ºÎ•º Í∑∏ÎåÄÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞</div>
                                </div>
                            </label>
                            <label class="card-secondary cursor-pointer hover:scale-[1.02] transition-all duration-200 flex items-center space-x-3">
                                <input type="radio" name="extractionType" value="cleaned" class="w-4 h-4 text-blue-500">
                                <div class="flex-1">
                                    <div class="text-body font-semibold">Ï†ïÎ¶¨Îêú ÌòïÌÉú</div>
                                    <div class="text-caption">ÎßûÏ∂§Î≤ï, ÎùÑÏñ¥Ïì∞Í∏∞ ÍµêÏ†ï</div>
                                </div>
                            </label>
                            <label class="card-secondary cursor-pointer hover:scale-[1.02] transition-all duration-200 flex items-center space-x-3">
                                <input type="radio" name="extractionType" value="structured" class="w-4 h-4 text-blue-500">
                                <div class="flex-1">
                                    <div class="text-body font-semibold">Íµ¨Ï°∞Ìôî</div>
                                    <div class="text-caption">Ï†úÎ™©, Î™©Î°ù, Îã®ÎùΩÏúºÎ°ú Íµ¨Ï°∞Ìôî</div>
                                </div>
                            </label>
                            <label class="card-secondary cursor-pointer hover:scale-[1.02] transition-all duration-200 flex items-center space-x-3">
                                <input type="radio" name="extractionType" value="summarized" class="w-4 h-4 text-blue-500">
                                <div class="flex-1">
                                    <div class="text-body font-semibold">ÏöîÏïΩ</div>
                                    <div class="text-caption">ÌïµÏã¨ ÎÇ¥Ïö©Îßå Í∞ÑÏ∂îÎ†§ÏÑú</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- AI Î™®Îç∏ ÏÑ†ÌÉù (AI Model Selection) -->
                    <div class="content-spacing">
                        <h4 class="text-subheading text-sm mb-3 flex items-center">
                            <span class="mr-2">ü§ñ</span>
                            AI Î™®Îç∏ ÏÑ†ÌÉù
                        </h4>
                        <div class="item-spacing">
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="gemini" checked class="text-google-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-google-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">Google Gemini</div>
                                        <div class="text-xs text-white/60">Ï†ïÌôïÎèÑ ÎÜíÏùå, Îã§Íµ≠Ïñ¥ ÏßÄÏõê</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="gpt-4" class="text-openai-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-openai-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">OpenAI GPT-4</div>
                                        <div class="text-xs text-white/60">Ï∞ΩÏùòÏ†Å Ï≤òÎ¶¨, Î¨∏Îß• Ïù¥Ìï¥</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="claude" class="text-anthropic-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-anthropic-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">Anthropic Claude</div>
                                        <div class="text-xs text-white/60">Î∂ÑÏÑùÎ†• Ïö∞Ïàò, ÏïàÏ†ÑÌïú Ï≤òÎ¶¨</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="perplexity" class="text-perplexity-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-perplexity-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">Perplexity AI</div>
                                        <div class="text-xs text-white/60">Í≤ÄÏÉâ Í∏∞Î∞ò, Ïã§ÏãúÍ∞Ñ Ï†ïÎ≥¥</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg border border-white/20 hover:bg-white/10 transition-all">
                                <input type="radio" name="aiModel" value="clova" class="text-clova-500">
                                <div class="flex items-center space-x-2 flex-1">
                                    <div class="w-3 h-3 bg-clova-500 rounded-full"></div>
                                    <div>
                                        <div class="font-medium text-white text-sm">ÎÑ§Ïù¥Î≤Ñ ÌÅ¥Î°úÎ∞îX</div>
                                        <div class="text-xs text-white/60">ÌïúÍµ≠Ïñ¥ ÌäπÌôî, Î°úÏª¨ Ïª®ÌÖçÏä§Ìä∏</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- AI Î™®Îç∏ ÏÑ§Î™Ö -->
                        <div class="mt-3 p-3 bg-white/5 rounded-lg border border-white/10">
                            <div class="text-xs text-white/70">
                                üí° <strong>Î™®Îç∏ ÏÑ†ÌÉù Í∞ÄÏù¥Îìú:</strong><br>
                                ‚Ä¢ <strong>Gemini</strong>: ÏùºÎ∞òÏ†ÅÏù∏ Î¨∏ÏÑú Ï≤òÎ¶¨Ïóê ÏµúÏ†Å<br>
                                ‚Ä¢ <strong>GPT-4</strong>: Ï∞ΩÏùòÏ†Å Ìé∏Ïßë Î∞è Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω<br>
                                ‚Ä¢ <strong>Claude</strong>: Ï†ïÌôïÌïú Î∂ÑÏÑù Î∞è ÏöîÏïΩ<br>
                                ‚Ä¢ <strong>Perplexity</strong>: ÏµúÏã† Ï†ïÎ≥¥ Í∏∞Î∞ò Î≥¥Í∞ï<br>
                                ‚Ä¢ <strong>ÌÅ¥Î°úÎ∞îX</strong>: ÌïúÍµ≠Ïñ¥ ÌäπÌôî Ï≤òÎ¶¨ Î∞è Î°úÏª¨ Ïª®ÌÖçÏä§Ìä∏
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3Îã®Í≥Ñ: Ï∞∏Í≥†ÏûêÎ£å ÏóÖÎ°úÎìú -->
                <div id="referenceSection" class="glassmorphism rounded-2xl p-6 opacity-50">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <span class="text-2xl mr-2">üìö</span>
                        3. Ï∞∏Í≥†ÏûêÎ£å (ÏÑ†ÌÉù)
                    </h3>
                    
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-4 text-center hover:border-green-400 transition-colors" 
                         id="referenceDropZone"
                         ondrop="handleReferenceDrop(event)" 
                         ondragover="handleDragOver(event)">
                        <div class="text-2xl mb-1">üìö</div>
                        <p class="text-white/60 text-xs mb-2">Ï∞∏Í≥†ÏûêÎ£å ÏóÖÎ°úÎìú</p>
                        <input type="file" id="referenceInput" accept=".pdf,.doc,.docx,.txt,.md" 
                               style="display: none" onchange="handleReferenceSelect(event)" multiple>
                        <button onclick="document.getElementById('referenceInput').click()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition-colors">
                            Ï∂îÍ∞Ä
                        </button>
                    </div>
                    
                    <!-- Ï∞∏Í≥†ÏûêÎ£å Î™©Î°ù -->
                    <div id="referenceList" class="mt-3 space-y-2">
                        <!-- ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                    </div>
                </div>
                
                <!-- AI ÎèÑÍµ¨ -->
                <div id="aiToolsSection" class="glassmorphism rounded-2xl p-6 opacity-50">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <span class="text-2xl mr-2">ü§ñ</span>
                        AI Ìé∏Ïßë ÎèÑÍµ¨
                    </h3>
                    
                    <div class="space-y-3">
                        <button onclick="aiEnhance('summarize')" class="ai-tool-card w-full text-left">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">üìã</span>
                                <div>
                                    <div class="font-medium text-white">ÏöîÏïΩ</div>
                                    <div class="text-xs text-white/60">ÌïµÏã¨ ÎÇ¥Ïö© Ï†ïÎ¶¨</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="aiEnhance('expand')" class="ai-tool-card w-full text-left">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">‚ú®</span>
                                <div>
                                    <div class="font-medium text-white">Î≥¥Í∞ï</div>
                                    <div class="text-xs text-white/60">Ï∞∏Í≥†ÏûêÎ£å Í∏∞Î∞ò ÌôïÏû•</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="aiEnhance('improve')" class="ai-tool-card w-full text-left">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">üîß</span>
                                <div>
                                    <div class="font-medium text-white">Í∞úÏÑ†</div>
                                    <div class="text-xs text-white/60">Î¨∏Ï≤¥, Íµ¨Ï°∞ Í∞úÏÑ†</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="aiEnhance('translate')" class="ai-tool-card w-full text-left">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">üåç</span>
                                <div>
                                    <div class="font-medium text-white">Î≤àÏó≠</div>
                                    <div class="text-xs text-white/60">Îã§Íµ≠Ïñ¥ Î≤àÏó≠</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="detectAndFillBlankFields()" class="ai-tool-card w-full text-left border-l-4 border-l-yellow-400">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">üß©</span>
                                <div>
                                    <div class="font-medium text-white">ÏûêÎèô Ï±ÑÏö∞Í∏∞</div>
                                    <div class="text-xs text-white/60">Îπà Ìï≠Î™© AI Ï∂îÎ°†</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Î©îÏù∏ Ìé∏Ïßë ÏòÅÏó≠ -->
            <div>
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    
                    <!-- Ìé∏ÏßëÍ∏∞ Ìà¥Î∞î (Quill ÏûêÎèô ÏÉùÏÑ±) -->
                    <div id="toolbar">
                        <!-- Í∏∞Î≥∏ Ìè¨Îß∑ÌåÖ -->
                        <span class="ql-formats">
                            <select class="ql-font"></select>
                            <select class="ql-size"></select>
                        </span>
                        
                        <!-- ÌÖçÏä§Ìä∏ Ïä§ÌÉÄÏùº -->
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                            <button class="ql-strike"></button>
                        </span>
                        
                        <!-- ÏÉâÏÉÅ -->
                        <span class="ql-formats">
                            <select class="ql-color"></select>
                            <select class="ql-background"></select>
                        </span>
                        
                        <!-- Ï†ïÎ†¨ -->
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                            <select class="ql-align"></select>
                        </span>
                        
                        <!-- ÏÇΩÏûÖ -->
                        <span class="ql-formats">
                            <button class="ql-link"></button>
                            <button class="ql-image"></button>
                        </span>
                        
                        <!-- Ïã§ÌñâÏ∑®ÏÜå/Îã§ÏãúÏã§Ìñâ -->
                        <span class="ql-formats">
                            <button class="ql-undo"></button>
                            <button class="ql-redo"></button>
                        </span>
                        
                        <!-- AI ÎèÑÍµ¨ Î≤ÑÌäº -->
                        <span class="ql-formats">
                            <button onclick="showAIPanel()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">
                                ü§ñ AI ÎèÑÍµ¨
                            </button>
                        </span>
                    </div>
                    
                    <!-- Ìé∏ÏßëÍ∏∞ Ïª®ÌÖåÏù¥ÎÑà -->
                    <div id="editor" style="height: 600px;">
                        <div class="text-center text-white/40 mt-48">
                            <div class="text-4xl mb-4">üìù</div>
                            <h3 class="text-xl font-semibold mb-2">AI Î¨∏ÏÑú Ìé∏ÏßëÍ∏∞</h3>
                            <p class="text-white/50">ÏôºÏ™ΩÏóêÏÑú Î¨∏ÏÑúÎ•º ÏóÖÎ°úÎìúÌïòÎ©¥ Ìé∏ÏßëÏùÑ ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ìé∏Ïßë ÏÉÅÌÉú ÌëúÏãú -->
                <div class="mt-4 flex items-center justify-between text-sm text-white/60">
                    <div class="flex items-center space-x-4">
                        <span id="wordCount">Îã®Ïñ¥: 0</span>
                        <span id="charCount">Í∏ÄÏûê: 0</span>
                        <span id="lastSaved">Ï†ÄÏû•: ÏïàÎê®</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div id="aiStatus" class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span>AI ÎåÄÍ∏∞</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Paperwork Í≥µÌÜµ ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <link rel="stylesheet" href="css/paperwork-common.css">
    <script src="js/paperwork-common.js"></script>

    <!-- Paperwork Editor Î™®ÎìàÌôîÎêú Ïª¥Ìè¨ÎÑåÌä∏ -->
    <link rel="stylesheet" href="css/editor-styles.css">
    <script src="js/ui-components.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/ai-functions.js"></script>

    <script>
        const API_BASE = 'http://localhost:8002';
        
        // HEAL7 Î°úÎî© ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
        let loadingManager;
        document.addEventListener('DOMContentLoaded', () => {
            loadingManager = new LoadingManager();
            window.HEAL7Loading = window.HEAL7Loading || {};
            window.HEAL7Loading.showAILoading = (message, options) => loadingManager.showAILoading(message, options);
            window.HEAL7Loading.showDataLoading = (message, options) => loadingManager.showDataLoading(message, options);
            window.HEAL7Loading.showUploadLoading = (message, options) => loadingManager.showUploadLoading(message, options);
        });
        
        // üö´ EditorNotifications ÌÅ¥ÎûòÏä§ Ï§ëÎ≥µ ÏÑ†Ïñ∏ Ï†úÍ±∞ (ui-components.jsÏóêÏÑú Ïù¥ÎØ∏ Ï†ïÏùòÎê®)
        
        // üö´ UploadProgress ÌÅ¥ÎûòÏä§ Ï§ëÎ≥µ ÏÑ†Ïñ∏ Ï†úÍ±∞ (ui-components.jsÏóêÏÑú Ïù¥ÎØ∏ Ï†ïÏùòÎê®)
        
        // Global instances (ÌÅ¥ÎûòÏä§Îäî ui-components.jsÏóêÏÑú Ï†ïÏùòÎê®)
        const notify = new EditorNotifications();
        const uploadProgress = new UploadProgress();
        
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let quillEditor = null;
        let selectedDocument = null;
        let referenceDocuments = [];
        let currentStep = 1;
        
        // AI Î¨∏ÏÑú Ìé∏ÏßëÍ∏∞ Ï¥àÍ∏∞Ìôî (AI Document Editor Initialization)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ AI Î¨∏ÏÑú Ìé∏ÏßëÍ∏∞ Ï¥àÍ∏∞Ìôî');
            
            // 1. Quill Ìé∏ÏßëÍ∏∞ Ï¥àÍ∏∞Ìôî
            initializeEditor();
            
            // 2. Îã®Í≥ÑÎ≥Ñ Í∞ÄÏù¥Îìú ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
            stepGuide = new StepGuideManager();
            console.log('‚úÖ Îã®Í≥ÑÎ≥Ñ Í∞ÄÏù¥Îìú ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            
            // 3. 2Îã®Í≥Ñ ÏûêÎèô ÏßÑÌñâ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupStep2AutoProgress();
        });
        
        function initializeEditor() {
            // Quill Ìé∏ÏßëÍ∏∞ ÏÑ§Ï†ï
            quillEditor = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: '#toolbar',
                        handlers: {
                            'undo': function() {
                                this.quill.history.undo();
                            },
                            'redo': function() {
                                this.quill.history.redo();
                            }
                        }
                    },
                    history: {
                        delay: 1000,
                        maxStack: 100,
                        userOnly: true
                    }
                },
                placeholder: 'Ïó¨Í∏∞Ïóê ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÏôºÏ™ΩÏóêÏÑú Î¨∏ÏÑúÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî...'
            });
            
            // ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            quillEditor.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user') {
                    updateWordCount();
                    updateAIStatus('editing');
                }
            });
            
            console.log('‚úÖ Quill Ìé∏ÏßëÍ∏∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        }

        // === 2Îã®Í≥Ñ ÏûêÎèô ÏßÑÌñâ ÏãúÏä§ÌÖú (Step 2 Auto-Progress System) ===
        
        /**
         * 2Îã®Í≥ÑÏóêÏÑú Î™®Îì† ÏÑ†ÌÉùÏù¥ ÏôÑÎ£åÎêòÎ©¥ ÏûêÎèôÏúºÎ°ú 3Îã®Í≥ÑÎ°ú Ïù¥Îèô
         */
        function setupStep2AutoProgress() {
            // AI Î™®Îç∏ ÏÑ†ÌÉù Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
            const aiModelInputs = document.querySelectorAll('input[name="aiModel"]');
            aiModelInputs.forEach((input, index) => {
                input.addEventListener('change', () => {
                    console.log(`üîÑ AI Î™®Îç∏ Î≥ÄÍ≤Ω Í∞êÏßÄ: ${input.value} (${getAIModelDisplayName(input.value)})`);
                    checkStep2Completion();
                });
            });

            // Ï∂îÏ∂ú Î∞©Ïãù ÏÑ†ÌÉù Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏  
            const extractionTypeInputs = document.querySelectorAll('input[name="extractionType"]');
            extractionTypeInputs.forEach((input, index) => {
                input.addEventListener('change', () => {
                    console.log(`üîÑ Ï∂îÏ∂ú Î∞©Ïãù Î≥ÄÍ≤Ω Í∞êÏßÄ: ${input.value} (${getExtractionTypeDisplayName(input.value)})`);
                    checkStep2Completion();
                });
            });

            console.log(`‚úÖ 2Îã®Í≥Ñ ÏûêÎèô ÏßÑÌñâ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ÏôÑÎ£å - AIÎ™®Îç∏: ${aiModelInputs.length}Í∞ú, Ï∂îÏ∂úÎ∞©Ïãù: ${extractionTypeInputs.length}Í∞ú`);
        }

        /**
         * 2Îã®Í≥Ñ ÏôÑÎ£å ÏÉÅÌÉú Ï≤¥ÌÅ¨ Î∞è ÏûêÎèô ÏßÑÌñâ
         */
        function checkStep2Completion() {
            // StepGuideÏùò ÌòÑÏû¨ Îã®Í≥Ñ ÌôïÏù∏
            const currentStepFromGuide = stepGuide ? stepGuide.currentStep : currentStep;
            
            // ÌòÑÏû¨ Îã®Í≥ÑÍ∞Ä 2Îã®Í≥ÑÏù¥Í≥† Î¨∏ÏÑúÍ∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ÏóêÎßå Ï≤¥ÌÅ¨
            if (currentStepFromGuide !== 2 || !selectedDocument) {
                console.log(`‚ùå 2Îã®Í≥Ñ ÏûêÎèô ÏßÑÌñâ Ï°∞Í±¥ ÎØ∏Ï∂©Ï°±: ÌòÑÏû¨Îã®Í≥Ñ=${currentStepFromGuide}, Î¨∏ÏÑúÏÑ†ÌÉù=${!!selectedDocument}`);
                return;
            }

            const selectedAIModel = document.querySelector('input[name="aiModel"]:checked');
            const selectedExtractionType = document.querySelector('input[name="extractionType"]:checked');

            console.log(`üîç 2Îã®Í≥Ñ ÏôÑÎ£å Ï≤¥ÌÅ¨: AIÎ™®Îç∏=${!!selectedAIModel}, Ï∂îÏ∂úÎ∞©Ïãù=${!!selectedExtractionType}`);

            // AI Î™®Îç∏Í≥º Ï∂îÏ∂ú Î∞©ÏãùÏù¥ Î™®Îëê ÏÑ†ÌÉùÎêú Í≤ΩÏö∞
            if (selectedAIModel && selectedExtractionType) {
                console.log(`üéØ 2Îã®Í≥Ñ ÏôÑÎ£å Í∞êÏßÄ! AIÎ™®Îç∏: ${getAIModelDisplayName(selectedAIModel.value)}, Ï∂îÏ∂úÎ∞©Ïãù: ${getExtractionTypeDisplayName(selectedExtractionType.value)}`);
                
                // ÏßßÏùÄ ÏßÄÏó∞ ÌõÑ 3Îã®Í≥ÑÎ°ú ÏûêÎèô Ïù¥Îèô (ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÎèÑÎ°ù)
                setTimeout(() => {
                    if (stepGuide && stepGuide.currentStep === 2) { // Ïó¨Ï†ÑÌûà 2Îã®Í≥ÑÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
                        stepGuide.completeStep(2);
                        stepGuide.moveToStep(3);
                        
                        // 3Îã®Í≥Ñ ÌôúÏÑ±Ìôî ÏïåÎ¶º
                        notify.success('üöÄ ÏÑ§Ï†ï ÏôÑÎ£å! 3Îã®Í≥Ñ(Ï∞∏Í≥†ÏûêÎ£å)Í∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.');
                        
                        console.log('‚úÖ 3Îã®Í≥ÑÎ°ú ÏûêÎèô Ïù¥Îèô ÏôÑÎ£å');
                    }
                }, 800); // 0.8Ï¥à ÏßÄÏó∞
            }
        }
        
        // === PDF ÌéòÏù¥ÏßÄ Ïàò Í≤ÄÏ¶ù Ìï®Ïàò (PDF Page Count Validation) ===
        
        /**
         * PDF ÌååÏùºÏùò ÌéòÏù¥ÏßÄ ÏàòÎ•º ÌôïÏù∏ÌïòÎäî Ìï®Ïàò
         * @param {File} file - Í≤ÄÏ¶ùÌï† PDF ÌååÏùº
         * @returns {Promise<number>} - ÌéòÏù¥ÏßÄ Ïàò
         */
        async function getPDFPageCount(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                
                fileReader.onload = async function(e) {
                    try {
                        // PDF.jsÎ•º ÏÇ¨Ïö©ÌïòÏó¨ PDF ÌååÏùº Î°úÎìú
                        const arrayBuffer = e.target.result;
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        
                        // ÌéòÏù¥ÏßÄ Ïàò Î∞òÌôò
                        resolve(pdf.numPages);
                    } catch (error) {
                        console.error('PDF ÌéòÏù¥ÏßÄ Ïàò ÌôïÏù∏ Ï§ë Ïò§Î•ò:', error);
                        reject(error);
                    }
                };
                
                fileReader.onerror = function() {
                    reject(new Error('ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®'));
                };
                
                fileReader.readAsArrayBuffer(file);
            });
        }

        /**
         * ÌååÏùº ÌÉÄÏûÖÎ≥Ñ ÌéòÏù¥ÏßÄ Ïàò Í≤ÄÏ¶ù
         * @param {File} file - Í≤ÄÏ¶ùÌï† ÌååÏùº
         * @returns {Promise<boolean>} - Í≤ÄÏ¶ù ÌÜµÍ≥º Ïó¨Î∂Ä
         */
        async function validateFilePageCount(file) {
            const MIN_PAGES = 10; // ÏµúÏÜå ÌéòÏù¥ÏßÄ Ïàò (10ÌéòÏù¥ÏßÄ ÎØ∏Îßå Í∏àÏßÄ)
            
            // PDF ÌååÏùºÎßå ÌéòÏù¥ÏßÄ Ïàò Í≤ÄÏ¶ù
            if (file.type === 'application/pdf') {
                try {
                    // ÌéòÏù¥ÏßÄ Ïàò Í≤ÄÏ¶ù Îã®Í≥Ñ ÏãúÏûë
                    uploadProgress.startStep('validation', 'PDF ÌéòÏù¥ÏßÄ Ïàò Î∂ÑÏÑù Ï§ë...', 15);
                    
                    const pageCount = await getPDFPageCount(file);
                    
                    // ÌéòÏù¥ÏßÄ Ïàò ÌôïÏù∏ ÏôÑÎ£å
                    uploadProgress.update(25, `${pageCount}ÌéòÏù¥ÏßÄ ÌôïÏù∏Îê®`);
                    
                    // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏ Ï∂îÍ∞Ä
                    console.log(`üìä PDF ÌéòÏù¥ÏßÄ Í≤ÄÏ¶ù: ${pageCount}ÌéòÏù¥ÏßÄ, ÏµúÏÜå ÏöîÍµ¨: ${MIN_PAGES}ÌéòÏù¥ÏßÄ`);
                    
                    if (pageCount >= MIN_PAGES) {
                        uploadProgress.showError('validation', `${pageCount}ÌéòÏù¥ÏßÄÎäî ÌóàÏö©Îêú ÏµúÎåÄ ÏöîÍµ¨ÏÇ¨Ìï≠(${MIN_PAGES}ÌéòÏù¥ÏßÄ ÎØ∏Îßå)ÏùÑ Ï¥àÍ≥ºÌï©ÎãàÎã§.`);
                        setTimeout(() => uploadProgress.hide(), 3000);
                        notify.warning(`‚ùå Ïù¥ PDFÎäî ${pageCount}ÌéòÏù¥ÏßÄÏûÖÎãàÎã§. ${MIN_PAGES}ÌéòÏù¥ÏßÄ ÎØ∏ÎßåÏùò Î¨∏ÏÑúÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.`);
                        return false;
                    }
                    
                    // Í≤ÄÏ¶ù ÏôÑÎ£å
                    uploadProgress.completeStep('validation', `${pageCount}ÌéòÏù¥ÏßÄ Í≤ÄÏ¶ù ÏôÑÎ£å`);
                    
                    // Î©ÄÌã∞ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥ ÏÑ§Ï†ï
                    if (pageCount > 1) {
                        uploadProgress.updatePageProgress(1, pageCount, 'validation');
                    }
                    
                    return true;
                    
                } catch (error) {
                    uploadProgress.showError('validation', 'PDF ÌååÏùº Î∂ÑÏÑù Ïã§Ìå®');
                    setTimeout(() => uploadProgress.hide(), 3000);
                    notify.error('PDF ÌååÏùºÏùÑ Î∂ÑÏÑùÌï† Ïàò ÏóÜÏäµÎãàÎã§. Ïò¨Î∞îÎ•∏ PDF ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return false;
                }
            }
            
            // PDFÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ (Ïù¥ÎØ∏ÏßÄ, DOC Îì±)Îäî Í≤ÄÏ¶ù ÏôÑÎ£åÎ°ú ÌëúÏãú
            uploadProgress.completeStep('validation', 'ÌååÏùº ÌòïÏãù Í≤ÄÏ¶ù ÏôÑÎ£å');
            return true;
        }

        // === ÌååÏùº ÏóÖÎ°úÎìú Í¥ÄÎ†® Ìï®ÏàòÎì§ ===
        
        function handleDocumentDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleDocumentFile(files[0]);
            }
            document.getElementById('documentDropZone').classList.remove('border-blue-400');
        }
        
        // Enhanced File Upload with Progress and Error Handling (ÏóÖÎ°úÎìú Ï≤òÎ¶¨ Í∞úÏÑ† Î∞è ÏóêÎü¨ Ìï∏Îì§ÎßÅ)
        async function handleDocumentSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Í∏∞Î≥∏ ÌååÏùº Í≤ÄÏ¶ù (Basic File Validation)
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = [".pdf", ".doc", ".docx", ".jpg", ".jpeg", ".png"];
            const fileExt = "." + file.name.split(".").pop().toLowerCase();
            
            // ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏ¶ù
            if (file.size > maxSize) {
                notify.error("ÌååÏùº ÌÅ¨Í∏∞Í∞Ä 10MBÎ•º Ï¥àÍ≥ºÌï©ÎãàÎã§. Îçî ÏûëÏùÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }
            
            // ÌååÏùº ÌÉÄÏûÖ Í≤ÄÏ¶ù  
            if (!allowedTypes.includes(fileExt)) {
                notify.error("ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§. PDF, DOC, DOCX, JPG, PNG ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.");
                return;
            }
            
            try {
                // ÌååÏùº Í≤ÄÏ¶ù ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÏûë (File Validation Process Start)
                uploadProgress.show("ÌååÏùº Í≤ÄÏ¶ù Ï§ë...", "Î¨∏ÏÑú ÏóÖÎ°úÎìú");
                
                // 1Îã®Í≥Ñ: ÌååÏùº ÏóÖÎ°úÎìú 
                uploadProgress.startStep('upload', 'ÌååÏùºÏùÑ ÏÑúÎ≤ÑÏóê ÏóÖÎ°úÎìú Ï§ë...', 30);
                await new Promise(resolve => setTimeout(resolve, 300)); // ÏóÖÎ°úÎìú ÏãúÎÆ¨Î†àÏù¥ÏÖò
                uploadProgress.completeStep('upload', 'ÌååÏùº ÏóÖÎ°úÎìú ÏôÑÎ£å');
                
                // 2Îã®Í≥Ñ: PDF ÌéòÏù¥ÏßÄ Ïàò Í≤ÄÏ¶ù (PDF Page Count Validation)
                uploadProgress.startStep('validation', 'ÌååÏùº Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù Ï§ë...', 70);
                const isValidPageCount = await validateFilePageCount(file);
                if (!isValidPageCount) {
                    uploadProgress.hide();
                    return;
                }
                uploadProgress.completeStep('validation', 'ÌååÏùº Í≤ÄÏ¶ù ÏôÑÎ£å');
                
                // ÏµúÏ¢Ö ÏôÑÎ£å (Final Completion) - OCRÏùÄ "Ï∂îÏ∂úÌïòÍ∏∞" Î≤ÑÌäºÏóêÏÑú Ïã§Ìñâ
                uploadProgress.update(100, "ÌååÏùº ÏóÖÎ°úÎìú ÏôÑÎ£å! Ï∂îÏ∂ú ÏòµÏÖòÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
                
                // ÌååÏùº Ï†ïÎ≥¥ Ï†ÄÏû• (Store file info)
                selectedDocument = file;
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏ (Update UI)
                displayDocumentInfo(file);
                
                // Îã®Í≥ÑÎ≥Ñ Í∞ÄÏù¥Îìú ÏãúÏä§ÌÖú ÏóÖÎç∞Ïù¥Ìä∏
                if (stepGuide) {
                    stepGuide.completeStep(1); // 1Îã®Í≥Ñ ÏôÑÎ£å
                    stepGuide.moveToStep(2);   // 2Îã®Í≥ÑÎ°ú Ïù¥Îèô
                    minimizeStep1(); // 1Îã®Í≥Ñ Î∞ïÏä§ ÏµúÏÜåÌôî
                    
                    // 2Îã®Í≥ÑÎ°ú Ïù¥Îèô ÌõÑ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÏÑ†ÌÉùÌïòÎèÑÎ°ù ÎåÄÍ∏∞
                    // ÏûêÎèô ÏßÑÌñâÌïòÏßÄ ÏïäÏùå - ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë AI Î™®Îç∏Í≥º Ï∂îÏ∂ú Î∞©ÏãùÏùÑ ÌôïÏù∏/ÏÑ†ÌÉùÌï¥Ïïº Ìï®
                    console.log('üìã 2Îã®Í≥ÑÏóêÏÑú AI Î™®Îç∏Í≥º Ï∂îÏ∂ú Î∞©ÏãùÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú ÌõÑ Î™®Îã¨ Ïà®Í∏∞Í∏∞
                setTimeout(() => {
                    uploadProgress.hide();
                    notify.success(`üìÑ "${file.name}" ÌååÏùº Ï≤òÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! Ïù¥Ï†ú 2Îã®Í≥ÑÎ•º ÏßÑÌñâÌïòÏÑ∏Ïöî.`);
                }, 1000);
                
            } catch (error) {
                uploadProgress.showError('upload', 'ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                setTimeout(() => uploadProgress.hide(), 3000);
                console.error("ÏóÖÎ°úÎìú Ïò§Î•ò:", error);
                notify.error("ÌååÏùº ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
            }
        }
        
        // ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠ ÌååÏùº Ï≤òÎ¶¨ (Drag & Drop File Handler) 
        async function handleDocumentFile(file) {
            // Í∏∞Î≥∏ ÌååÏùº Í≤ÄÏ¶ù (Basic File Validation)
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['application/pdf', 'application/msword', 
                                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                'image/jpeg', 'image/png'];
            
            // ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏ¶ù
            if (file.size > maxSize) {
                notify.error('ÌååÏùº ÌÅ¨Í∏∞Îäî 10MBÎ•º Ï¥àÍ≥ºÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÌååÏùº ÌÉÄÏûÖ Í≤ÄÏ¶ù
            if (!allowedTypes.includes(file.type)) {
                notify.error('ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§. PDF, DOC, DOCX, JPG, PNGÎßå ÏßÄÏõêÎê©ÎãàÎã§.');
                return;
            }
            
            try {
                // PDF ÌéòÏù¥ÏßÄ Ïàò Í≤ÄÏ¶ù (PDF Page Count Validation)
                const isValidPageCount = await validateFilePageCount(file);
                if (!isValidPageCount) {
                    // validateFilePageCountÏóêÏÑú Ïù¥ÎØ∏ ÏóêÎü¨ Î©îÏãúÏßÄÎ•º ÌëúÏãúÌï®
                    return;
                }
                
                // ÌååÏùº Ï†ïÎ≥¥ Ï†ÄÏû• Î∞è UI ÏóÖÎç∞Ïù¥Ìä∏
                selectedDocument = file;
                displayDocumentInfo(file);
                moveToStep(2);
                
                notify.success(`"${file.name}" ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!`);
                
            } catch (error) {
                console.error("ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠ ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò:", error);
                notify.error("ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
            }
        }
        
        function displayDocumentInfo(file) {
            const info = document.getElementById('documentInfo');
            const name = document.getElementById('documentName');
            const size = document.getElementById('documentSize');
            const icon = document.getElementById('documentIcon');
            
            name.textContent = file.name;
            size.textContent = formatFileSize(file.size);
            
            // ÌååÏùº ÌÉÄÏûÖÎ≥Ñ ÏïÑÏù¥ÏΩò
            if (file.type.includes('pdf')) icon.textContent = 'üìÑ';
            else if (file.type.includes('word')) icon.textContent = 'üìù';
            else if (file.type.includes('image')) icon.textContent = 'üñºÔ∏è';
            else icon.textContent = 'üìÑ';
            
            info.classList.remove('hidden');
        }
        
        // === Î∞ïÏä§ ÏµúÏÜåÌôî Í¥ÄÎ†® Ìï®ÏàòÎì§ ===
        function minimizeStep1() {
            const uploadSection = document.getElementById('uploadSection');
            const uploadStatus = document.getElementById('uploadStatus');
            
            // 1Îã®Í≥Ñ Î∞ïÏä§ ÏµúÏÜåÌôî
            uploadSection.classList.add('minimized');
            
            // ÏôÑÎ£å ÏÉÅÌÉú ÌëúÏãú
            uploadStatus.classList.remove('hidden');
            
            // Ïä§ÌÅ¨Î°§ÏùÑ ÌòÑÏû¨ ÏúÑÏπòÏóê Ïú†ÏßÄ (Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ)
            const currentScrollY = window.scrollY;
            
            setTimeout(() => {
                window.scrollTo(0, currentScrollY);
            }, 100);
        }
        
        function expandStep1() {
            const uploadSection = document.getElementById('uploadSection');
            const uploadStatus = document.getElementById('uploadStatus');
            
            // 1Îã®Í≥Ñ Î∞ïÏä§ ÌôïÏû•
            uploadSection.classList.remove('minimized');
            uploadStatus.classList.add('hidden');
        }
        
        function minimizeStep2() {
            const extractionSection = document.getElementById('extractionSection');
            extractionSection.classList.add('minimized');
        }
        
        function toggleStep1() {
            const uploadSection = document.getElementById('uploadSection');
            if (uploadSection.classList.contains('minimized')) {
                expandStep1();
            } else {
                minimizeStep1();
            }
        }
        
        // === Ï∂îÏ∂ú ÌîÑÎ°úÏÑ∏Ïä§ Í¥ÄÎ†® Ìï®ÏàòÎì§ ===
        function startExtraction() {
            // Ï∂îÏ∂ú ÏäπÏù∏ Î™®Îã¨ ÌëúÏãú
            showExtractionApprovalModal();
        }
        
        function showExtractionApprovalModal() {
            const modal = document.getElementById('extractionApprovalModal');
            const docName = document.getElementById('extractionDocName');
            const aiModel = document.getElementById('extractionAIModel');
            const extractType = document.getElementById('extractionType');
            
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∞íÎì§Î°ú Î™®Îã¨ ÎÇ¥Ïö© Ï±ÑÏö∞Í∏∞
            if (selectedDocument) {
                docName.textContent = selectedDocument.name;
            }
            
            const selectedAIModel = getSelectedAIModel();
            aiModel.textContent = getAIModelDisplayName(selectedAIModel);
            
            const selectedExtractionType = getSelectedExtractionType();
            extractType.textContent = getExtractionTypeDisplayName(selectedExtractionType);
            
            // Î™®Îã¨ ÌëúÏãú
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function hideExtractionApprovalModal() {
            const modal = document.getElementById('extractionApprovalModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        function cancelExtraction() {
            hideExtractionApprovalModal();
        }
        
        function confirmExtraction() {
            hideExtractionApprovalModal();
            // Ïã§Ï†ú Ï∂îÏ∂ú ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÏûë
            performExtraction();
        }
        
        async function performExtraction() {
            if (!selectedDocument) {
                notify.error("Ï∂îÏ∂úÌï† Î¨∏ÏÑúÍ∞Ä ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
                return;
            }
            
            try {
                const selectedAIModel = getSelectedAIModel();
                const extractionType = getSelectedExtractionType();
                
                console.log(`üìÑ Î¨∏ÏÑú Ï∂îÏ∂ú ÏãúÏûë - Î™®Îç∏: ${getAIModelDisplayName(selectedAIModel)}, Î∞©Ïãù: ${extractionType}`);
                
                // ÎÑ§Ïù¥Î≤Ñ OCR Î∞è AI Ï≤òÎ¶¨ Îã®Í≥ÑÎ≥Ñ ÌëúÏãú
                uploadProgress.show("Î¨∏ÏÑú Ï∂îÏ∂úÏùÑ ÏãúÏûëÌï©ÎãàÎã§...", "ÎÑ§Ïù¥Î≤Ñ OCR + AI Î∂ÑÏÑù");
                
                // 1Îã®Í≥Ñ: Ïù¥ÎØ∏ÏßÄ Î≥ÄÌôò
                uploadProgress.startStep('conversion', 'Î¨∏ÏÑúÎ•º Ïù¥ÎØ∏ÏßÄÎ°ú Î≥ÄÌôò Ï§ë...', 20);
                
                // 2Îã®Í≥Ñ: ÎÑ§Ïù¥Î≤Ñ OCR Ï≤òÎ¶¨  
                uploadProgress.startStep('ocr', 'ÎÑ§Ïù¥Î≤Ñ ÌÅ¥Î°úÎ∞îX OCRÎ°ú ÌÖçÏä§Ìä∏ Ï∂îÏ∂ú Ï§ë...', 60);
                
                // 3Îã®Í≥Ñ: AI ÌõÑÏ≤òÎ¶¨
                uploadProgress.startStep('ai', `${getAIModelDisplayName(selectedAIModel)}Î°ú ÌÖçÏä§Ìä∏ Î∂ÑÏÑù Ï§ë...`, 90);
                
                const formData = new FormData();
                formData.append('file', selectedDocument);
                formData.append('ai_model', selectedAIModel);
                formData.append('extraction_type', extractionType);
                
                const response = await fetch(`${API_BASE}/ai-edit/process-multipart`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üìÑ Ï∂îÏ∂ú ÏÑ±Í≥µ:', result);
                    
                    // Ï∂îÏ∂ú ÏôÑÎ£å ÌõÑ Ìé∏ÏßëÏ∞ΩÏóê ÎÇ¥Ïö© ÌëúÏãú
                    displayExtractedContent(result.data);
                    
                    uploadProgress.hide();
                    notify.success("Î¨∏ÏÑú Ï∂îÏ∂úÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!");
                    
                    // 2Îã®Í≥Ñ Î∞ïÏä§ ÏµúÏÜåÌôî
                    minimizeStep2();
                    
                } else {
                    throw new Error('Ï∂îÏ∂ú ÏöîÏ≤≠Ïù¥ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
                
            } catch (error) {
                console.error('Ï∂îÏ∂ú Ïò§Î•ò:', error);
                uploadProgress.hide();
                notify.error("Î¨∏ÏÑú Ï∂îÏ∂ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
            }
        }
        
        // ÏÑ†ÌÉùÎêú AI Î™®Îç∏ Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedAIModel() {
            const selected = document.querySelector('input[name="aiModel"]:checked');
            return selected ? selected.value : 'gemini';
        }
        
        // ÏÑ†ÌÉùÎêú Ï∂îÏ∂ú Î∞©Ïãù Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedExtractionType() {
            const selected = document.querySelector('input[name="extractionType"]:checked');
            return selected ? selected.value : 'raw';
        }
        
        // Ï∂îÏ∂ú Î∞©Ïãù ÌëúÏãúÎ™Ö Î≥ÄÌôò
        function getExtractionTypeDisplayName(type) {
            const typeMap = {
                'raw': 'ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú',
                'enhanced': 'Ï∂îÎ°†ÏúºÎ°ú Í∞úÏÑ†',
                'formatted': 'Íµ¨Ï°∞Ìôî'
            };
            return typeMap[type] || type;
        }
        
        // === Ï∂îÏ∂ú Í≤∞Í≥º ÌéòÏù¥ÏßÄ Î∑∞Ïñ¥ ÏãúÏä§ÌÖú ===
        let extractedData = null;
        let currentViewMode = 'continuous'; // 'continuous' ÎòêÎäî 'paged'
        let currentPage = 1;
        
        async function displayExtractedContent(data) {
            extractedData = data;
            
            if (!data || !data.pages) {
                notify.error("Ï∂îÏ∂úÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.");
                return;
            }
            
            const pageCount = data.pages.length;
            console.log(`üìÑ Ï∂îÏ∂úÎêú ÌéòÏù¥ÏßÄ Ïàò: ${pageCount}`);
            
            // Ìé∏ÏßëÍ∏∞ ÏòÅÏó≠ÏúºÎ°ú Ïä§ÌÅ¨Î°§
            const editorArea = document.getElementById('editorArea');
            if (editorArea) {
                editorArea.scrollIntoView({ behavior: 'smooth' });
            }
            
            // üß† AI Î¨∏ÏÑú ÌòïÌÉú Î∂ÑÏÑù ÏãúÏûë
            notify.info('üß† AIÍ∞Ä Î¨∏ÏÑú ÌòïÌÉúÎ•º Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...');
            
            try {
                const documentAnalysis = await analyzeDocumentType(data);
                console.log('üìã Î¨∏ÏÑú ÌòïÌÉú Î∂ÑÏÑù Í≤∞Í≥º:', documentAnalysis);
                
                // Î∂ÑÏÑù Í≤∞Í≥ºÏóê Îî∞Îùº Îã§Î•∏ ÌëúÏãú Î∞©Î≤ï Ï†ÅÏö©
                displayContentByDocumentType(data, documentAnalysis);
                
            } catch (error) {
                console.error('Î¨∏ÏÑú Î∂ÑÏÑù Ïò§Î•ò:', error);
                notify.warning('Î¨∏ÏÑú Î∂ÑÏÑùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Í∏∞Î≥∏ Î™®ÎìúÎ°ú ÌëúÏãúÌï©ÎãàÎã§.');
                
                // Í∏∞Î≥∏ Î™®ÎìúÎ°ú Ìè¥Î∞±
                displayDefaultView(data);
            }
        }
        
        /**
         * AIÎ•º ÌÜµÌïú Î¨∏ÏÑú ÌòïÌÉú Î∂ÑÏÑù
         * @param {Object} data - Ï∂îÏ∂úÎêú Î¨∏ÏÑú Îç∞Ïù¥ÌÑ∞
         * @returns {Promise<Object>} Î¨∏ÏÑú Î∂ÑÏÑù Í≤∞Í≥º
         */
        async function analyzeDocumentType(data) {
            // Ï≤´ Î≤àÏß∏ ÌéòÏù¥ÏßÄ ÎÇ¥Ïö©ÏùÑ Í∏∞Ï§ÄÏúºÎ°ú Î∂ÑÏÑù
            const firstPageContent = data.pages[0]?.content || '';
            const allContent = data.pages.map(page => page.content).join('\n');
            
            const analysisData = {
                content: firstPageContent,
                full_content: allContent.substring(0, 2000), // Ï≤òÏùå 2000ÏûêÎ°ú Ï†úÌïú
                page_count: data.pages.length,
                ai_model: getSelectedAIModel()
            };
            
            const response = await fetch(`${API_BASE}/ai-edit/analyze-document-type`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(analysisData)
            });
            
            if (!response.ok) {
                throw new Error('Î¨∏ÏÑú Î∂ÑÏÑù API Ìò∏Ï∂ú Ïã§Ìå®');
            }
            
            return await response.json();
        }
        
        /**
         * Î¨∏ÏÑú ÌòïÌÉúÏóê Îî∞Î•∏ ÎÇ¥Ïö© ÌëúÏãú
         * @param {Object} data - Ï∂îÏ∂úÎêú Î¨∏ÏÑú Îç∞Ïù¥ÌÑ∞  
         * @param {Object} analysis - AI Î∂ÑÏÑù Í≤∞Í≥º
         */
        function displayContentByDocumentType(data, analysis) {
            const documentType = analysis.document_type;
            const confidence = analysis.confidence;
            
            // Î∂ÑÏÑù Í≤∞Í≥º ÌëúÏãú
            showDocumentAnalysisResult(analysis);
            
            switch (documentType) {
                case 'form':
                case 'application':
                    displayFormDocument(data, analysis);
                    break;
                    
                case 'contract':
                case 'legal':
                    displayStructuredDocument(data, analysis);
                    break;
                    
                case 'report':
                case 'article':
                    displayContinuousDocument(data, analysis);
                    break;
                    
                default:
                    displayDefaultView(data);
            }
        }
        
        /**
         * ÏûÖÎ†•ÏñëÏãù Î¨∏ÏÑú ÌëúÏãú (Ìèº ÌòïÌÉú)
         */
        function displayFormDocument(data, analysis) {
            console.log('üìù ÏûÖÎ†•ÏñëÏãù Î¨∏ÏÑúÎ°ú ÌåêÎã®Îê®');
            notify.success('üìù ÏûÖÎ†•ÏñëÏãù Î¨∏ÏÑúÍ∞Ä Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§. Îπà ÌïÑÎìúÎ•º ÏûêÎèôÏúºÎ°ú ÌëúÏãúÌï©ÎãàÎã§.');
            
            // ÌéòÏù¥ÏßÄ Î∑∞Ïñ¥ Î™®Îìú ÏÑ†ÌÉù ÌëúÏãú (10ÌéòÏù¥ÏßÄ Ïù¥ÏÉÅÏùº Îïå)
            if (data.pages.length >= 10) {
                showViewModeSelector();
            }
            
            // Ìèº Î¨∏ÏÑúÎäî Ïó∞ÏÜç Î≥¥Í∏∞Î°ú ÌëúÏãúÌïòÎêò Îπà ÌïÑÎìú Í∞ïÏ°∞
            displayContinuousViewWithFormHighlights(data, analysis);
            
            // ÏûêÎèô Îπà ÌïÑÎìú Í∞êÏßÄ Î∞è Ï±ÑÏö∞Í∏∞ Î≤ÑÌäº ÌôúÏÑ±Ìôî
            setTimeout(() => {
                detectAndHighlightFormFields();
            }, 1000);
        }
        
        /**
         * Íµ¨Ï°∞ÌôîÎêú Î¨∏ÏÑú ÌëúÏãú (Í≥ÑÏïΩÏÑú, Î≤ïÎ•† Î¨∏ÏÑú Îì±)
         */
        function displayStructuredDocument(data, analysis) {
            console.log('üìã Íµ¨Ï°∞ÌôîÎêú Î¨∏ÏÑúÎ°ú ÌåêÎã®Îê®');
            notify.success('üìã Íµ¨Ï°∞ÌôîÎêú Î¨∏ÏÑúÍ∞Ä Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§.');
            
            displayContinuousView();
            initializePageNavigation();
        }
        
        /**
         * Ïó∞ÏÜç Î¨∏ÏÑú ÌëúÏãú (Î≥¥Í≥†ÏÑú, Í∏∞ÏÇ¨ Îì±)
         */
        function displayContinuousDocument(data, analysis) {
            console.log('üìÑ Ïó∞ÏÜç Î¨∏ÏÑúÎ°ú ÌåêÎã®Îê®'); 
            notify.success('üìÑ Ïó∞ÏÜç Î¨∏ÏÑúÍ∞Ä Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§.');
            
            if (data.pages.length >= 10) {
                showViewModeSelector();
            }
            
            displayContinuousView();
            initializePageNavigation();
        }
        
        /**
         * Í∏∞Î≥∏ Î≥¥Í∏∞ (Î∂ÑÏÑù Ïã§Ìå® Ïãú Ìè¥Î∞±)
         */
        function displayDefaultView(data) {
            console.log('üìÑ Í∏∞Î≥∏ Î™®ÎìúÎ°ú ÌëúÏãú');
            
            // ÌéòÏù¥ÏßÄ Î∑∞Ïñ¥ Î™®Îìú ÏÑ†ÌÉù ÌëúÏãú (10ÌéòÏù¥ÏßÄ Ïù¥ÏÉÅÏùº Îïå)
            if (data.pages.length >= 10) {
                showViewModeSelector();
            }
            
            // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ïó∞ÏÜç Î≥¥Í∏∞Î°ú ÏãúÏûë
            displayContinuousView();
            
            // ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ï¥àÍ∏∞Ìôî
            initializePageNavigation();
        }
        
        /**
         * Î¨∏ÏÑú Î∂ÑÏÑù Í≤∞Í≥º ÌëúÏãú
         */
        function showDocumentAnalysisResult(analysis) {
            const editorContainer = document.querySelector('.lg\\:col-span-3');
            if (!editorContainer) return;
            
            // Í∏∞Ï°¥ Î∂ÑÏÑù Í≤∞Í≥º Ï†úÍ±∞
            const existingResult = document.getElementById('documentAnalysisResult');
            if (existingResult) existingResult.remove();
            
            const resultDiv = document.createElement('div');
            resultDiv.id = 'documentAnalysisResult';
            resultDiv.className = 'mb-4 p-4 glassmorphism rounded-xl';
            
            const typeEmoji = {
                'form': 'üìù',
                'application': 'üìã',
                'contract': 'üìú',
                'legal': '‚öñÔ∏è',
                'report': 'üìä',
                'article': 'üì∞'
            };
            
            const typeName = {
                'form': 'ÏûÖÎ†• ÏñëÏãù',
                'application': 'Ïã†Ï≤≠ÏÑú',
                'contract': 'Í≥ÑÏïΩÏÑú',
                'legal': 'Î≤ïÎ•† Î¨∏ÏÑú',
                'report': 'Î≥¥Í≥†ÏÑú',
                'article': 'Í∏∞ÏÇ¨/Î¨∏ÏÑú'
            };
            
            const confidence = Math.round((analysis.confidence || 0.8) * 100);
            
            resultDiv.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-white flex items-center">
                        <span class="text-2xl mr-2">üß†</span>
                        AI Î¨∏ÏÑú Î∂ÑÏÑù Í≤∞Í≥º
                    </h4>
                    <div class="text-sm text-white/60">Ïã†Î¢∞ÎèÑ: ${confidence}%</div>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-white/10 rounded-lg">
                    <span class="text-3xl">${typeEmoji[analysis.document_type] || 'üìÑ'}</span>
                    <div>
                        <div class="text-white font-medium">${typeName[analysis.document_type] || 'ÏùºÎ∞ò Î¨∏ÏÑú'}</div>
                        <div class="text-white/70 text-sm">${analysis.description || 'AIÍ∞Ä Î¨∏ÏÑú ÌòïÌÉúÎ•º Î∂ÑÏÑùÌñàÏäµÎãàÎã§.'}</div>
                    </div>
                </div>
                ${analysis.form_fields ? `
                    <div class="mt-3 p-2 bg-yellow-500/20 rounded-lg">
                        <div class="text-yellow-300 text-sm font-medium">Í∞êÏßÄÎêú ÏûÖÎ†• ÌïÑÎìú: ${analysis.form_fields.length}Í∞ú</div>
                    </div>
                ` : ''}
            `;
            
            // Ìé∏ÏßëÍ∏∞ ÏïûÏóê ÏÇΩÏûÖ
            const editorTitle = editorContainer.querySelector('h3');
            if (editorTitle) {
                editorTitle.parentNode.insertBefore(resultDiv, editorTitle);
            }
        }
        
        /**
         * Ìèº ÌïÑÎìúÍ∞Ä Í∞ïÏ°∞Îêú Ïó∞ÏÜç Î≥¥Í∏∞ ÌëúÏãú
         */
        function displayContinuousViewWithFormHighlights(data, analysis) {
            if (!extractedData || !extractedData.pages) return;
            
            let combinedContent = '';
            extractedData.pages.forEach((page, index) => {
                combinedContent += `<div class="page-break" data-page="${index + 1}">`;
                combinedContent += `<div class="page-header text-xs text-gray-400 mb-2 border-b border-gray-600 pb-1">ÌéòÏù¥ÏßÄ ${index + 1}</div>`;
                
                // Ìèº ÌïÑÎìú Í∞ïÏ°∞ Ï≤òÎ¶¨
                let pageContent = page.content || '';
                pageContent = highlightFormFields(pageContent, analysis.form_fields);
                
                combinedContent += pageContent;
                combinedContent += '</div>';
                if (index < extractedData.pages.length - 1) {
                    combinedContent += '<div class="page-divider my-4 border-t border-gray-600"></div>';
                }
            });
            
            // Quill Ìé∏ÏßëÍ∏∞Ïóê ÎÇ¥Ïö© ÏÑ§Ï†ï
            if (window.quillEditor) {
                quillEditor.root.innerHTML = combinedContent;
            }
            
            // ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌëúÏãú
            showPageNavigation();
        }
        
        /**
         * ÌÖçÏä§Ìä∏ÏóêÏÑú Ìèº ÌïÑÎìú Í∞ïÏ°∞
         */
        function highlightFormFields(content, formFields) {
            if (!formFields || formFields.length === 0) return content;
            
            let highlightedContent = content;
            
            // ÏùºÎ∞òÏ†ÅÏù∏ Ìèº Ìå®ÌÑ¥Îì§ÏùÑ Í∞ïÏ°∞
            const formPatterns = [
                { pattern: /\[[\s]*\]/g, className: 'form-field-empty' },
                { pattern: /____+/g, className: 'form-field-underline' },
                { pattern: /\([\s]*\)/g, className: 'form-field-brackets' },
                { pattern: /Ôºö[\s]*$/gm, className: 'form-field-colon' },
                { pattern: /:\s*$/gm, className: 'form-field-colon' }
            ];
            
            formPatterns.forEach(({ pattern, className }) => {
                highlightedContent = highlightedContent.replace(pattern, (match) => {
                    return `<span class="${className} bg-yellow-200 border border-yellow-400 px-1 rounded">${match}</span>`;
                });
            });
            
            return highlightedContent;
        }
        
        /**
         * Ìèº ÌïÑÎìú Í∞êÏßÄ Î∞è Í∞ïÏ°∞ (ÌõÑÏ≤òÎ¶¨)
         */
        function detectAndHighlightFormFields() {
            console.log('üîç Ìèº ÌïÑÎìú Í∞êÏßÄ Î∞è Í∞ïÏ°∞ Ïã§Ìñâ');
            
            // Ìé∏ÏßëÍ∏∞ÏóêÏÑú Îπà ÌïÑÎìúÎì§ Í∞êÏßÄ
            const editor = document.querySelector('#editor .ql-editor');
            if (!editor) return;
            
            // Îπà ÌïÑÎìú Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
            const style = document.createElement('style');
            style.innerHTML = `
                .form-field-empty { 
                    background-color: rgba(255, 235, 59, 0.3) !important; 
                    border: 1px dashed #ffeb3b !important; 
                    padding: 2px 4px !important; 
                    border-radius: 3px !important;
                    cursor: pointer !important;
                }
                .form-field-underline { 
                    background-color: rgba(255, 193, 7, 0.3) !important; 
                    border-bottom: 2px solid #ffc107 !important; 
                    cursor: pointer !important;
                }
                .form-field-brackets { 
                    background-color: rgba(76, 175, 80, 0.3) !important; 
                    border: 1px solid #4caf50 !important; 
                    border-radius: 3px !important;
                    cursor: pointer !important;
                }
                .form-field-colon { 
                    background-color: rgba(33, 150, 243, 0.3) !important; 
                    border-left: 3px solid #2196f3 !important; 
                    padding-left: 4px !important;
                    cursor: pointer !important;
                }
            `;
            document.head.appendChild(style);
            
            // Ìèº ÌïÑÎìú ÌÅ¥Î¶≠ Ïãú ÏûêÎèô Ï±ÑÏö∞Í∏∞ Ï†úÏïà
            const formFields = editor.querySelectorAll('.form-field-empty, .form-field-underline, .form-field-brackets, .form-field-colon');
            formFields.forEach((field, index) => {
                field.addEventListener('click', () => {
                    console.log(`üìù Ìèº ÌïÑÎìú ${index + 1} ÌÅ¥Î¶≠Îê®`);
                    suggestAutoFill(field);
                });
            });
            
            if (formFields.length > 0) {
                notify.success(`üìù ${formFields.length}Í∞úÏùò ÏûÖÎ†• ÌïÑÎìúÍ∞Ä Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§. ÌïÑÎìúÎ•º ÌÅ¥Î¶≠ÌïòÎ©¥ ÏûêÎèô Ï±ÑÏö∞Í∏∞Î•º Ï†úÏïàÌï©ÎãàÎã§.`);
            }
        }
        
        /**
         * ÌäπÏ†ï ÌïÑÎìúÏóê ÎåÄÌïú ÏûêÎèô Ï±ÑÏö∞Í∏∞ Ï†úÏïà
         */
        function suggestAutoFill(fieldElement) {
            // Í∞ÑÎã®Ìïú Ìà¥ÌåÅ ÌëúÏãú
            const tooltip = document.createElement('div');
            tooltip.className = 'absolute z-50 bg-gray-800 text-white text-xs px-2 py-1 rounded shadow-lg';
            tooltip.textContent = 'Ïù¥ ÌïÑÎìúÎ•º ÏûêÎèôÏúºÎ°ú Ï±ÑÏö∞Î†§Î©¥ AI ÏûêÎèô Ï±ÑÏö∞Í∏∞ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî';
            
            document.body.appendChild(tooltip);
            
            const rect = fieldElement.getBoundingClientRect();
            tooltip.style.top = `${rect.bottom + 5}px`;
            tooltip.style.left = `${rect.left}px`;
            
            // 3Ï¥à ÌõÑ Ï†úÍ±∞
            setTimeout(() => {
                tooltip.remove();
            }, 3000);
        }
        
        function showViewModeSelector() {
            const editorContainer = document.querySelector('.lg\\:col-span-3');
            
            const viewModeSelector = document.createElement('div');
            viewModeSelector.id = 'viewModeSelector';
            viewModeSelector.className = 'mb-4 p-4 glassmorphism rounded-xl';
            viewModeSelector.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-white flex items-center">
                        <span class="text-2xl mr-2">üëÅÔ∏è</span>
                        Î≥¥Í∏∞ Î™®Îìú ÏÑ†ÌÉù
                    </h4>
                    <div class="text-sm text-white/60">${extractedData.pages.length}ÌéòÏù¥ÏßÄ</div>
                </div>
                <div class="flex gap-3">
                    <button onclick="switchViewMode('continuous')" 
                            id="continuousBtn" 
                            class="flex-1 view-mode-btn active bg-blue-500/20 text-blue-300 border border-blue-400/30 py-2 px-4 rounded-lg transition-all hover:bg-blue-500/30">
                        <div class="flex items-center justify-center space-x-2">
                            <span>üìÑ</span>
                            <span class="font-medium">Ïó∞ÏÜç Î≥¥Í∏∞</span>
                        </div>
                        <div class="text-xs opacity-75 mt-1">Word Î¨∏ÏÑúÏ≤òÎüº ÏÑ∏Î°úÎ°ú</div>
                    </button>
                    <button onclick="switchViewMode('paged')" 
                            id="pagedBtn" 
                            class="flex-1 view-mode-btn bg-white/10 text-white/70 border border-white/20 py-2 px-4 rounded-lg transition-all hover:bg-white/20">
                        <div class="flex items-center justify-center space-x-2">
                            <span>üìñ</span>
                            <span class="font-medium">ÌéòÏù¥ÏßÄ Î≥¥Í∏∞</span>
                        </div>
                        <div class="text-xs opacity-75 mt-1">Ìïú ÌéòÏù¥ÏßÄÏî© Î≥¥Í∏∞</div>
                    </button>
                </div>
            `;
            
            // Ìé∏ÏßëÍ∏∞ ÏïûÏóê ÏÇΩÏûÖ
            const editorTitle = document.querySelector('#editorArea h3');
            if (editorTitle) {
                editorTitle.parentNode.insertBefore(viewModeSelector, editorTitle);
            }
        }
        
        function switchViewMode(mode) {
            currentViewMode = mode;
            
            // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-500/20', 'text-blue-300', 'border-blue-400/30');
                btn.classList.add('bg-white/10', 'text-white/70', 'border-white/20');
            });
            
            const activeBtn = mode === 'continuous' ? 
                document.getElementById('continuousBtn') : 
                document.getElementById('pagedBtn');
                
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-500/20', 'text-blue-300', 'border-blue-400/30');
                activeBtn.classList.remove('bg-white/10', 'text-white/70', 'border-white/20');
            }
            
            // Î≥¥Í∏∞ Î™®ÎìúÏóê Îî∞Îùº ÎÇ¥Ïö© ÌëúÏãú
            if (mode === 'continuous') {
                displayContinuousView();
            } else {
                displayPagedView();
            }
        }
        
        function displayContinuousView() {
            if (!extractedData || !extractedData.pages) return;
            
            let combinedContent = '';
            extractedData.pages.forEach((page, index) => {
                combinedContent += `<div class="page-break" data-page="${index + 1}">`;
                combinedContent += `<div class="page-header text-xs text-gray-400 mb-2 border-b border-gray-600 pb-1">ÌéòÏù¥ÏßÄ ${index + 1}</div>`;
                combinedContent += page.content || '';
                combinedContent += '</div>';
                if (index < extractedData.pages.length - 1) {
                    combinedContent += '<div class="page-divider my-4 border-t border-gray-600"></div>';
                }
            });
            
            // Quill Ìé∏ÏßëÍ∏∞Ïóê ÎÇ¥Ïö© ÏÑ§Ï†ï
            if (window.quill) {
                quill.root.innerHTML = combinedContent;
            }
            
            // ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌëúÏãú
            showPageNavigation();
        }
        
        function displayPagedView() {
            if (!extractedData || !extractedData.pages) return;
            
            const page = extractedData.pages[currentPage - 1];
            if (page) {
                // Quill Ìé∏ÏßëÍ∏∞Ïóê ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÎÇ¥Ïö© ÏÑ§Ï†ï
                if (window.quill) {
                    quill.root.innerHTML = page.content || '';
                }
            }
            
            // ÌéòÏù¥ÏßÄ Ïª®Ìä∏Î°§Îü¨ ÌëúÏãú
            showPageController();
        }
        
        function showPageNavigation() {
            // VSCode Ïä§ÌÉÄÏùºÏùò ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò (Ïö∞Ï∏° ÏÉÅÎã®)
            const editorContainer = document.querySelector('#editorArea');
            if (!editorContainer || !extractedData) return;
            
            const existingNav = document.getElementById('pageNavigation');
            if (existingNav) existingNav.remove();
            
            const navigation = document.createElement('div');
            navigation.id = 'pageNavigation';
            navigation.className = 'fixed top-20 right-4 z-30 glassmorphism rounded-lg p-2 max-h-80 overflow-y-auto';
            navigation.innerHTML = `
                <div class="text-xs text-white/80 mb-2 font-semibold">ÌéòÏù¥ÏßÄ Ïù¥Îèô</div>
                <div class="space-y-1">
                    ${extractedData.pages.map((page, index) => `
                        <button onclick="scrollToPage(${index + 1})" 
                                class="block w-full text-left px-2 py-1 text-xs text-white/70 hover:bg-white/20 rounded transition-all">
                            ${index + 1}ÌéòÏù¥ÏßÄ
                        </button>
                    `).join('')}
                </div>
            `;
            
            document.body.appendChild(navigation);
        }
        
        function showPageController() {
            const editorContainer = document.querySelector('#editorArea');
            if (!editorContainer || !extractedData) return;
            
            const existingController = document.getElementById('pageController');
            if (existingController) existingController.remove();
            
            const controller = document.createElement('div');
            controller.id = 'pageController';
            controller.className = 'mb-4 flex items-center justify-between p-3 glassmorphism rounded-lg';
            controller.innerHTML = `
                <button onclick="previousPage()" 
                        ${currentPage <= 1 ? 'disabled' : ''}
                        class="flex items-center space-x-2 px-3 py-2 bg-blue-500/20 text-blue-300 rounded-lg transition-all hover:bg-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>‚Üê</span>
                    <span>Ïù¥Ï†Ñ</span>
                </button>
                
                <div class="flex items-center space-x-4">
                    <span class="text-white/80">ÌéòÏù¥ÏßÄ</span>
                    <input type="number" 
                           id="pageInput" 
                           value="${currentPage}" 
                           min="1" 
                           max="${extractedData.pages.length}"
                           onchange="goToPage(this.value)"
                           class="w-16 px-2 py-1 bg-white/10 text-white rounded border border-white/20 text-center">
                    <span class="text-white/60">/ ${extractedData.pages.length}</span>
                </div>
                
                <button onclick="nextPage()" 
                        ${currentPage >= extractedData.pages.length ? 'disabled' : ''}
                        class="flex items-center space-x-2 px-3 py-2 bg-blue-500/20 text-blue-300 rounded-lg transition-all hover:bg-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>Îã§Ïùå</span>
                    <span>‚Üí</span>
                </button>
            `;
            
            const quillContainer = document.querySelector('#editor');
            if (quillContainer) {
                quillContainer.parentNode.insertBefore(controller, quillContainer);
            }
        }
        
        function initializePageNavigation() {
            // ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ï¥àÍ∏∞Ìôî
            if (currentViewMode === 'continuous') {
                showPageNavigation();
            } else {
                showPageController();
            }
        }
        
        function scrollToPage(pageNumber) {
            if (currentViewMode === 'continuous') {
                const pageElement = document.querySelector(`[data-page="${pageNumber}"]`);
                if (pageElement) {
                    pageElement.scrollIntoView({ behavior: 'smooth' });
                }
            }
        }
        
        function goToPage(pageNumber) {
            const page = parseInt(pageNumber);
            if (page >= 1 && page <= extractedData.pages.length) {
                currentPage = page;
                if (currentViewMode === 'paged') {
                    displayPagedView();
                }
            }
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayPagedView();
            }
        }
        
        function nextPage() {
            if (currentPage < extractedData.pages.length) {
                currentPage++;
                displayPagedView();
            }
        }
        
        
        function clearDocument() {
            selectedDocument = null;
            document.getElementById('documentInfo').classList.add('hidden');
            document.getElementById('documentInput').value = '';
            moveToStep(1);
        }
        
        // === Ï∞∏Í≥†ÏûêÎ£å Í¥ÄÎ†® Ìï®ÏàòÎì§ ===
        
        function handleReferenceDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            for (let i = 0; i < files.length; i++) {
                addReferenceFile(files[i]);
            }
        }
        
        function handleReferenceSelect(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                addReferenceFile(files[i]);
            }
        }
        
        function addReferenceFile(file) {
            if (referenceDocuments.find(doc => doc.name === file.name)) {
                showNotification('Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêú ÌååÏùºÏûÖÎãàÎã§.', 'warning');
                return;
            }
            
            referenceDocuments.push(file);
            displayReferenceList();
        }
        
        function displayReferenceList() {
            const list = document.getElementById('referenceList');
            list.innerHTML = '';
            
            referenceDocuments.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 bg-green-50 rounded border border-green-200';
                item.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-sm">üìö</span>
                        <div>
                            <div class="text-xs font-medium text-green-800">${file.name}</div>
                            <div class="text-xs text-green-600">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button onclick="removeReference(${index})" class="text-red-500 hover:text-red-700 text-xs">‚ùå</button>
                `;
                list.appendChild(item);
            });
        }
        
        function removeReference(index) {
            referenceDocuments.splice(index, 1);
            displayReferenceList();
        }
        
        // === Îã®Í≥ÑÎ≥Ñ Í∞ÄÏù¥Îìú ÏãúÏä§ÌÖú (Step-by-Step Guide System) ===
        
        /**
         * Îã®Í≥ÑÎ≥Ñ UI ÏÉÅÌÉú Í¥ÄÎ¶¨ ÌÅ¥ÎûòÏä§
         */
        class StepGuideManager {
            constructor() {
                this.currentStep = 1;
                this.maxUnlockedStep = 1;
                this.stepSections = {
                    1: 'uploadSection',
                    2: 'extractionSection', 
                    3: 'referenceSection',
                    4: 'aiToolsSection'
                };
                
                this.stepIndicators = {
                    1: 'step1',
                    2: 'step2',
                    3: 'step3', 
                    4: 'step4'
                };
                
                this.init();
            }
            
            /**
             * Îã®Í≥ÑÎ≥Ñ Í∞ÄÏù¥Îìú ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
             */
            init() {
                this.updateAllSteps();
                this.addStepClickHandlers();
            }
            
            /**
             * ÌäπÏ†ï Îã®Í≥ÑÎ°ú Ïù¥Îèô (Ï°∞Í±¥Î∂Ä)
             * @param {number} targetStep - Ïù¥ÎèôÌï† Îã®Í≥Ñ
             * @param {boolean} forceUnlock - Í∞ïÏ†ú Ïû†Í∏à Ìï¥Ï†ú Ïó¨Î∂Ä
             */
            moveToStep(targetStep, forceUnlock = false) {
                if (targetStep > this.maxUnlockedStep && !forceUnlock) {
                    notify.warning(`${targetStep}Îã®Í≥ÑÎäî Ïù¥Ï†Ñ Îã®Í≥Ñ ÏôÑÎ£å ÌõÑ ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.`);
                    return false;
                }
                
                this.currentStep = targetStep;
                
                // Ï†ÑÏó≠ currentStepÎèÑ ÎèôÍ∏∞Ìôî
                currentStep = targetStep;
                
                this.updateAllSteps();
                
                // Îã®Í≥ÑÎ≥Ñ ÌäπÎ≥Ñ Ï≤òÎ¶¨
                this.handleStepSpecialActions(targetStep);
                
                // Îã®Í≥Ñ Ïù¥Îèô Ïãú Ïä§ÌÅ¨Î°§
                const targetSection = document.getElementById(this.stepSections[targetStep]);
                if (targetSection) {
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return true;
            }
            
            /**
             * Îã®Í≥ÑÎ≥Ñ ÌäπÎ≥Ñ Ïï°ÏÖò Ï≤òÎ¶¨
             * @param {number} step - ÌòÑÏû¨ Îã®Í≥Ñ
             */
            handleStepSpecialActions(step) {
                switch (step) {
                    case 2:
                        // 2Îã®Í≥Ñ: Ï∂îÏ∂ú ÏãúÏûë Î≤ÑÌäº Ï∂îÍ∞Ä
                        setTimeout(() => {
                            if (selectedDocument && !document.getElementById('startExtractionBtn')) {
                                addStartExtractionButton();
                            }
                        }, 500);
                        break;
                    case 4:
                        // 4Îã®Í≥Ñ: AI ÎèÑÍµ¨ ÌôúÏÑ±Ìôî ÏïàÎÇ¥
                        setTimeout(() => {
                            notify.info('ü§ñ AI Ìé∏Ïßë ÎèÑÍµ¨Í∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. ÌÖçÏä§Ìä∏Î•º ÏÑ†ÌÉùÌïòÍ≥† ÏõêÌïòÎäî Ìé∏Ïßë ÎèÑÍµ¨Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.');
                        }, 500);
                        break;
                }
            }
            
            /**
             * Îã®Í≥Ñ ÏôÑÎ£å Ï≤òÎ¶¨
             * @param {number} step - ÏôÑÎ£åÎêú Îã®Í≥Ñ
             */
            completeStep(step) {
                if (step === this.maxUnlockedStep) {
                    this.maxUnlockedStep = Math.min(4, step + 1);
                }
                
                this.updateStepIndicator(step, 'completed');
                this.updateAllSteps();
                
                // Îã§Ïùå Îã®Í≥Ñ ÏûêÎèô ÏïàÎÇ¥
                if (step < 4) {
                    setTimeout(() => {
                        notify.info(`${step + 1}Îã®Í≥ÑÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. Í≥ÑÏÜç ÏßÑÌñâÌïòÏÑ∏Ïöî.`);
                    }, 500);
                }
            }
            
            /**
             * Îã®Í≥Ñ ÌëúÏãúÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
             * @param {number} step - Îã®Í≥Ñ Î≤àÌò∏
             * @param {string} status - ÏÉÅÌÉú (active, completed, pending, locked)
             */
            updateStepIndicator(step, status) {
                const indicator = document.getElementById(this.stepIndicators[step]);
                if (!indicator) return;
                
                indicator.className = 'step-indicator';
                
                switch (status) {
                    case 'active':
                        indicator.classList.add('active');
                        break;
                    case 'completed':
                        indicator.classList.add('completed');
                        break;
                    case 'pending':
                        indicator.classList.add('pending');
                        break;
                    case 'locked':
                        indicator.classList.add('locked');
                        break;
                }
            }
            
            /**
             * ÏÑπÏÖò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             * @param {number} step - Îã®Í≥Ñ Î≤àÌò∏
             * @param {string} status - ÏÉÅÌÉú (active, completed, locked)
             */
            updateSectionStatus(step, status) {
                const section = document.getElementById(this.stepSections[step]);
                if (!section) return;
                
                section.classList.remove('opacity-50', 'opacity-25', 'pointer-events-none');
                
                switch (status) {
                    case 'active':
                        // ÌôúÏÑ± ÏÉÅÌÉú: ÏôÑÏ†ÑÌûà ÏÇ¨Ïö© Í∞ÄÎä•
                        break;
                    case 'completed':
                        // ÏôÑÎ£å ÏÉÅÌÉú: ÏïΩÍ∞Ñ ÌùêÎ¶¨Í≤å ÌïòÏßÄÎßå Ï†ëÍ∑º Í∞ÄÎä•
                        section.classList.add('opacity-75');
                        break;
                    case 'locked':
                        // Ïû†Í∏à ÏÉÅÌÉú: ÌùêÎ¶¨Í≤å ÌïòÍ≥† ÌÅ¥Î¶≠ Ï∞®Îã®
                        section.classList.add('opacity-25', 'pointer-events-none');
                        break;
                }
            }
            
            /**
             * Î™®Îì† Îã®Í≥Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             */
            updateAllSteps() {
                for (let step = 1; step <= 4; step++) {
                    let status = 'locked';
                    
                    if (step < this.maxUnlockedStep) {
                        status = 'completed';
                    } else if (step === this.maxUnlockedStep) {
                        status = step === this.currentStep ? 'active' : 'pending';
                    }
                    
                    this.updateStepIndicator(step, status);
                    this.updateSectionStatus(step, step <= this.maxUnlockedStep ? 
                        (step === this.currentStep ? 'active' : 'completed') : 'locked');
                }
            }
            
            /**
             * Îã®Í≥Ñ ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ Ï∂îÍ∞Ä
             */
            addStepClickHandlers() {
                for (let step = 1; step <= 4; step++) {
                    const indicator = document.getElementById(this.stepIndicators[step]);
                    if (indicator) {
                        indicator.style.cursor = 'pointer';
                        indicator.addEventListener('click', () => {
                            this.moveToStep(step);
                        });
                    }
                }
            }
        }
        
        // Ï†ÑÏó≠ Îã®Í≥Ñ Í¥ÄÎ¶¨Ïûê Ïù∏Ïä§ÌÑ¥Ïä§
        let stepGuide = null;

        // === Îã®Í≥Ñ Í¥ÄÎ¶¨ ===
        
        // Í∏∞Ï°¥ moveToStep Ìï®ÏàòÎ•º StepGuideManagerÎ°ú ÎûòÌïë
        function moveToStep(step) {
            if (stepGuide) {
                return stepGuide.moveToStep(step);
            }
            
            // Ìè¥Î∞±: Í∏∞Ï°¥ Î°úÏßÅ (stepGuideÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞)
            currentStep = step;
            console.warn('StepGuideManagerÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïÑ Í∏∞Ï°¥ Î°úÏßÅÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.');
        }
        
        function addStartExtractionButton() {
            const referenceSection = document.getElementById('referenceSection');
            
            // Í∏∞Ï°¥ Î≤ÑÌäºÏù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            const existingBtn = document.getElementById('startExtractionBtn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            const button = document.createElement('button');
            button.id = 'startExtractionBtn';
            button.className = 'w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105';
            button.innerHTML = 'üöÄ Î¨∏ÏÑú Ï∂îÏ∂ú ÏãúÏûë';
            button.onclick = () => {
                // 3Îã®Í≥Ñ ÌôúÏÑ±Ìôî
                if (stepGuide) {
                    stepGuide.completeStep(2); // 2Îã®Í≥Ñ ÏôÑÎ£å
                    stepGuide.moveToStep(3);   // 3Îã®Í≥ÑÎ°ú Ïù¥Îèô
                }
                
                // Ïã§Ï†ú Ï∂îÏ∂ú ÏãúÏûë
                startExtraction();
            };
            referenceSection.appendChild(button);
        }
        
        // === AI Î™®Îç∏ Í¥ÄÎ¶¨ Ìï®Ïàò (AI Model Management Functions) ===
        
        /**
         * ÌòÑÏû¨ ÏÑ†ÌÉùÎêú AI Î™®Îç∏ÏùÑ Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò
         * @returns {string} - ÏÑ†ÌÉùÎêú AI Î™®Îç∏Î™Ö
         */
        function getSelectedAIModel() {
            const selectedModel = document.querySelector('input[name="aiModel"]:checked');
            return selectedModel ? selectedModel.value : 'gemini'; // Í∏∞Î≥∏Í∞í: gemini
        }
        
        /**
         * AI Î™®Îç∏Î≥Ñ ÌëúÏãú Ïù¥Î¶ÑÏùÑ Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò
         * @param {string} modelValue - Î™®Îç∏ Í∞í
         * @returns {string} - ÌëúÏãú Ïù¥Î¶Ñ
         */
        function getAIModelDisplayName(modelValue) {
            const modelNames = {
                'gemini': 'Google Gemini',
                'gpt-4': 'OpenAI GPT-4', 
                'claude': 'Anthropic Claude',
                'perplexity': 'Perplexity AI',
                'clova': 'ÎÑ§Ïù¥Î≤Ñ ÌÅ¥Î°úÎ∞îX'
            };
            return modelNames[modelValue] || modelValue;
        }

        // === Î¨∏ÏÑú Ï∂îÏ∂ú Î∞è AI Ï≤òÎ¶¨ ===
        
        async function startExtraction() {
            if (!selectedDocument) {
                showNotification('Î¨∏ÏÑúÎ•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            const extractionType = document.querySelector('input[name="extractionType"]:checked').value;
            const button = document.getElementById('startExtractionBtn');
            const originalText = button.textContent;
            
            button.textContent = 'üîÑ Ï∂îÏ∂ú Ï§ë...';
            button.disabled = true;
            
            updateAIStatus('processing');
            
            try {
                // FormData ÏÉùÏÑ± (Form Data Creation)
                const formData = new FormData();
                const selectedAIModel = getSelectedAIModel(); // ÏÑ†ÌÉùÎêú AI Î™®Îç∏ Í∞ÄÏ†∏Ïò§Í∏∞
                
                formData.append('file', selectedDocument);
                formData.append('model', selectedAIModel); // ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù Î™®Îç∏
                formData.append('tasks', JSON.stringify([extractionType]));
                formData.append('output_format', 'markdown');
                
                console.log(`üìÑ Î¨∏ÏÑú Ï∂îÏ∂ú ÏãúÏûë - Î™®Îç∏: ${getAIModelDisplayName(selectedAIModel)}, Î∞©Ïãù: ${extractionType}`);
                
                // Ï∞∏Í≥†ÏûêÎ£åÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
                if (referenceDocuments.length > 0) {
                    const referenceTexts = [];
                    for (const refFile of referenceDocuments) {
                        // Ï∞∏Í≥†ÏûêÎ£å ÌÖçÏä§Ìä∏ Ï∂îÏ∂ú (Í∞ÑÎã®Ìïú ÏãúÎÆ¨Î†àÏù¥ÏÖò)
                        referenceTexts.push(`[Ï∞∏Í≥†ÏûêÎ£å: ${refFile.name}]`);
                    }
                    formData.append('reference_text', referenceTexts.join('\n\n'));
                }
                
                // API Ìò∏Ï∂ú
                const response = await fetch(`${API_BASE}/ai-edit/process-multipart`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Ìé∏ÏßëÍ∏∞Ïóê Ï∂îÏ∂úÎêú ÌÖçÏä§Ìä∏ ÏÇΩÏûÖ
                    insertExtractedText(result.data.edited_text);
                    
                    // Îã®Í≥ÑÎ≥Ñ Í∞ÄÏù¥Îìú ÏãúÏä§ÌÖú ÏóÖÎç∞Ïù¥Ìä∏
                    if (stepGuide) {
                        stepGuide.completeStep(3); // 3Îã®Í≥Ñ ÏôÑÎ£å
                        stepGuide.moveToStep(4);   // 4Îã®Í≥ÑÎ°ú Ïù¥Îèô
                    }
                    
                    updateAIStatus('ready');
                    notify.success('Î¨∏ÏÑúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï∂îÏ∂úÎêòÏñ¥ Ìé∏ÏßëÍ∏∞Ïóê Î°úÎìúÎêòÏóàÏäµÎãàÎã§! Ïù¥Ï†ú AI Ìé∏Ïßë ÎèÑÍµ¨Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.');
                } else {
                    throw new Error(result.error || 'Ï∂îÏ∂ú Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
                
            } catch (error) {
                console.error('‚ùå Î¨∏ÏÑú Ï∂îÏ∂ú Ïò§Î•ò:', error);
                showNotification(`Ï∂îÏ∂ú Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'error');
                updateAIStatus('error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        function insertExtractedText(text) {
            // Quill Ìé∏ÏßëÍ∏∞Ïóê ÌÖçÏä§Ìä∏ ÏÇΩÏûÖ
            quillEditor.root.innerHTML = ''; // Í∏∞Ï°¥ ÎÇ¥Ïö© ÌÅ¥Î¶¨Ïñ¥
            quillEditor.clipboard.dangerouslyPasteHTML(0, text);
            updateWordCount();
        }
        
        // === AI Ìé∏Ïßë ÎèÑÍµ¨ ===
        
        // aiEnhance Î∞è getTaskName Ìï®ÏàòÎì§ÏùÄ ai-functions.js Î™®ÎìàÎ°ú Ïù¥ÎèôÎê®
        
        // === Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§ ===
        
        function updateWordCount() {
            const text = quillEditor.getText();
            const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const chars = text.length;
            
            document.getElementById('wordCount').textContent = `Îã®Ïñ¥: ${words}`;
            document.getElementById('charCount').textContent = `Í∏ÄÏûê: ${chars}`;
        }
        
        function updateAIStatus(status) {
            const statusEl = document.getElementById('aiStatus');
            const statusConfig = {
                'ready': { color: 'bg-green-400', text: 'AI Ï§ÄÎπÑÎê®' },
                'processing': { color: 'bg-blue-400 animate-pulse', text: 'AI Ï≤òÎ¶¨ Ï§ë' },
                'editing': { color: 'bg-yellow-400', text: 'Ìé∏Ïßë Ï§ë' },
                'error': { color: 'bg-red-400', text: 'AI Ïò§Î•ò' }
            };
            
            const config = statusConfig[status] || { color: 'bg-gray-400', text: 'AI ÎåÄÍ∏∞' };
            statusEl.innerHTML = `
                <div class="w-2 h-2 ${config.color} rounded-full"></div>
                <span>${config.text}</span>
            `;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showNotification(message, type = 'info') {
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]}/90 backdrop-blur-sm text-white p-4 rounded-2xl z-50 max-w-md animate-slide-up border`;
            notification.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="text-2xl">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</div>
                    <div class="flex-1">
                        <div class="text-sm">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="text-white/80 hover:text-white transition-colors">‚úï</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // ÎìúÎûòÍ∑∏ Ïò§Î≤Ñ Ìï∏Îì§Îü¨Îì§
        function handleDragOver(event) {
            event.preventDefault();
        }
        
        function handleDragEnter(event) {
            event.preventDefault();
            event.currentTarget.classList.add('border-blue-400');
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            if (!event.currentTarget.contains(event.relatedTarget)) {
                event.currentTarget.classList.remove('border-blue-400');
            }
        }
        
        // === Î¨∏ÏÑú Ï†ÄÏû• Î∞è ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ===
        
        function saveDocument() {
            try {
                if (!quillEditor) {
                    throw new Error('Ìé∏ÏßëÍ∏∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }
                
                const content = quillEditor.root.innerHTML;
                const timestamp = new Date().toISOString();
                
                // ÏÑ±Îä• ÏµúÏ†ÅÌôî: Íµ¨Ï°∞ÌôîÎêú Îç∞Ïù¥ÌÑ∞Î°ú Ï†ÄÏû•
                const saveData = {
                    content: content,
                    timestamp: timestamp,
                    wordCount: getWordCount(content),
                    version: '2.0',
                    metadata: {
                        lastModified: timestamp,
                        fileSize: new Blob([content]).size
                    }
                };
                
                localStorage.setItem('paperwork_document', JSON.stringify(saveData));
                
                // ÏûêÎèô Î∞±ÏóÖ (ÏµúÎåÄ 3Í∞ú Î≥¥Í¥Ä)
                createAutoBackup(saveData);
                
                document.getElementById('lastSaved').textContent = `Ï†ÄÏû•: ${new Date().toLocaleTimeString()}`;
                showNotification('Î¨∏ÏÑúÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
                
                // ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ
                logPerformanceMetrics();
                
            } catch (error) {
                console.error('Ï†ÄÏû• Ïò§Î•ò:', error);
                showNotification('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        function createAutoBackup(saveData) {
            try {
                const backups = JSON.parse(localStorage.getItem('paperwork_backups') || '[]');
                backups.unshift(saveData);
                
                // ÏµúÎåÄ 3Í∞ú Î∞±ÏóÖ Ïú†ÏßÄ
                if (backups.length > 3) {
                    backups.splice(3);
                }
                
                localStorage.setItem('paperwork_backups', JSON.stringify(backups));
            } catch (error) {
                console.warn('Î∞±ÏóÖ ÏÉùÏÑ± Ïã§Ìå®:', error);
            }
        }

        function getWordCount(content) {
            const text = content.replace(/<[^>]*>/g, '').trim();
            return text ? text.split(/\s+/).length : 0;
        }

        function logPerformanceMetrics() {
            if (performance && performance.memory) {
                const memory = performance.memory;
                console.log('üîç ÏÑ±Îä• Î©îÌä∏Î¶≠:', {
                    usedJSHeapSize: Math.round(memory.usedJSHeapSize / 1024 / 1024) + 'MB',
                    totalJSHeapSize: Math.round(memory.totalJSHeapSize / 1024 / 1024) + 'MB',
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        function exportDocument() {
            const content = quillEditor.getText();
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `document_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Î¨∏ÏÑúÍ∞Ä ÎÇ¥Î≥¥ÎÇ¥Í∏∞ÎêòÏóàÏäµÎãàÎã§.', 'success');
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï†ÄÏû•Îêú Î¨∏ÏÑú Î≥µÏõê
        document.addEventListener('DOMContentLoaded', function() {
            const savedContent = localStorage.getItem('paperwork_document');
            if (savedContent) {
                setTimeout(() => {
                    quillEditor.root.innerHTML = savedContent;
                    updateWordCount();
                }, 500);
            }
        });
        
        console.log('‚úÖ AI Î¨∏ÏÑú Ìé∏ÏßëÍ∏∞ JavaScript Î°úÎìú ÏôÑÎ£å');
        
        // Mobile Sidebar Toggle
        document.getElementById("mobileSidebarToggle")?.addEventListener("click", function() {
            const sidebar = document.getElementById("mobileSidebar");
            const toggleIcon = document.getElementById("toggleIcon");
            
            if (sidebar.classList.contains("hidden")) {
                sidebar.classList.remove("hidden");
                sidebar.classList.add("block");
                toggleIcon.style.transform = "rotate(180deg)";
            } else {
                sidebar.classList.add("hidden");
                sidebar.classList.remove("block");
                toggleIcon.style.transform = "rotate(0deg)";
            }
        });

        // === AI Auto-fill ÏûêÎèô Ï±ÑÏö∞Í∏∞ ÏãúÏä§ÌÖú ===

        /**
         * Îπà ÌïÑÎìú Í∞êÏßÄ Î∞è ÏûêÎèô Ï±ÑÏö∞Í∏∞ ÏãúÏûë
         */
        function detectAndFillBlankFields() {
            const content = quillEditor.getText();
            
            if (!content.trim()) {
                notify.warning('Ìé∏ÏßëÍ∏∞Ïóê ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Î¨∏ÏÑúÎ•º Ï∂îÏ∂úÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const blankFields = analyzeBlankFields(content);
            
            if (blankFields.length === 0) {
                notify.info('Í∞êÏßÄÎêú Îπà ÌïÑÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§. Î¨∏ÏÑúÍ∞Ä Ïù¥ÎØ∏ ÏôÑÏÑ±Îêú Í≤É Í∞ôÏäµÎãàÎã§! ‚úÖ');
                return;
            }

            showAutoFillModal(blankFields);
        }

        /**
         * Îπà ÌïÑÎìú Î∂ÑÏÑù
         * @param {string} content - Î∂ÑÏÑùÌï† ÌÖçÏä§Ìä∏ ÎÇ¥Ïö©
         * @returns {Array} Îπà ÌïÑÎìú Î∞∞Ïó¥
         */
        function analyzeBlankFields(content) {
            const blankPatterns = [
                /\[.*?\]/g,                    // [ÎπàÏπ∏] ÌòïÌÉú
                /____+/g,                      // Ïó∞ÏÜçÎêú Î∞ëÏ§Ñ
                /_+_+_+/g,                     // ÏµúÏÜå 3Í∞ú Ïù¥ÏÉÅÏùò Ïñ∏ÎçîÏä§ÏΩîÏñ¥
                /\.\.\./g,                     // ... (ÏÉùÎûµ ÌëúÏãú)
                /\([\s]*\)/g,                  // Îπà Í¥ÑÌò∏ ()
                /Ôºö[\s]*$/gm,                   // ÏΩúÎ°† Îí§ Îπà Ï§Ñ
                /:\s*$/gm,                     // ÏòÅÎ¨∏ ÏΩúÎ°† Îí§ Îπà Ï§Ñ
                /^\s*-\s*$/gm,                 // Îπà Î∂àÎ¶ø Ìè¨Ïù∏Ìä∏
                /TBD|TBC|TODO/gi,              // To Be Determined/Completed/TODO
                /ÎØ∏Ï†ï|Ï∂îÌõÑ|ÎÇòÏ§ëÏóê|Î≥¥ÏôÑÌïÑÏöî/g           // ÌïúÍµ≠Ïñ¥ ÎØ∏ÏôÑÏÑ± ÌëúÏãú
            ];

            const fields = [];
            blankPatterns.forEach((pattern, index) => {
                const matches = content.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        fields.push({
                            pattern: match,
                            type: getFieldType(index),
                            position: content.indexOf(match)
                        });
                    });
                }
            });

            // Ï§ëÎ≥µ Ï†úÍ±∞ Î∞è Ï†ïÎ†¨
            return fields
                .filter((field, index, self) => 
                    self.findIndex(f => f.position === field.position) === index
                )
                .sort((a, b) => a.position - b.position);
        }

        /**
         * ÌïÑÎìú Ïú†Ìòï Î∞òÌôò
         */
        function getFieldType(patternIndex) {
            const types = [
                'Î∏åÎûòÌÇ∑ ÎπàÏπ∏', 'Î∞ëÏ§Ñ ÎπàÏπ∏', 'Ïñ∏ÎçîÏä§ÏΩîÏñ¥ ÎπàÏπ∏', 'ÏÉùÎûµ ÌëúÏãú', 
                'Îπà Í¥ÑÌò∏', 'ÏΩúÎ°† ÎπàÏπ∏', 'ÏòÅÎ¨∏ ÏΩúÎ°† ÎπàÏπ∏', 'Îπà Î∂àÎ¶ø', 
                'ÏòÅÎ¨∏ ÎØ∏ÏôÑÏÑ±', 'ÌïúÍµ≠Ïñ¥ ÎØ∏ÏôÑÏÑ±'
            ];
            return types[patternIndex] || 'Í∏∞ÌÉÄ';
        }

        /**
         * AI Auto-fill Î™®Îã¨ ÌëúÏãú
         */
        function showAutoFillModal(blankFields) {
            const modal = document.getElementById('aiAutoFillModal');
            const blankFieldsCount = document.getElementById('blankFieldsCount');
            const referenceStatus = document.getElementById('referenceStatus');
            
            // Îπà ÌïÑÎìú Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
            blankFieldsCount.textContent = `${blankFields.length}Í∞ú`;
            
            // Ï∞∏Í≥†ÏûêÎ£å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            if (referenceDocuments.length > 0) {
                referenceStatus.textContent = `${referenceDocuments.length}Í∞ú ÌååÏùº`;
                referenceStatus.className = 'text-green-400 font-medium';
            } else {
                referenceStatus.textContent = 'ÏóÜÏùå';
                referenceStatus.className = 'text-yellow-300 font-medium';
            }
            
            // Îπà ÌïÑÎìú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (Ï†ÑÏó≠ Î≥ÄÏàò)
            window.currentBlankFields = blankFields;
            
            // Î™®Îã¨ ÌëúÏãú
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        /**
         * Auto-fill Î™®Îã¨ Ï∑®ÏÜå
         */
        function cancelAutoFill() {
            const modal = document.getElementById('aiAutoFillModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            window.currentBlankFields = null;
        }

        /**
         * ÌëúÏ§Ä Î™®Îìú ÏûêÎèô Ï±ÑÏö∞Í∏∞ ÏãúÏûë
         */
        function startAutoFillStandard() {
            cancelAutoFill();
            performAutoFill('standard');
        }

        /**
         * Think Harder Î™®Îìú ÏûêÎèô Ï±ÑÏö∞Í∏∞ ÏãúÏûë  
         */
        function startAutoFillDeep() {
            cancelAutoFill();
            performAutoFill('deep');
        }

        /**
         * Ïã§Ï†ú AI ÏûêÎèô Ï±ÑÏö∞Í∏∞ ÏàòÌñâ
         */
        // === AI Ï≤®Î∂ÄÌååÏùº ÏùΩÍ∏∞ Ìó¨Ìçº Ìï®ÏàòÎì§ ===
        
        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                
                if (file.type.startsWith('text/')) {
                    reader.readAsText(file);
                } else if (file.type.includes('pdf')) {
                    // PDF ÌååÏùºÏùÄ Î∞îÏù¥ÎÑàÎ¶¨Î°ú ÏùΩÏñ¥ÏÑú Î≥ÑÎèÑ Ï≤òÎ¶¨
                    reader.readAsArrayBuffer(file);
                } else if (file.type.startsWith('image/')) {
                    // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÄ Îç∞Ïù¥ÌÑ∞ URLÎ°ú ÏùΩÍ∏∞
                    reader.readAsDataURL(file);
                } else {
                    // Í∏∞ÌÉÄ ÌååÏùºÏùÄ ÌÖçÏä§Ìä∏Î°ú ÏãúÎèÑ
                    reader.readAsText(file);
                }
            });
        }
        
        async function extractTextFromFile(file, content) {
            try {
                if (file.type.startsWith('text/')) {
                    return content;
                } else if (file.type.includes('pdf')) {
                    // PDFÎäî ÏÑúÎ≤ÑÏóêÏÑú Ï≤òÎ¶¨ÌïòÎèÑÎ°ù ÌååÏùº ÏûêÏ≤¥Î•º Ï†ÑÏÜ°
                    return '[PDF ÌååÏùº - ÏÑúÎ≤ÑÏóêÏÑú ÌÖçÏä§Ìä∏ Ï∂îÏ∂ú ÏòàÏ†ï]';
                } else if (file.type.startsWith('image/')) {
                    // Ïù¥ÎØ∏ÏßÄÎäî ÏÑúÎ≤ÑÏóêÏÑú OCR Ï≤òÎ¶¨ÌïòÎèÑÎ°ù Îç∞Ïù¥ÌÑ∞ URL Ï†ÑÏÜ°
                    return content; // Îç∞Ïù¥ÌÑ∞ URLÏùÑ Í∑∏ÎåÄÎ°ú Ï†ÑÏÜ°
                } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    return '[Word Î¨∏ÏÑú - ÏÑúÎ≤ÑÏóêÏÑú ÌÖçÏä§Ìä∏ Ï∂îÏ∂ú ÏòàÏ†ï]';
                } else {
                    // Í∏∞ÌÉÄ ÌÖçÏä§Ìä∏ ÌòïÌÉúÎ°ú Ï≤òÎ¶¨ Í∞ÄÎä•Ìïú ÌååÏùº
                    return content;
                }
            } catch (error) {
                console.warn('ÌååÏùº ÌÖçÏä§Ìä∏ Ï∂îÏ∂ú Ïã§Ìå®:', file.name, error);
                return '[ÌÖçÏä§Ìä∏ Ï∂îÏ∂ú Ïã§Ìå®]';
            }
        }
        
        async function processReferenceFiles(files) {
            const processedFiles = [];
            
            uploadProgress.show('Ï∞∏Í≥†ÏûêÎ£å ÌååÏùº Ï≤òÎ¶¨ Ï§ë...', `${files.length}Í∞ú ÌååÏùº Î∂ÑÏÑù`);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    uploadProgress.show(
                        'Ï∞∏Í≥†ÏûêÎ£å ÌååÏùº Ï≤òÎ¶¨ Ï§ë...', 
                        `${i + 1}/${files.length}: ${file.name}`
                    );
                    
                    const content = await readFileContent(file);
                    const extractedText = await extractTextFromFile(file, content);
                    
                    processedFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        content: extractedText,
                        preview: extractedText.length > 500 ? 
                                extractedText.substring(0, 500) + '...' : 
                                extractedText
                    });
                    
                } catch (error) {
                    console.error('ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò:', file.name, error);
                    processedFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        content: '[ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®]',
                        preview: '[ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®]'
                    });
                }
            }
            
            return processedFiles;
        }

        // performAutoFill Ìï®ÏàòÎäî ai-functions.js Î™®ÎìàÎ°ú Ïù¥ÎèôÎê®
        
        // === üîß Í∞úÏÑ†Îêú Í∏∞Îä•Îì§ ===
        
        // ‚å®Ô∏è ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ ÏãúÏä§ÌÖú
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+S: Ï†ÄÏû•
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveDocument();
                    return;
                }
                
                // Ctrl+Shift+E: AI Ìé∏Ïßë ÎèÑÍµ¨ Ïó¥Í∏∞
                if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                    e.preventDefault();
                    document.querySelector('button[onclick="aiEnhance(\'enhance\')"]')?.click();
                    return;
                }
                
                // Ctrl+Shift+H: ÎèÑÏõÄÎßê
                if (e.ctrlKey && e.shiftKey && e.key === 'H') {
                    e.preventDefault();
                    showKeyboardHelp();
                    return;
                }
                
                // ESC: Ìè¨Ïª§Ïä§ Í¥ÄÎ¶¨
                if (e.key === 'Escape') {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.blur) {
                        activeElement.blur();
                        if (quillEditor) {
                            quillEditor.focus();
                        }
                    }
                }
            });
        }

        function showKeyboardHelp() {
            const helpContent = `
                <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" id="keyboard-help-modal">
                    <div class="bg-white rounded-xl max-w-md p-6 m-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">‚å®Ô∏è ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+S</kbd></span>
                                <span>Î¨∏ÏÑú Ï†ÄÏû•</span>
                            </div>
                            <div class="flex justify-between">
                                <span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+Shift+E</kbd></span>
                                <span>AI Ìé∏Ïßë ÎèÑÍµ¨</span>
                            </div>
                            <div class="flex justify-between">
                                <span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+Shift+H</kbd></span>
                                <span>ÎèÑÏõÄÎßê Î≥¥Í∏∞</span>
                            </div>
                            <div class="flex justify-between">
                                <span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">ESC</kbd></span>
                                <span>Ìé∏ÏßëÍ∏∞Î°ú Ìè¨Ïª§Ïä§</span>
                            </div>
                        </div>
                        <button onclick="closeKeyboardHelp()" class="mt-4 w-full px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors">
                            Îã´Í∏∞
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', helpContent);
            document.getElementById('keyboard-help-modal').querySelector('button').focus();
        }

        function closeKeyboardHelp() {
            const modal = document.getElementById('keyboard-help-modal');
            if (modal) {
                modal.remove();
            }
        }

        // üîç Ï†ëÍ∑ºÏÑ± Í∞úÏÑ†
        function enhanceAccessibility() {
            // ARIA ÎùºÎ≤® Ï∂îÍ∞Ä
            const editorContainer = document.querySelector('.ql-editor');
            if (editorContainer) {
                editorContainer.setAttribute('role', 'textbox');
                editorContainer.setAttribute('aria-label', 'Î¨∏ÏÑú Ìé∏Ïßë ÏòÅÏó≠');
                editorContainer.setAttribute('aria-multiline', 'true');
            }
            
            // ÏóÖÎ°úÎìú ÏòÅÏó≠ Ï†ëÍ∑ºÏÑ±
            const uploadArea = document.getElementById('upload-area');
            if (uploadArea) {
                uploadArea.setAttribute('role', 'button');
                uploadArea.setAttribute('aria-label', 'ÌååÏùº ÏóÖÎ°úÎìú ÏòÅÏó≠');
                uploadArea.setAttribute('tabindex', '0');
            }
            
            // ÏÉÅÌÉú ÌëúÏãú ÏòÅÏó≠
            const statusElements = ['wordCount', 'charCount', 'lastSaved', 'aiStatus'];
            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.setAttribute('role', 'status');
                    element.setAttribute('aria-live', 'polite');
                }
            });
        }

        // üöÄ Ï¥àÍ∏∞Ìôî Î∞è Ï†ïÎ¶¨
        function initializeEnhancedFeatures() {
            setupKeyboardShortcuts();
            enhanceAccessibility();
            
            // ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë
            console.log('üìà Enhanced Paperwork Editor Ï¥àÍ∏∞Ìôî ÏôÑÎ£å - v2.0');
            if (window.logPerformanceMetrics) {
                logPerformanceMetrics();
            }
        }

        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
        window.addEventListener('beforeunload', () => {
            // Î©îÎ™®Î¶¨ Ï†ïÎ¶¨
            if (quillEditor) {
                // Quill Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ïÎ¶¨Îäî Quill ÏûêÏ≤¥ÏóêÏÑú Ï≤òÎ¶¨
                console.log('üìã Ìé∏ÏßëÍ∏∞ Ï†ïÎ¶¨ ÏôÑÎ£å');
            }
        });

        // DOMContentLoaded Ïù¥Î≤§Ìä∏Ïóê ÏÉàÎ°úÏö¥ Í∏∞Îä•Îì§ Ï∂îÍ∞Ä
        document.addEventListener('DOMContentLoaded', () => {
            // Í∏∞Ï°¥ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÌõÑ Í∞úÏÑ†Îêú Í∏∞Îä•Îì§ Ï¥àÍ∏∞Ìôî
            setTimeout(initializeEnhancedFeatures, 100);
        });
        
    </script>
</body>
</html>
