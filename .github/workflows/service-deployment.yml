name: Service Deployment Orchestration

on:
  workflow_run:
    workflows: ["Frontend Build and Deploy", "Backend Services Build and Test"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      service_group:
        description: 'Service group to deploy'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - frontend-only
        - backend-only
        - saju-service
        - crawling-service
        - dashboard-service

jobs:
  prepare-deployment:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    outputs:
      deploy_frontend: ${{ steps.check.outputs.deploy_frontend }}
      deploy_backend: ${{ steps.check.outputs.deploy_backend }}
      deploy_services: ${{ steps.check.outputs.deploy_services }}
    steps:
    - name: Check deployment targets
      id: check
      run: |
        SERVICE_GROUP="${{ github.event.inputs.service_group || 'all' }}"
        echo "Service group: $SERVICE_GROUP"
        
        case $SERVICE_GROUP in
          "all")
            echo "deploy_frontend=true" >> $GITHUB_OUTPUT
            echo "deploy_backend=true" >> $GITHUB_OUTPUT
            echo "deploy_services=saju,crawling,paperwork,ai-monitoring,dashboard" >> $GITHUB_OUTPUT
            ;;
          "frontend-only")
            echo "deploy_frontend=true" >> $GITHUB_OUTPUT
            echo "deploy_backend=false" >> $GITHUB_OUTPUT
            echo "deploy_services=" >> $GITHUB_OUTPUT
            ;;
          "backend-only")
            echo "deploy_frontend=false" >> $GITHUB_OUTPUT
            echo "deploy_backend=true" >> $GITHUB_OUTPUT
            echo "deploy_services=saju,crawling,paperwork,ai-monitoring,dashboard" >> $GITHUB_OUTPUT
            ;;
          "saju-service")
            echo "deploy_frontend=false" >> $GITHUB_OUTPUT
            echo "deploy_backend=true" >> $GITHUB_OUTPUT
            echo "deploy_services=saju" >> $GITHUB_OUTPUT
            ;;
          "crawling-service")
            echo "deploy_frontend=false" >> $GITHUB_OUTPUT
            echo "deploy_backend=true" >> $GITHUB_OUTPUT
            echo "deploy_services=crawling" >> $GITHUB_OUTPUT
            ;;
          "dashboard-service")
            echo "deploy_frontend=false" >> $GITHUB_OUTPUT
            echo "deploy_backend=true" >> $GITHUB_OUTPUT
            echo "deploy_services=dashboard" >> $GITHUB_OUTPUT
            ;;
        esac

  deploy-frontend:
    needs: prepare-deployment
    runs-on: ubuntu-latest
    if: needs.prepare-deployment.outputs.deploy_frontend == 'true'
    steps:
    - uses: actions/checkout@v4
    
    - name: Download frontend artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: ./frontend-build/
    
    - name: Deploy frontend to production
      run: |
        echo "ğŸ¨ Frontend Production Deployment"
        echo "================================"
        echo "ğŸ“¦ Artifact downloaded: frontend-dist"
        echo "ğŸŒ Target: /var/www/saju.heal7.com"
        echo "ğŸ“ Files to deploy:"
        ls -la ./frontend-build/ || echo "No build files found"
        
        # ì‹¤ì œ ë°°í¬ ì‹¤í–‰
        if [ -d "./frontend-build" ]; then
          echo "ğŸ”„ Backing up current deployment..."
          sudo cp -r /var/www/saju.heal7.com /backup/saju-$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
          
          echo "ğŸ“‚ Deploying new files..."
          sudo rm -rf /var/www/saju.heal7.com/*
          sudo cp -r ./frontend-build/* /var/www/saju.heal7.com/
          sudo chown -R www-data:www-data /var/www/saju.heal7.com
          sudo chmod -R 755 /var/www/saju.heal7.com
          
          echo "â™»ï¸ Reloading nginx..."
          sudo systemctl reload nginx
          
          echo "âœ… Frontend deployment completed successfully!"
        else
          echo "âŒ No build files found - deployment failed"
          exit 1
        fi

  deploy-backend-services:
    needs: prepare-deployment
    runs-on: ubuntu-latest
    if: needs.prepare-deployment.outputs.deploy_backend == 'true'
    strategy:
      matrix:
        service: [saju, crawling, paperwork, ai-monitoring, dashboard]
      fail-fast: false
    steps:
    - uses: actions/checkout@v4
    
    - name: Download service artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.service }}-service-build
        path: ./service-builds/${{ matrix.service }}/
      continue-on-error: true
    
    - name: Deploy service simulation
      run: |
        SERVICE_NAME="${{ matrix.service }}"
        
        case $SERVICE_NAME in
          "paperwork")
            PORT=8001
            DESC="ì„œë¥˜ ì²˜ë¦¬ ë° AI ë¶„ì„"
            ;;
          "saju")
            PORT=8002
            DESC="ì‚¬ì£¼ëª…ë¦¬ ê³„ì‚° ë° í•´ì„"
            ;;
          "crawling") 
            PORT=8003
            DESC="ë°ì´í„° ìˆ˜ì§‘ ë° í¬ë¡¤ë§"
            ;;
          "ai-monitoring")
            PORT=8004
            DESC="AI ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§"
            ;;
          "dashboard")
            PORT=8005
            DESC="ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ í—ˆë¸Œ â­"
            ;;
        esac
        
        echo "ğŸ¼ $SERVICE_NAME Service Deployment"
        echo "=================================="
        echo "ğŸ“¦ Service: $SERVICE_NAME"
        echo "ğŸŒ Port: $PORT"
        echo "ğŸ“‹ Description: $DESC"
        echo "ğŸ“ Build artifacts:"
        ls -la ./service-builds/$SERVICE_NAME/ 2>/dev/null || echo "No build artifacts found for $SERVICE_NAME"
        echo ""
        echo "ğŸš€ $SERVICE_NAME service deployment simulation completed!"

  deployment-summary:
    needs: [prepare-deployment, deploy-frontend, deploy-backend-services]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Deployment summary
      run: |
        echo "ğŸ¼ HEAL7 Services Deployment Summary"
        echo "===================================="
        echo ""
        echo "ğŸ“Š Deployment Status:"
        echo "- Frontend (í¬íŠ¸ 4173): ${{ needs.deploy-frontend.result || 'skipped' }}"
        echo "- Backend Services: ${{ needs.deploy-backend-services.result || 'skipped' }}"
        echo ""
        echo "ğŸŒ Service Architecture:"
        echo "- ğŸ¨ Frontend: saju.heal7.com (Vite Preview)"
        echo "- ğŸ“„ Paperwork Service: localhost:8001"
        echo "- ğŸ”® Saju Service: localhost:8002"  
        echo "- ğŸ•·ï¸ Crawling Service: localhost:8003"
        echo "- ğŸ§ª AI Monitoring: localhost:8004"
        echo "- ğŸ¼ Dashboard Hub: localhost:8005 â­"
        echo ""
        echo "âœ… GitHub Actions ê¸°ë°˜ ë¬´ì„œë²„ ë¹Œë“œ/ë°°í¬ ì™„ë£Œ!"
        echo "ğŸš€ ë¡œì»¬ ì„œë²„ ë¶€ë‹´ ì œê±° ì„±ê³µ"